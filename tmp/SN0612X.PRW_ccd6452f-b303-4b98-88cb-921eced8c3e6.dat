#INCLUDE 'PROTHEUS.CH'
#INCLUDE "TOTVS.CH"
#INCLUDE "TOPCONN.CH"
#INCLUDE "RWMAKE.CH"
#INCLUDE 'FONT.CH'
#INCLUDE 'COLORS.CH'
#INCLUDE "PARMTYPE.CH"  
#INCLUDE "FWMVCDEF.CH"
#INCLUDE "FWCOMMAND.CH"
/*
+--------------------------------------------------------------------------+
|{Protheus.doc}<SN0612X>                                                   |
|Rotina responsavel pela liberacao das matriculas.						   |
|                                                                          |
|@Author<Diogo C. Barros>                                                  |
|@since<27/03/2014>                                                        |
|@version<Nil>                                                             |
|                                                                          |
|@parameters<Nil>                                                          |
|@return<Nil>                                                              |
+--------------------------------------------------------------------------+
|Uso        |SENAI										     			   |
+-----------+--------------------------------------------------------------+
*/
User Function SN0612X()
Private _oBrowse 		:= FWMarkBrowse():New()
Private _cMarca			:= _oBrowse:Mark()
Private _aRotina		:= MenuDef()
Private _cAlias01		:= GetNextAlias()
DbSelectArea("ZP3")
ZP3->(DbSetOrder(1))
ZP3->(DbGoTop())
//--  Define a tabela
_oBrowse:SetAlias('ZP3')
//--  Descricao
_oBrowse:SetDescription('Liberacao para Remessa')
//--  Campo que sera marcado
_oBrowse:SetFieldMark('ZP3_OK')
//--  Legenda
_oBrowse:AddLegend("ZP3_XSTATU='P'"	,"BLUE" 	,"Em Preparacao")
_oBrowse:AddLegend("ZP3_XSTATU='L'"	,"GREEN"	,"Liberado" 	)
_oBrowse:AddLegend("ZP3_XSTATU='E'"	,"BLACK"	,"Enviado" 		)
_oBrowse:AddLegend("ZP3_XSTATU='R'"	,"RED"		,"Rejeitado" 	)
_oBrowse:AddLegend("ZP3_XSTATU='C'"	,"BROWN"	,"Conveniado" 	)
//--  Definicao do filtro
_oBrowse:SetFilterDefault("ZP3_FILIAL == '"+FwxFilial("ZP3")+"' .and. ZP3_XSTATU=='P'.and. Alltrim(ZP3_XNRREF) != '' " )
//_oBrowse:DisableDetails()
_oBrowse:Activate()
Return(Nil)


/*
+--------------------------------------------------------------------------+
|{Protheus.doc}<SN0612X>                                                   |
|Responsavel pela criacao dos botoes, alterar, incluir, excluir e demais.  |
|                                                                          |
|@Author<Diogo C. Barros>                                                  |
|@since<27/03/2014>                                                        |
|@version<Nil>                                                             |
|                                                                          |
|@parameters<Nil>                                                          |
|@return<Nil>                                                              |
+--------------------------------------------------------------------------+
|Uso        |SENAI										     			   |
+-----------+--------------------------------------------------------------+
*/
Static Function MenuDef()
Local _aRotina := {}
ADD OPTION _aRotina TITLE "Pesquisar"	ACTION "PESQBRW"         		OPERATION 1 ACCESS 0
ADD OPTION _aRotina TITLE 'Libera'		ACTION 'U_fLibera(_oBrowse)'	OPERATION 2 ACCESS 0
Return _aRotina

/*
+--------------------------------------------------------------------------+
|{Protheus.doc}<ModelDef>                                                  |
|Contem  a  construcao e a definicao do Model, lembrando que o Modelo de   |
|dados (Model) contem as regras de negocio.							   	   |
|                                                                          |
|@Author<Diogo C. Barros>                                                  |
|@since<27/03/2014>                                                        |
|@version<Nil>                                                             |
|                                                                          |
|@parameters<Nil>                                                          |
|@return<_oModel>                                                          |
+--------------------------------------------------------------------------+
|Uso        |SENAI    													   |
+-----------+--------------------------------------------------------------+
*/
Static Function ModelDef()
Return FwLoadModel("ZP3DETAIL")

/*
+--------------------------------------------------------------------------+
|{Protheus.doc}<ViewDef>                                                   |
|Contem a construcao e a definicao da View, ou seja, contrucao da interface|
|                                                                          |
|@Author<Diogo C. Barros>                                                  |
|@since<27/03/2014>                                                        |
|@version<Nil>                                                             |
|                                                                          |
|@parameters<Nil>                                                          |
|@return<_oModel>                                                          |
+--------------------------------------------------------------------------+
|Uso        |SENAI										     			   |
+-----------+--------------------------------------------------------------+
*/
Static Function ViewDef()
Return FwLoadView("ZP3DETAIL")

/*
+--------------------------------------------------------------------------+
|{Protheus.doc}<SN0612X>                                                   |
|Rotina responsavel pela liberacao das matriculas.						   |
|                                                                          |
|@Author<Diogo C. Barros>                                                  |
|@since<27/03/2014>                                                        |
|@version<Nil>                                                             |
|                                                                          |
|@parameters<Nil>                                                          |
|@return<Nil>                                                              |
+--------------------------------------------------------------------------+
|Uso        |SENAI										     			   |
+-----------+--------------------------------------------------------------+
*/
User Function fLibera()
Local _aArea	:= GetArea() 
Local _cMarca   := oMark:Mark()
Local _nCtaA 	:= 0 
ZP3->(dbGoTop()) 
Do While ZP3->(!eof()) 
  If oMark:IsMark(_cMarca)
    _nCtaA++ 
	//-- Libera o registro
	ZP3->(RecLock("ZP3",.F.))
	Replace ZP3->ZP3_XSTATU	With "L"
	Replace ZP3->ZP3_OK		With ""
	ZP3->(msUnlock())
	ZP3->(dbCommit())           
  Endif
  ZP3->(dbSkip()) 
Enddo
Aviso(FunName()+"/"+ProcName(),"Foram Liberados "+AllTrim(Str(_nCtaA))+" Pr√© Cadastros.",{"OK"})
RestArea(_aArea)
Return(Nil)


