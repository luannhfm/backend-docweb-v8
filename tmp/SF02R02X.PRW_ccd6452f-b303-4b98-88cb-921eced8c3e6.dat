#Include 'Protheus.ch'
#Include 'tbiconn.ch'

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ SF02R02X ³ Autor ³ Paulo César P. Schwind ³ Data ³ 15.07.19 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Listagem de Pedidos de Compras por Situação                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³                                                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Alterações³                                                             ³±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

User Function SF02R02X()
	Private oReport     := nil
	Private cPerg     := Padr("SF02R02X",10)
    Private cTitRel   := "Itens de Nota Fiscal por Categoria"
    Private cCodCat   := '   '
    Private cNumNF    := Space(10)

	ValidPerg()
	Pergunte(cPerg,.T.)
	if LastKey()=27
		Return
	Endif

	oReport := RptDef(cPerg)
	oReport:PrintDialog()
	
Return

Static Function RptDef(cNome)
	Local oReport  := Nil
	Local oSection1:= Nil
	Local oSection2:= Nil
	
	Local oBreak
	Local oFunction
	
	oReport := TReport():New(cNome,cTitRel,cNome,{|oReport| ReportPrint(oReport)},cTitRel,,)
	oReport:SetLandscape()

	oSection1:= TRSection():New(oReport, "Categoria", {"SD1"}, NIL, .F., .T.)
    oReport:cFontBody := 'Arial'
    oReport:nFontBody := 10
    oReport:lBold     := .T.	
    	
	TRCell():New(oSection1,"D1_XCLSSC"  ,"TRBSD1","Categoria","@!",50)
	TRCell():New(oSection1,"D1_XCLPLC"  ,"TRBSD1","Placa"    ,"@!",50)

    oReport:cFontBody := 'Arial'
    oReport:nFontBody := 6
    oReport:lBold     := .F.		

	oSection2:= TRSection():New(oReport, "Nota Fiscal", {"SD1"}, NIL, .F., .T.,,,,,,,,,0,.T.)

	TRCell():New(oSection2,"D1_FILIAL" ,"TRBSD1","FILIAL"        ,"@!",025)
	TRCell():New(oSection2,"D1_DOC"    ,"TRBSD1","Doc"        ,"@!",040)
	TRCell():New(oSection2,"D1_COD"    ,"TRBSD1","Cod Produto","@!",080)
	TRCell():New(oSection2,"D1_PR_DESC","TRBSD1","Produto"    ,"@!",080)
	TRCell():New(oSection2,"D1_QUANT"  ,"TRBSD1","Quant"      ,"@E 9999999.99"  ,045)
	TRCell():New(oSection2,"D1_VUNIT"  ,"TRBSD1","Unitário"   ,"@E 9,999,999.99",055)
	TRCell():New(oSection2,"D1_TOTAL"  ,"TRBSD1","Total"      ,"@E 9,999,999.99",055)
	TRCell():New(oSection2,"D1_FORNECE","TRBSD1","Fornecedor" ,"@!",035)
	TRCell():New(oSection2,"D1_LOJA"   ,"TRBSD1","Loja"       ,"@!",150)
	TRCell():New(oSection2,"D1_GRUPO"  ,"TRBSD1","Grupo"      ,"@!",100)
	TRCell():New(oSection2,"D1_EMISSAO","TRBSD1","Emissão"    ,"@!",15)
	TRCell():New(oSection2,"F1_SERIE"  ,"TRBSD1","SC"         ,"@!",35)
	TRCell():New(oSection2,"D1_PEDIDO" ,"TRBSD1","Pedido"     ,"@!",35)
	TRCell():New(oSection2,"D1_XCLSSC"  ,"TRBSD1","Categ"      ,"@!",35)
	TRCell():New(oSection2,"D1_XCLPLC"  ,"TRBSD1","Placa"      ,"@!",45)
	
	TRFunction():New(oSection2:Cell("D1_TOTAL"),"T_CAT" ,"SUM"  ,,"Total NF",,,.f.,.f.)
	TRFunction():New(oSection2:Cell("D1_QUANT"),"T_CAT" ,"COUNT",,"Itens NF",,,.f.,.f.)

	_oBrkCat := TRBreak():New(oSection2, {|| cEmpAnt+cCodCat+cNumNF}, "CATEGORIA", .t., "_oBrkCat", .f.)
	_oBrkCat:SetTotalInLine(.t.)

    TRFunction():New(oSection2:Cell("D1_TOTAL"),NIL,"SUM")
    TRFunction():New(oSection2:Cell("D1_QUANT"),NIL,"COUNT")

	oReport:SetTotalInLine(.T.)
	oSection1:SetPageBreak(.F.)
	oSection1:SetTotalText(" ")
					
Return(oReport)


Static Function ReportPrint(oReport)
	Local oSection1 := oReport:Section(1),;
	      oSection2 := oReport:Section(2),;
	      cFilNF,; 
	      cNumNF,;
	      cSerNF,;
          cForNF,;
	      cLojNF,;
	      cDscCat:='',;
	      _nRegs:=0
	      	
	BEGINSQL ALIAS "TRBSD1"

	column 	D1_EMISSAO 	as Date

	  SELECT 
		SD1.D1_FILIAL,SD1.D1_XCLSSC, SD1.D1_DOC, SD1.D1_SERIE, SD1.D1_EMISSAO, SD1.D1_ITEM, SD1.D1_COD, SD1.D1_UM, 
		SD1.D1_QUANT, SD1.D1_VUNIT, SD1.D1_TOTAL, SD1.D1_TES, SD1.D1_CF, 
		SD1.D1_FORNECE, SD1.D1_LOJA, SD1.D1_GRUPO, SD1.D1_PEDIDO, SD1.D1_XCLPLC,
		SF1.F1_FILIAL, SF1.F1_DOC, SF1.F1_SERIE, SF1.F1_FORNECE, SF1.F1_LOJA, SF1.F1_PLACA 
	  FROM 
		%Table:SD1% SD1 INNER JOIN 
		%Table:SF1% SF1 ON SF1.%NotDel% AND SF1.F1_FILIAL = SD1.D1_FILIAL AND SF1.F1_DOC = SD1.D1_DOC AND SF1.F1_SERIE = SD1.D1_SERIE AND SD1.D1_FORNECE = SF1.F1_FORNECE AND SF1.F1_LOJA = SD1.D1_LOJA
	  WHERE 
	    SD1.%NotDel%
	    AND SD1.D1_FILIAL  >= %exp:MV_PAR01%
	    AND SD1.D1_FILIAL  <= %exp:MV_PAR02%
	    AND SD1.D1_EMISSAO >= %Exp:MV_PAR03%
	    AND SD1.D1_EMISSAO <= %Exp:MV_PAR04%
	    AND SD1.D1_XCLSSC  >= %exp:MV_PAR05%
	    AND SD1.D1_XCLSSC  <= %exp:MV_PAR06%
	    AND SD1.D1_FORNECE >= %exp:MV_PAR07%
	    AND SD1.D1_FORNECE <= %exp:MV_PAR08%
	    AND (' ' = %exp:MV_PAR09% OR ( ' ' != %exp:MV_PAR09% AND SD1.D1_XCLPLC = %exp:MV_PAR09%))
	    ORDER BY SD1.D1_FILIAL, SD1.D1_XCLSSC, SD1.D1_EMISSAO, SD1.D1_DOC, SD1.D1_ITEM;
        
    ENDSQL 
   
    TRBSD1->( dbEval({ || _nRegs++} ))
 
	oReport:SetMeter(TRBSD1->(_nRegs))
    TRBSD1->(dbGoTop())
    
	While ! TRBSD1->(EOF())

		If oReport:Cancel()
			Exit
		EndIf

		oSection1:Init()
		oReport:IncMeter()

		IncProc("Imprimindo")
		
		IF Empty(TRBSD1->D1_XCLSSC)
		   cDscCat := '[   ] - SEM CLASSIFICACAO'
		Else   
		   cDscCat := '['+TRBSD1->D1_XCLSSC+']'+" - "+POSICIONE("ZZ9",1,xFilial("ZZ9")+TRBSD1->D1_XCLSSC,"ZZ9_DESC")
        Endif
		IF Empty(TRBSD1->D1_XCLPLC)
		   cDscPla := 'SEM PLACA'
		Else   
		   cDscPla := TRBSD1->D1_XCLPLC
        Endif

		oSection1:Cell("D1_XCLPLC"):SetValue( cDscPla )
		oSection1:Cell("D1_XCLSSC"):SetValue( cDscCat )
		oSection1:Printline()

		cFilNF := TRBSD1->D1_FILIAL
		cNumNF := TRBSD1->D1_DOC
		cSerNF := TRBSD1->D1_SERIE
		cForNF := TRBSD1->D1_FORNECE
		cLojNF := TRBSD1->D1_LOJA		
        cCodCat:= TRBSD1->D1_XCLSSC 

        _nTQtCat :=0
	    _nTotCat :=0

		oSection2:init()
		oReport:ThinLine()
		
		While ! TRBSD1->(EOF())	.and. ; 
		    AllTrim(TRBSD1->D1_FILIAL) == AllTrim(cFilNF) .and.;
			AllTrim(TRBSD1->D1_XCLSSC) == AllTrim(cCodCat).and.;
			AllTrim(TRBSD1->D1_DOC) == AllTrim(cNumNF) 

			oReport:IncMeter()
			IncProc("Imprimindo. Aguarde...")

			oSection2:Cell("D1_FILIAL"):SetValue(TRBSD1->D1_FILIAL)
			oSection2:Cell("D1_DOC"):SetValue(TRBSD1->D1_DOC)
			oSection2:Cell("D1_COD"):SetValue(AllTrim(TRBSD1->D1_COD))
			oSection2:Cell("D1_PR_DESC"):SetValue(AllTrim(POSICIONE("SB1",1,xFilial("SB1")+TRBSD1->D1_COD,"B1_DESC")))
			oSection2:Cell("D1_QUANT"):SetValue(TRBSD1->D1_QUANT)
			oSection2:Cell("D1_VUNIT"):SetValue(TRBSD1->D1_VUNIT)
			oSection2:Cell("D1_TOTAL"):SetValue(TRBSD1->D1_TOTAL)
			oSection2:Cell("D1_FORNECE"):SetValue(TRBSD1->D1_FORNECE)
			oSection2:Cell("D1_LOJA"):SetValue(TRBSD1->D1_LOJA+" - "  +POSICIONE("SA2",1,xFilial("SA2")+TRBSD1->D1_FORNECE+TRBSD1->D1_LOJA,"A2_NOME"))
			oSection2:Cell("D1_GRUPO"):SetValue(TRBSD1->D1_GRUPO+" - "+POSICIONE("SBM",1,xFilial("SBM")+TRBSD1->D1_GRUPO,"BM_DESC"))
			oSection2:Cell("D1_EMISSAO"):SetValue(TRBSD1->D1_EMISSAO)
			oSection2:Cell("F1_SERIE"):SetValue(POSICIONE("SC7",1,xFilial("SC7")+TRBSD1->D1_PEDIDO,"C7_NUMSC")) //+TRBSD1->D1_ITEM
			oSection2:Cell("D1_PEDIDO"):SetValue(TRBSD1->D1_PEDIDO)
			oSection2:Cell("D1_XCLSSC"):SetValue(TRBSD1->D1_XCLSSC)
			oSection2:Cell("D1_XCLPLC"):SetValue(TRBSD1->D1_XCLPLC)
			
			oSection2:Printline()
			TRBSD1->(dbSkip())
		End
	
		oSection1:Finish()
		oSection2:Finish()
		oReport:FatLine()
	
	End
	TRBSD1->(dbCloseArea())
	
Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ValidPerg ºAutor  ³Paulo Schwind       º Data ³  15/07/2019 º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³                                                            º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ AP                                                        º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function ValidPerg()
	Local _aArea := GetArea()
	Local _cPerg := cPerg
	Local _aRegs:={}
	Local _nI := 0
	Local _nJ := 0

	dbSelectArea('SX1')
	dbSetOrder(1)

	Aadd(_aRegs,{_cPerg,"01","Filial De                     ","                              ","                              ","mv_ch1","C",08,0,0,"G","                                                            ","mv_par01       ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","          ","                                                            ","SM0","S","   ","          "})
	Aadd(_aRegs,{_cPerg,"02","Filial Até                    ","                              ","                              ","mv_ch2","C",08,0,0,"G","                                                            ","mv_par02       ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","          ","                                                            ","SM0","S","   ","          "})
	Aadd(_aRegs,{_cPerg,"03","Emissão De                    ","                              ","                              ","mv_ch3","D",08,0,0,"G","                                                            ","mv_par03       ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","          ","                                                            ","   ","S","   ","          "})
	Aadd(_aRegs,{_cPerg,"04","Emissao Até                   ","                              ","                              ","mv_ch4","D",08,0,0,"G","                                                            ","mv_par04       ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","          ","                                                            ","   ","S","   ","          "})
	Aadd(_aRegs,{_cPerg,"05","Categoria De                  ","                              ","                              ","mv_ch5","C",03,0,0,"G","                                                            ","mv_par05       ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","          ","                                                            ","XCLS","S","   ","          "})
	Aadd(_aRegs,{_cPerg,"06","Categoria Até                 ","                              ","                              ","mv_ch6","C",03,0,0,"G","                                                            ","mv_par06       ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","          ","                                                            ","XCLS","S","   ","          "})
	Aadd(_aRegs,{_cPerg,"07","Fornecedor De                 ","                              ","                              ","mv_ch7","C",06,0,0,"G","                                                            ","mv_par07       ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","          ","                                                            ","SA2","S","   ","          "})
	Aadd(_aRegs,{_cPerg,"08","Fornecedor Até                ","                              ","                              ","mv_ch8","C",06,0,0,"G","                                                            ","mv_par08       ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","          ","                                                            ","SA2","S","   ","          "})
	Aadd(_aRegs,{_cPerg,"09","Placa do Veículo              ","                              ","                              ","mv_ch9","C",07,0,0,"G","                                                            ","mv_par09       ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","               ","                                                            ","               ","               ","               ","          ","                                                            ","   ","S","   ","          "})

	For _nI:=1 to Len(_aRegs)
		If ! DbSeek(_cPerg+_aRegs[_nI,2])
			RecLock('SX1',.T.)
			For _nJ:=1 to FCount()
				If _nJ <= Len(_aRegs[_nI])
					FieldPut(_nJ,_aRegs[_nI,_nJ])
				Endif
			Next _nJ
			MsUnlock()
		Endif
	Next _nI
	RestArea(_aArea)
Return


