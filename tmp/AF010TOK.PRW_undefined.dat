#include "protheus.ch"

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³AF010TOK  ºAutor  ³Microsiga           º Data ³  02/09/11   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ PE de validacao de inclusao de ativo                       º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ MP 11 - SISTEMA INDUSTRIA                                  º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

User Function AF010TOK()
Local _lRet     := .t.
Local _cBase    := M->N1_CBASE
Local _cItem    := M->N1_ITEM
Local _cArea    := GetArea()
Local _cAreaSX6 := SX6->(GetArea())
Local cNovoCod	:= ""

/*
SN1->(dbSetOrder(1))
IF INCLUI .and. SN1->(dbSeek(XFilial("SN1")+_cBase+_cItem)) .And. !FunName() == "ATFA240"
	
	While !SN1->(MsSeek(xFilial("SN1")+_cBase))
		_cBase := Soma1(_cBase)
		SN1->(dbSkip())
	EndDo
	
	M->N1_CBASE := _cBase
	Aviso("Atenção","O código do bem foi alterado para "+_cBase,{"Continuar"})
ENDIF
*/

// O trecho acima foi substituido pelo trecho abaixo. Por Cadu em 30/01/13
IF INCLUI .And. !FunName() == "ATFA240"
    
	cNovoCod := U_SeekCBAS(_cBase,_cItem)
	
	If cNovoCod <> _cBase
		_cBase		:= Soma1(cNovoCod)
		M->N1_CBASE	:= _cBase
	
		Aviso("Atenção","O código do bem foi alterado para "+_cBase,{"Continuar"})
	EndIf

ENDIF

// Atualiza parametro
If Inclui .And. !FunName() == "ATFA240" //Ana
	dbSelectArea("SX6")
	dbSetOrder(1)
	IF dbSeek(LEFT(CFILANT,4)+Space(4)+"MV_CBASEAF")
		RecLock("SX6",.F.)
		FieldPut( FieldPos('X6_CONTEUD'), '"'+Soma1(Alltrim(_cBase))+'"' )
		FieldPut( FieldPos('X6_CONTSPA'), '"'+Soma1(Alltrim(_cBase))+'"' )
		FieldPut( FieldPos('X6_CONTENG'), '"'+Soma1(Alltrim(_cBase))+'"' )
		SX6->(MsUnLock())
	ENDIF
Endif	

RestArea(_cAreaSX6)
RestArea(_cArea)
Return(_lRet)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³SeekCBAS  ºAutor  ³TOTVS..             º Data ³  Jan/2013   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Verifica o numero do codigo do ativo.                      º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

User Function SeekCBAS(cCodAf,cItemAf)

Local aArea		:= GetArea()
Local cFilLoc 	:= LEFT(cFilAnt,4) //A filial a ser considerada na busca eh somente por empresa
Local cAlias	:= "TRB001"//GetNextAlias()//Carrega o proximo alias disponivel
Local cAlias2	:= "TRB002"//GetNextAlias()//Carrega o proximo alias disponivel
Local cRet		:= cCodAf
Local cN1FILIAL	:= ""	// acrescentado tratamento para que não de problema com outro Banco de Dados, ORACLE com SQL, por exemplo. Edson Ito-10/06/2013
          
If Select(cAlias) <> 0
		(cAlias)->(dbCloseArea())
	EndIf

	If Select(cAlias2) <> 0
		(cAlias2)->(dbCloseArea())
	EndIf

//Monta consulta para verificar se o codigo informado ja existe na base
/*cN1FILIAL	:= "% '" + SubStr(N1_FILIAL,1,4) + "' %"
BeginSQL Alias cAlias
	SELECT N1_FILIAL,N1_CBASE,N1_ITEM
	FROM %table:SN1%
//		WHERE SubStr(N1_FILIAL,1,4) = %Exp:cFilLoc%
		WHERE %Exp:cN1FILIAL% = %Exp:cFilLoc%
		AND %NotDel%
		AND N1_CBASE = %Exp:cCodAf%
		AND N1_ITEM = %Exp:cItemAf%
EndSQL */

//O Trecho acima foi substituido pelo abaixo por Ana. Pois estava retornando registro de outra empresa e mudava o código do bem da empresa corrente.            
cQuery := " SELECT SN1.N1_FILIAL, SN1.N1_CBASE, SN1.N1_ITEM "
cQuery += " FROM "+RetSqlName("SN1")+" SN1 " 
cQuery += "	WHERE SubString(SN1.N1_FILIAL,1,4) = '"+substr(cFilAnt,1,4)+"' "
cQuery += "	AND SN1.N1_CBASE = '"+cCodAf+"'" 
cQuery += "	AND SN1.N1_ITEM = '"+cItemAf+"'"
cQuery += "	AND SN1.D_E_L_E_T_ <> '*' " 
cQuery += "	ORDER BY SN1.N1_FILIAL "
                                
cQuery := ChangeQuery(cQuery)

dbUseArea( .T., "TOPCONN", TCGENQRY(,,cQuery),cAlias, .F., .T.)

dbSelectArea((cAlias))

//Se existir procuro o maior codigo
If !EOF() .and. !BOF() .and. !Empty((cAlias)->N1_CBASE)

	BeginSQL Alias cAlias2
		SELECT MAX(N1_CBASE) N1_CBASE
		FROM %table:SN1%
//			WHERE SubStr(N1_FILIAL,1,4) = %Exp:cFilLoc%
			WHERE %Exp:cN1FILIAL% = %Exp:cFilLoc%
			AND %NotDel%
	EndSQL
	
	dbSelectArea((cAlias2))

	If !EOF() .and. !BOF() .and. !Empty((cAlias2)->N1_CBASE)
    	cRet := (cAlias2)->N1_CBASE
	EndIf
    
	If Select(cAlias) <> 0
		(cAlias)->(dbCloseArea())
	EndIf

	If Select(cAlias2) <> 0
		(cAlias2)->(dbCloseArea())
	EndIf

Endif

RestArea(aArea)
 
Return(cRet)
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ ATVALCBASEº Autor ³ Carlos A. Queiroz  º Data ³  06/06/13   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Monta consulta para verificar se o codigo informado         º±±
±±º          ³ ja existe na base. x3_vlduser do campo SN1->N1_CBASE.       º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ CNI - Fiergs                                                º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/                                                                
User Function ATVALCBASE(__cBase,__cItem)
Local   lRet    := .T. 
Local   lAlter  := .F.
Local   cFilOrig:= ""
Default __cBase := ""
Default __cItem := StrZero(Val('1'),TamSX3("N1_ITEM")[1])

if Empty(__cBase)
	Return lRet
endif

//if funname() == "ATFA240" .and. alltrim(M->N1_CBASE) == alltrim(SN1->N1_CBASE)
//  Return lRet
//endif

U_MT103QrySn1(__cBase,__cItem)   // funcao contida no ponto de entrada MT103AFN
  
// Se o codigo existir, busca o maior codigo da base para ser utilizado. 
dbselectarea("TRBSN1")

If TRBSN1->(!EOF())	
	dbSelectArea("SX6")
	dbSetOrder(1)
	IF dbSeek(LEFT(CFILANT,4)+Space(4)+"MV_CBASEAF")
		__cBase := &(SX6->X6_CONTEUD)
	Endif	
	
	cFilOrig := substr(TRBSN1->N1_FILIAL,5,4)
	
	U_MT103QrySn1(__cBase,__cItem)
	lAlter  := .T.
	lRet    := .F.
    
EndIf

While TRBSN1->(!EOF())
	lAlter  := .T.
	lRet    := .F.
	__cBase := Soma1(Alltrim(__cBase))
    cFilOrig := substr(TRBSN1->N1_FILIAL,5,4)
	U_MT103QrySn1(__cBase,__cItem)
EndDo

If Select("TRBSN1") > 0
	TRBSN1->(dbclosearea())
EndIf                      

If lAlter
   msginfo("O código '"+alltrim(M->N1_CBASE)+"-"+alltrim(M->N1_ITEM)+"' já foi utilizado para a empresa "+substr(cFilAnt,1,4)+" e filial "+alltrim(cFilOrig)+"."+chr(13)+chr(10)+chr(13)+chr(10)+"O próximo código válido na seqüência a ser utilizado para esta empresa é o '"+alltrim(__cBase)+"'."+chr(13)+chr(10))
EndIf

Return lRet