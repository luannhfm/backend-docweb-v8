#Include 'Protheus.ch'

//-----------------------------------------------------
/*/{Protheus.doc} SF06A74X
Grava na tabela o Historico.
(Cópia da Static Function AddHistor, localizada no código-fonte SF06A01X.prw)
@author Allan da Silva Faria
@since 15/04/2016
@version 1.0
@param _aDados	, Array		, Dados do cliente, título e historico
@param _cFunName, Caracter	, Nome da função que solicitou a gravação
/*/
//-----------------------------------------------------

User Function SF06A74X(_aDados,_cFunMame,_dDataInc,_cFilial, _pnRad)

	DEFAULT _cFunMame := AllTrim(FunName())	
	DEFAULT _dDataInc := dDatabase
	DEFAULT _cFilial  := FWxFilial("ZF1")

	dbSelectArea("ZF1")
	ZF1->(dbSetOrder(1))

	If ! Empty(_aDados[08]) .or. ! Empty(_aDados[07]) .or.  ! Empty(_dDataInc) 
		RecLock("ZF1",.T.)
		Replace ZF1_FILIAL 	With _cFilial
		Replace ZF1_CLIENT	With _aDados[01]
		Replace ZF1_LOJA	With _aDados[02]
		Replace ZF1_PREF	With _aDados[03]
		Replace ZF1_NUM		With _aDados[04]
		Replace ZF1_PARC	With _aDados[05]
		Replace ZF1_TIPO	With _aDados[06]
		Replace ZF1_DATA	With _dDataInc
		Replace ZF1_AGENDA	With _aDados[07]
		Replace ZF1_HISTOR 	With _aDados[08]
		Replace ZF1_CODUSR	With RetCodUsr()
		//Replace ZF1_ORIGEM  With _cFunMame+STR(_pnRad,1)
		Replace ZF1_SEQ		With _aDados[09]
		Replace ZF1_HORA	With Time()
		
        // A função AddHistor() é executada tambem pelo faturamento e a variável _nRad não é utilizada no MÓDULO
        // Paulo Schwind - 23/05/2019
		if ValType(_pnRad) <> 'U'
		   Replace ZF1_ORIGEM  With _cFunMame+STR(_pnRad,1)
		   Replace ZF1_ACAO	With STR(_pnRad,1)
		Else
	  	   Replace ZF1_ORIGEM  With _cFunMame
		   Replace ZF1_ACAO	With '2'   
		Endif   

		If LEN(_aDados) >= 12
			Replace ZF1_DTPROC	With _aDados[12]
		EndIf

		If LEN(_aDados) > 9
			Replace	ZF1_XJREC	With _aDados[10]
			Replace ZF1_XJPARE	With _aDados[11]
		Else
			Replace	ZF1_XJREC	With .F.
			Replace ZF1_XJPARE	With .F.
		EndIf
		MsUnLock()
	EndIf

Return NIL
