#INCLUDE "PROTHEUS.CH"
#INCLUDE "REPORT.CH"
 
/*/f/
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
<Descricao> :  Fun誽o respons嫛el pela gera誽o do Relat鏎io de estrutura de rateio
<Autor> : WILLIAM SANTOS
<Data> : 20/06/2014
<Parametros> : Nil
<Retorno> : Nil
<Processo> : FIEMT � Importa誽o de Horas
<Tipo> R (Relat鏎io)
<Obs> : 
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
*/

User Function DTGPER03()

Local oReport
Local lTRepInUse := .T.
Local cTitle     := "Estrutura de Rateio de Funcion嫫ios"
Local oReport                               

Private cPerg 	 := "DTGPER03"

If FindFunction("TRepInUse") .And. lTRepInUse
	//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
	//蛆nterface de impressao                                                  �
	//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁   
	
	// Funcao para criacao das perguntas.
	fCriaSx1()

	If pergunte(cPerg,.T. )

		oReport:= TReport():New("DTGPER03", cTitle,, {|oReport| DefPrint(oReport)}, cTitle)

		oReport:SetLandScape(.T.)
		oReport:ldisableorientation:=.T.
		oReport:GetOrientation(1)

		oReport:PrintDialog()
	EndIf
EndIf

Return

/*/
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控矬闡闡闡闡鐃闡闡闡闡闡薩闡闡闡薩闡闡闡闡闡闡闡闡闡闡闡薩闡闡鐃闡闡闡闡闡膨�
控袈rograma  袒eportPrin� Autor 莧lexandre Inacio Lemes 蛇ata  �06/09/2006陰�
控藥闡闡闡闡霰闡闡闡闡闡謐闡闡闡謐闡闡闡闡闡闡闡闡闡闡闡謐闡闡鐘闡闡闡闡闡敢�
控蛇escri��o � Emissao do Pedido de Compras / Autorizacao de Entrega      陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡敢�
控袖intaxe   � ReportPrint(ExpO1,ExpN1,ExpN2)                             陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡敢�
控袈arametros� ExpO1 = Objeto oReport                      	              陰�
控�          � ExpN1 = Numero do Recno posicionado do SC7 impressao Menu  陰�
控�          � ExpN2 = Numero da opcao para impressao via menu do PC      陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡敢�
控袒etorno   術enhum                                                      陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡敢�
控袈arametros蛀xpO1: Objeto Report do Relat鏎io                           陰�
控斂闡闡闡闡鐘闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡棱�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
/*/
Static Function DefPrint(oReport)

Local lCabec   := .T.
Local lMat     := .T.
Local cQuebra  := "" 
Local cVerba   := ""
Local nLinha   := 240

Local nSizeCTD := 4
Local nSizeCTT := 4

Local cQuery   := ""
Local cAlias   := GetNextAlias() 

Local oBrush   := TBrush():New("",CLR_LIGHTGRAY)

Private cTabEmp    := SubStr( SuperGetMV("DT_TBEMP" ), 1, TamSX3("RCB_CODIGO")[1] ) 
Private aEmpComp   := {}
Private aTamanhos  := {}    
Private cEmpRat	   := ""
Private nPos	   := 0
Private cDescEmpRat:= ""
Private cPeriodo	:= StrZero( Year( MV_PAR01 ), 4 ) + StrZero( Month( MV_PAR01 ), 2 ) //GETMV("MV_FOLMES")
Private aEmpLog		:= FWEmpLoad( .T. ) 
Private aEmpAux		:= {}
Private cEmpresas	:= '('
Private nPos		:= 0
Private cAux		:= ''  
  


For nX:= 1 To Len(aEmpLog)                                   
  	AADD(aEmpAux,aEmpLog[nX][3])
Next 

For nX := 1 to Len(aEmpAux)
	cEmpresas += "'"+aEmpAux[nX]+"'," 
Next

cEmpresas := SubStr(cEmpresas,1,(Len(cEmpresas)-1))+")"

//----------------------------------------------------------------------------
//
//----------------------------------------------------------------------------------------------------------------

oFont1  := TFont():New( 'Arial', 08, 08, .T., .T., 5, .T., 5, .F., .F. )
oFont2  := TFont():New( 'Arial', 08, 08, .T., .F., 5, .T., 5, .F., .F. )
oFont3  := TFont():New( 'Arial', 09, 09, .T., .F., 5, .T., 5, .F., .F. )
oFont3N := TFont():New( 'Arial', 09, 09, .T., .T., 5, .T., 5, .F., .F. )
oFont4  := TFont():New( 'Arial', 09, 09, .T., .F., 5, .T., 5, .F., .F. )
oFont5  := TFont():New( 'Arial', 10, 10, .T., .T., 5, .T., 5, .F., .F. )
oFont6  := TFont():New( 'Arial', 10, 10, .T., .F., 5, .T., 5, .F., .F. )
oFont7  := TFont():New( 'Arial', 12, 12, .T., .F., 5, .T., 5, .F., .F. )
oFont7N := TFont():New( 'Arial', 12, 12, .T., .T., 5, .T., 5, .F., .F. )
oFont8  := TFont():New( 'Arial', 12, 12, .T., .F., 5, .T., 5, .F., .F. )
oFont9  := TFont():New( 'Arial', 16, 16, .T., .F., 5, .T., 5, .F., .F. )
oFont9N := TFont():New( 'Arial', 16, 16, .T., .T., 5, .T., 5, .F., .F. )
oFont10 := TFont():New( 'Arial', 20, 20, .T., .T., 5, .T., 5, .F., .F. )

//----------------------------------------------------------------------------
//
//----------------------------------------------------------------------------------------------------------------

//-- Mantive a ZD6_FILIAL, mesmo trocando para RA_FILIAL para efeito de analise pela Query

cQuery :=        "SELECT ZD6_FILIAL, SRA.RA_FILIAL, ZD6_MESANO PER,ZD6_MAT,SRA.RA_NOME,ZD6_CC,CTT.CTT_DESC01,ZD6_ITEM,ctd.ctd_desc01,ZD6_HRMES,ZD6_HRTRAB,ZD6_PERCEN"
cQuery += CRLF + "  From " + RetSqlName("ZD6") + " ZD6 "
cQuery += CRLF + "  Left Join " + RetSqlName("SRA") + " SRA On SRA.D_E_L_E_T_ = ' ' And SubStr( SRA.RA_FILIAL, 1, "  + Str( nSizeCTT, 2 ) + " ) = SubStr( ZD6.ZD6_FILIMP, 1, " + Str( nSizeCTT, 2 ) + ") And SRA.RA_MAT = ZD6.ZD6_MAT"
cQuery += CRLF + "  Left Join " + RetSqlName("CTD") + " CTD On CTD.D_E_L_E_T_ = ' ' And SubStr( CTD.CTD_FILIAL, 1, " + Str( nSizeCTD, 2 ) + " ) = SubStr( SRA.RA_FILIAL, 1, " + Str( nSizeCTD, 2 ) + " ) And CTD.CTD_ITEM = ZD6.ZD6_ITEM"
cQuery += CRLF + "  Left Join " + RetSqlName("CTT") + " CTT On CTT.D_E_L_E_T_ = ' ' And SubStr( CTT.CTT_FILIAL, 1, " + Str( nSizeCTT, 2 ) + " ) = SubStr( SRA.RA_FILIAL, 1, " + Str( nSizeCTT, 2 ) + " ) And CTT.CTT_CUSTO = ZD6.ZD6_CC"

cQuery += CRLF + " Where ZD6.D_E_L_E_T_ = ' '"   

IF MV_PAR04 == 1 // 1=Mensal / 2=Historial                    
	cQuery += CRLF + "   And ZD6.ZD6_MESANO = '" + cPeriodo + "'"
EndIf
cQuery += CRLF + "   And ZD6.ZD6_MAT    BETWEEN '" + MV_PAR02 + "' And '" + MV_PAR03 + "'"    
cQuery += CRLF + "   And ZD6.ZD6_FILIAL IN    " + cEmpresas                      
cQuery += CRLF + " AND ZD6_MAT||ZD6_MESANO IN (SELECT ZD6_MAT||MAX(ZD6_MESANO) FROM "+RetSqlName("ZD6")+" WHERE D_E_L_E_T_ = ' ' GROUP BY ZD6_MAT) "
If MV_PAR05 = 2 //Considera demitidos
	cQuery += CRLF + "     AND SRA.RA_SITFOLH <> 'D' "
Endif
cQuery += CRLF + "     AND SRA.RA_XTPRAT <> '3' " //Excluir Funcionarios da GC
cQuery += CRLF + " ORDER BY ZD6.ZD6_MAT, ZD6.ZD6_MESANO, ZD6.ZD6_ITEM"

cQuery := ChangeQuery( cQuery )

dbUseArea( .T., "TOPCONN", TCGenQry(,,cQuery), cAlias, .T., .T. )


dbSelectArea(cAlias)

//----------------------------------------------------------------------------
//
//----------------------------------------------------------------------------------------------------------------

//DTGPE02Get() //carrega descri誽o de empresas

While (cAlias)->( !Eof() )

	If oReport:Cancel()
		Exit
	EndIf
	
	//----------------------------------------------------------------
	//	Itens
	//--------------------------------------------------------------------------------------------------

	If lCabec

		lCabec := .F.
	
		oReport:FillRect({ (nLinha+43), 0011, (nLinha+100), 3400}, oBrush)
			
		oReport:Box(  (nLinha+40), 0010, (nLinha+100), 3400)

		oReport:Say( (nLinha+01), 1500, "DATA BASE: " + Upper( MesExtenso( MV_PAR01 ) ) + " / " + StrZero( Year( MV_PAR01 ), 4 ), oFont5,,,, 0 )

		oReport:Say( (nLinha+50), 0015, "Filial"                                 , oFont3N,,,, 0 )
		oReport:Say( (nLinha+50), 0135, "Mat."		                             , oFont3N,,,, 0 )
		oReport:Say( (nLinha+50), 0255, "Nome"                                   , oFont3N,,,, 0 )//Posi誽o Original 250
		oReport:Say( (nLinha+50), 0650, "C. Custo"		                         , oFont3N,,,, 0 )//Posi誽o Original 750
		oReport:Say( (nLinha+50), 0800, "Descri誽o"                              , oFont3N,,,, 0 )//Posi誽o Original 1000
		oReport:Say( (nLinha+50), 1400, "Item Cont墎il"                          , oFont3N,,,, 0 )//Posi誽o Original 1500
		oReport:Say( (nLinha+50), 1700, "Descri誽o"                              , oFont3N,,,, 0 )//Posi誽o Original 1700
		oReport:Say( (nLinha+50), 2100, "Hist./M瘰"	                             , oFont3N,,,, 0 )//Posi誽o Original 2300
		oReport:Say( (nLinha+50), 2300, "Hrs. M瘰"	                             , oFont3N,,,, 0 )//Posi誽o Original 2300
		oReport:Say( (nLinha+50), 2500, "Hrs. Trab."                             , oFont3N,,,, 0 )//Posi誽o Original 2600
		oReport:Say( (nLinha+50), 2700, "Percentual"                          	 , oFont3N,,,, 0 )//Posi誽o Original 2970

		nLinha += 110

	EndIf
	
	//cEmpRat := SUBSTR((cAlias)->ZD7_FILRAT,1,2)
	//nPos:= ASCAN(aEmpcomp,{ |aEmpComp|  aEmpComp[2] = cEmpRat})
	//cDescEmpRat := AllTrim(aEmpComp[nPos][1])

	If lMat
		lVerba := .F.
		oReport:Say( nLinha, 0010,            (cAlias)->RA_FILIAL                           , oFont2,,,, 0 )
		oReport:Say( nLinha, 0135,            (cAlias)->ZD6_MAT                              , oFont2,,,, 0 )
		oReport:Say( nLinha, 0250,            SUBSTR((cAlias)->RA_NOME,1,20)                 , oFont2,,,, 0 )
	EndIf

	oReport:Say( nLinha, 0650,               SUBSTR(AllTrim((cAlias)->ZD6_CC),1,11)         , oFont2,,,, 0 )
	oReport:Say( nLinha, 0800,               SUBSTR((cAlias)->CTT_DESC01,1,32)              , oFont2,,,, 0 )
	oReport:Say( nLinha, 1400,               (cAlias)->ZD6_ITEM                             , oFont2,,,, 0 )
	oReport:Say( nLinha, 1700,               SUBSTR((cAlias)->CTD_DESC01,1,32)              , oFont2,,,, 0 )
	oReport:Say( nLinha, 2150, 	  			 IIF((cAlias)->PER == cPeriodo,"M","H")      	, oFont2,,,, 0 )
  	oReport:Say( nLinha, 2300, 	  			 Transform( (cAlias)->ZD6_HRMES  , "@E 999.99" )      	, oFont2,,,, 0 )
	oReport:Say( nLinha, 2500,    			 Transform( (cAlias)->ZD6_HRTRAB  , "@E 999.99" ) 		, oFont2,,,, 0 )
	oReport:Say( nLinha, 2700,    			 Transform( (cAlias)->ZD6_PERCEN  , "@E 999.99" ) + "%", oFont2,,,, 0 ) 

	nLinha += 40

	If nLinha >= 2500

		lNome := .T.
		lMat:= .T.
		lCabec := .T.
		nLinha := 240

		oReport:EndPage()	

   EndIf

	cQuebra   := (cAlias)->ZD6_MAT + (cAlias)->ZD6_FILIAL 

	(cAlias)->( dbSkip() )
	
		
//	If cQuebra # (cAlias)->ZD6_MAT
//		nLinha += 10
//	EndIf

	If cQuebra # (cAlias)->ZD6_MAT  + (cAlias)->ZD6_FILIAL
		nLinha += 20
		lVerba := .T.
	EndIf
End

(cAlias)->( dbCloseArea() )
	
Return

/*/f/
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
<Descricao> : Rotina para controle de versao
<Data> : 24/05/2014
<Parametros> : Nenhum
<Retorno> : cRet
<Processo> : Controle de versao
<Tipo> (Menu,Trigger,Validacao,Ponto de Entrada,Genericas,Especificas ) : V
<Autor> : Doit Sistemas
<Obs> :
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
*/

User Function DTGPER3V()

Local cRet := ""
cRet := "20140523"
 
Return cRet 

/*/f/
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
<Descricao> : Rotina para retornar codigo e descri誽o das empresas a processar
<Data> : 18/06/2014
<Parametros> : Nenhum
<Retorno> : cRet
<Tipo> (Menu,Trigger,Validacao,Ponto de Entrada,Genericas,Especificas ) : V
<Autor> : Doit Sistemas
<Obs> :
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
*/

Static Function DTGPE03Get   


dbSelectArea("RCB")
dbSetOrder( 1 )

dbSelectArea("RCC")
dbSetOrder( 1 )



If RCB->( dbSeek( xFilial("RCB")+cTabEmp ) ) .And. RCC->( dbSeek( xFilial("RCC")+cTabEmp ) )

		While RCB->RCB_CODIGO == cTabEmp .And. !RCB->( Eof() )

		   Aadd( aTamanhos, RCB->RCB_TAMAN )

			RCB->( dbSkip() )

		End

		While RCC->RCC_CODIGO == cTabEmp .And. !RCC->( Eof() )

			nItem := 1

			Aadd( aEmpComp, Array( Len(aTamanhos) ) )

			For nI := 1 To Len( aTamanhos )

				aEmpComp[Len(aEmpComp)][nI] := SubStr( RCC->RCC_CONTEU, nItem, aTamanhos[nI] )

         	nItem += aTamanhos[nI]

			Next

			RCC->( dbSkip() )
	   End
	EndIf
                                        

Return              

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/** {Protheus.doc} fCriaSx1
Funcao para criacao das perguntas

@param: 	<Nil>
@author 	Auremar Duarte
@since 	    21/08/2014
@Uso: 		SFIEMT
*/
Static Function fCriaSx1()

	/*
		MV_PAR01  Database		    ?   
		MV_PAR02  Funcionario de	?  
		MV_PAR03  Funcionario ate	?  
		MV_PAR04  Estrutura     	?  1=Mensal / 2=Historial
		MV_PAR05  Cons. Demitidos   ?            
		MV_PAR06  Lista Inativos	?          
	*/

	u_SFPUTSX1( cPerg, "01","Database             "	  ,"","","mv_ch1","D",8                    ,0,0,"G","",""		,"","","mv_par01","","","","","","","","","","","","","","","","",{},{},{})
	u_SFPUTSX1( cPerg, "02","Funcionario De       "	  ,"","","mv_ch2","C",TamSX3("RA_MAT")[1]	 ,0,0,"G","","SRA"	,"","","mv_par02","","","","","","","","","","","","","","","","",{},{},{})
	u_SFPUTSX1( cPerg, "03","Funcionario Ate      "	  ,"","","mv_ch3","C",TamSX3("RA_MAT")[1]	 ,0,0,"G","","SRA"	,"","","mv_par03","","","","","","","","","","","","","","","","",{},{},{})
	u_SFPUTSX1( cPerg, "04","Estrutura            "	  ,"","","mv_ch4","N",1						 ,0,0,"C","",""		,"","","mv_par04","Mensal","","","","Historial","","","","","","","","","","","",{},{},{})
	u_SFPUTSX1( cPerg, "05","Considera Demitidos? "	  ,"","","mv_ch5","N",1						 ,0,0,"C","",""		,"","","mv_par05","Sim"   ,"","","","N緌","","","","","","","","","","","",{},{},{})
//	u_SFPUTSX1( cPerg, "06","Lista Inativos ?     "   ,"","","mv_ch6","N",1					     ,0,0,"C","",""		,"","","mv_par06","1=Sim","","","","2=N緌","","","","","","","","","","","",{},{},{})
	
Return( Nil )