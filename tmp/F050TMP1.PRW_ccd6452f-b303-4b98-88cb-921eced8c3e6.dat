#INCLUDE'totvs.ch'
#INCLUDE'rwmake.ch'
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³F050RAUT  ºAutor  ³Microsiga           º Data ³  11/04/12   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ PE tratamento do rateio em rotina automatica               º±±
±±º          ³                                                            º±± 
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ P11 - SISTEMA INDUSTRIA                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User function F050TMP1()
Local _lAuto 	:= ParamIxb[8] // acesso via execauto
Local _nOrig 	:= ParamIxb[9]
Local _VrRat       
Local i		 	:= 0 
Local y		 	:= 0
// Incluido por J2a -> Gustavo Krebs Inclusão de Rateio automático 
Local cProTit 	:= U_cRotTitu()
Local a_AreaATU := {} as array
Local aArrRat   :={} as array 
Local nAtual    := 0 as numeric 
Local nValor    := 0 as numeric 
Local nTotal    := 0 as numeric 
// Incluido por J2a -> Gustavo Krebs Inclusão de Rateio automático 			
		If cProTit == "S"
		   	nOrig := ParamIxb[9]
		   If nOrig == 2 //Chamada pela CTBRATFIN
		   		MV_PAR04 := 2
			 	a_AreaATU   := GetArea()
			 	aArrRat     := U_ArrF050()
					For nAtual   := 1 To Len(aArrRat)
						DbSelectArea("TMP")
						RecLock("TMP", .T.)
						CTJ_DEBITO      := ALLTRIM(aArrRat[nAtual][1][2])
						CTJ_CREDITO     := ALLTRIM(aArrRat[nAtual][2][2])
						CTJ_PERCEN      := aArrRat[nAtual][3][2]
						CTJ_VALOR       := aArrRat[nAtual][4][2]
						CTJ_HIST        :=  "PONTO DE ENTRADA F050TMP1, ITEM001!"+TIME()
						CTJ_CCD         := ALLTRIM(aArrRat[nAtual][6][2])
						CTJ_CCC         := ALLTRIM(aArrRat[nAtual][7][2])
						CTJ_ITEMD       := ALLTRIM(aArrRat[nAtual][8][2])
						CTJ_ITEMC       := ALLTRIM(aArrRat[nAtual][9][2])
						CTJ_CLVLDB      := ALLTRIM(aArrRat[nAtual][10][2])
						CTJ_CLVLCR      := ALLTRIM(aArrRat[nAtual][11][2])
						CTJ_EC05DB      := aArrRat[nAtual][12][2]
						CTJ_EC05CR      := aArrRat[nAtual][13][2]  
						CTJ_EC06DB      := aArrRat[nAtual][14][2]
						CTJ_EC06CR      := aArrRat[nAtual][15][2]
						CTJ_EC07DB      := aArrRat[nAtual][16][2]
						CTJ_EC07CR      := aArrRat[nAtual][17][2] 
						CTJ_EC08DB      := aArrRat[nAtual][18][2] 
						CTJ_EC08CR      := aArrRat[nAtual][19][2] 
						CTJ_EC09DB      := aArrRat[nAtual][20][2] 
						CTJ_EC09CR      := aArrRat[nAtual][21][2]
						CTJ_SEQUEN      := ALLTRIM(aArrRat[nAtual][22][2])
						CTJ_FLAG        := .F.
						MSUNLOCK()
						nSoma   := nValor + aArrRat[nAtual][4][2]
						nvalor  := nSoma
						nTotal  := nvalor
					NEXT
						RestArea(a_AreaATU)
				
			EndIf
				Return {nTotal, 0}
		Endif 
// Fim da rotina --> Incluido por J2a -> Gustavo Krebs Inclusão de Rateio automático --> Fim da condição criada por Gustavo
If FunName() == "FINA100"
	_VrRat := M->E5_VALOR    
ElseIf FunName() == "FINA370"
	_VrRat := SE1->E1_VALOR
Else                     
	_VrRat := M->E2_VALOR
Endif	

If _nOrig == 2 //Chamada pela CTBRATFIN
	IF _lAuto
		IF IsInCallStack("U_SIFINA11") // Origem Rateio Mutuo
			If !(IsInCallStack("SIFIN11Est"))
			SZY->(dbSetOrder(1))
			IF SZY->(dbSeek(XFilial("SZY")+SZX->(ZX_RATEIO+ZX_ITEM)))
				_aStruTMP := TMP->(dbStruct())
			ENDIF
			
			While SZY->(!Eof()) .and. SZY->ZY_FILIAL == XFilial("SZY") .and. SZY->(ZY_RATEIO+ZY_ITEMRAT) == SZX->(ZX_RATEIO+ZX_ITEM)
				Reclock("TMP",.T.)
				For i := 1 to Len(_aStruTMP)
					IF SZY->(FieldPos(Alltrim( StrTran(_aStruTMP[i,1],"CTJ_","ZY_") ))) > 0
						&(_aStruTMP[i,1]) := SZY->( &(StrTran(_aStruTMP[i,1],"CTJ_","ZY_")) )
					ENDIF
				Next
				CTJ_FLAG   := .F.
				TMP->(msUnlock())
				SZY->(dbSkip())
			Enddo
			Else
				_VrRat := F050Carr(ParamIxb[1], ParamIxb[2], ParamIxb[3], ParamIxb[4], ParamIxb[5], ParamIxb[6], ParamIxb[7], {})
			Endif
		ELSEIF IsInCallStack("U_SIESBA04") .and. Type("_aTotRat") <> "U" // Origem ESB
			
			_aStruTMP := TMP->(dbStruct())
			
			For i := 1 to Len(_aTotRat)
				Reclock("TMP",.T.)
				For y := 1 to Len(_aTotRat[i])
					_cCampo := Alltrim(StrTran(_aTotRat[i][y][1],"CV4_","CTJ_"))
					IF TMP->(FieldPos(Alltrim(StrTran(_aTotRat[i][y][1],"CV4_","CTJ_")))) > 0
						&("TMP->"+_cCampo) := _aTotRat[i][y][2]
					ENDIF
				Next
				TMP->CTJ_FLAG   := .F.
				TMP->(msUnlock())
				
			Next
		ENDIF
	ELSE
		_VrRat := F050Carr(ParamIxb[1],ParamIxb[2],ParamIxb[3],ParamIxb[4],ParamIxb[5],ParamIxb[6],ParamIxb[7])
	ENDIF
EndIf

Return({_VrRat,IIF(_lAuto,0,1)}) //{Valor do Rateio,Flag com a tela de opções do rateio}
