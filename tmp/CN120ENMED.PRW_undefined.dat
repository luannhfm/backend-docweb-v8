#INCLUDE "PROTHEUS.CH"

/*/{Protheus.doc} CN120ENMED
ponto de entrada executado no encerramento da medição de contrato, se o contrato for do 
parque, devera faturar o pedido.	
@author j2a.luizjunior
@since 26/09/2017
@version 1.0
@example
(examples)
@see (links_or_references)
/*/

User Function CN120ENMED()
	
	If !IsBlind()
	
		//-> Checa se o contrato é do parque
		If CN9->CN9_XCONVE == "S"	
			cMedEve := Posicione("CN1",1,xFilial("CN1") + CN9->CN9_TPCTO ,"CN1_MEDEVE")
			If cMedEve == "2"  
				Aviso(OemToAnsi("Atenção"),OemToAnsi("Contratos do tipo 'Medição Automatica' não serão faturados por esta rotina. "),{"Ok"})
				Return
			EndIf
			GERAFAT(SC5->C5_MDCONTR)
		EndIf

	EndIf

Return

/*/{Protheus.doc} GERAFAT
(long_description)
@author j2a.luizjunior
@since 25/09/2017
@version 1.0
@example
(examples)
@see (links_or_references)
/*/

Static Function GERAFAT(pContra)
	
	Local cEstat := U_SFGN001A(ProcName(0), "SF0530X")
	Local   cContra  := pContra 
	Local   aCoors   := FWGetDialogSize(oMainWnd)	 
	Local   oMarkSE1 := Nil
	Local   cNota    := Space(TamSx3("C5_NOTA")[1])
	Local   cSerie   := Space(TamSx3("C5_SERIE")[1])	
	Local   cFiltro  := " SC5->C5_FILIAL = '" + xFilial("SC5") + "' .And. SC5->C5_MDCONTR = '" + cContra + "' .And. SC5->C5_NOTA = '" + cNota + "' .And. SC5->C5_SERIE = '" + cSerie + "'"
	Private oGTit    := Nil
	Private aRotina	 := MenuDef()	
	Private oMarkSE1 := Nil  
	Private aNota    := {}
	
	oGTit := MSDialog():New( aCoors[1],aCoors[2],aCoors[3],aCoors[4]," Pedidos gerados para o contrato: " +cContra ,,,.F.,,,,,,.T.,,,.T. )
	
	oMarkSE1 := FWMarkBrowse():New()
	oMarkSE1:SetOwner(oGTit)
	
	oMarkSE1:SetAlias("SC5") 
	oMarkSE1:SetDescription("Pedido de Vendas")
	oMarkSE1:SetProfileID("1")
	oMarkSE1:ForceQuitButton()		
	oMarkSE1:SetFilterDefault(cFiltro)			
	oMarkSE1:SetFieldMark("C5_OK")
	oMarkSE1:SetOnlyFields({"C5_FILIAL","C5_NUM","C5_CLIENTE","C5_LOJACLI"}) 
	oMarkSE1:SetMenuDef("")
	oMarkSE1:SetAfterMark({|| AFTERMARK(@oMarkSE1) })
	oMarkSE1:SetAllMark(  {|| ALLMARK(@oMarkSE1)   })								
	oMarkSE1:Activate()
	
	oGTit:Activate(,,,.T.)

Return
