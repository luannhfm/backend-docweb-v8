#INCLUDE "RWMAKE.CH"
#INCLUDE "protheus.CH"
#INCLUDE "TopConn.ch"
#INCLUDE "TBICONN.CH"
#INCLUDE "FILEIO.CH"
#INCLUDE "APWIZARD.CH"
                                                                              
/*/f/                                   
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
<Descricao> : Rateio de Verbas
<Autor> : Fábrica DOIT SP
<Data> : 05/05/2014
<Parametros> : Nil
<Retorno> : Nil
<Processo> : FIEMT – Folha de Pagamento
<Tipo> : 
<Obs> : 
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
*/

User Function DTGPE02()

Local cTitle       := "Wizard - Rateio de Verbas por Percentual de Horas Alocadas"

Local nL           := 0
Local nOpc         := 0
Local aTitDad      := {}

Local oUsrImp      := Nil
Local oDataImp     := Nil
Local oHoraImp     := Nil

Private lMsgFim    := .T.
Private lGPE02Ok   := .T.

Private oMesBase   := Nil
Private oAnoBase   := Nil
Private oTabela    := Nil
Private oDescComp  := Nil
Private oDescEmp   := Nil
Private oArqImp    := Nil
Private oTermGr1   := Nil
Private oTermGr2   := Nil
Private oTermGr3   := Nil

Private oWizard    := Nil

Private aMesBase   := {}
Private aAnoBase   := {}
Private cPeriodo   := GETMV("MV_FOLMES")
Private cMesBase   := ""
Private cAnoBase   := ALLTRIM(IIF(SUBSTR(cPeriodo,5,2)<>'01',SUBSTR(cPeriodo,1,4),STR(VAL(SUBSTR(cPeriodo,1,4))-1))) //StrZero(  Year( dDataBase ), 4 )
Private cTabComp   := SubStr( SuperGetMV("DT_TBPERC"), 1, TamSX3("RCB_CODIGO")[1] )
Private cTabEmp    := SubStr( SuperGetMV("DT_TBEMP" ), 1, TamSX3("RCB_CODIGO")[1] )
Private dDataIni   := CTOD('//')
Private cDataProv  := ""
Private cDtDemIni  := ""
Private cDtDemFim  := ""
Private cDescComp  := ""
Private cDescEmp   := ""

Private cUsrRat    := UsrRetName(RetCodUsr())
Private dDataRat   := dDataBase
Private cHoraRat   := Time()

Private nTermGr1   	:= 0
Private nTermGr2   	:= 0
Private nTermGr3   	:= 0

Private lFolha     	:= .T.
Private lFerias    	:= .T.
Private l13Salario 	:= .T.                 
Private cFilEmp	  	:= ''
Private cCtaDeb		:= ''
Private cCtaCre		:= ''
Private nVRat			:= 0
Private cCtaMut		:= 0  
Private cFilRat		:= ''
Private cVerbaInt	:= ''   
Private aValRat		:= {}
Private cTabMov		:= ""
Private aVbBaixa		:= {}
Private nPos			:= 0

//Jose Leite - 05-12-14
If Substr(cPeriodo,5,2) == '01'
	cPeriodo		:= STRZERO(VAL(Substr(cPeriodo,1,4))-1,4)+"12"
Else
	cPeriodo		:= SUBSTR(cPeriodo,1,4)+STRZERO(VAL(Substr(cPeriodo,5,2))-1,2)
EndIf
  
cTabMov			:= "RC01"+substr(cPeriodo,3,4)  
cTabMovRI			:= "RI01"+substr(cPeriodo,3,2)+"13"              
dDataIni			:= LASTDAY(CTOD("01/"+Substr(cPeriodo,5,2)+"/"+SUBSTR(cPeriodo,1,4)))
cDataProv			:= DTOS(dDataIni)
cDtDemIni			:= cPeriodo//cPeriodo+"01" --william 02/07/15
//cDtDemIni			:= '01/04/'+substr(cPeriodo,1,4)


//CARREVA VERBAS DE BAIXA
AADD(aVbBaixa,"905") //905 - BX PROV FERIAS
AADD(aVbBaixa,"906") //906 - BX MEDIA FERIAS
AADD(aVbBaixa,"907") //907 - BX 1/3 FERIAS
AADD(aVbBaixa,"908") //908 - BX PROV INSS FERIAS
AADD(aVbBaixa,"909") //909 - BX PROV FGTS FERIAS
AADD(aVbBaixa,"938") //938 - BX PROV PIS FERIAS

AADD(aVbBaixa,"915") //915 - BX PROV FERIAS RESC.
AADD(aVbBaixa,"916") //916 - BX PROV ADC FER RESC.
AADD(aVbBaixa,"917") //917 - BX PROV 1/3 FER RESC.
AADD(aVbBaixa,"918") //918 - BX PROV INSS FER RESC.
AADD(aVbBaixa,"919") //919 - BX PROV FGTS FER RESC.
AADD(aVbBaixa,"940") //940 - BX PROV PIS FERIAS RESC.

AADD(aVbBaixa,"922") //922 - BX PROV 13O.
AADD(aVbBaixa,"923") //923 - BX PROV ADC. 13O.
AADD(aVbBaixa,"924") //924 - BX PROV ANTECIPO 1O. PARCELA 13O.
AADD(aVbBaixa,"925") //925 - BX PROV INSS 13O.
AADD(aVbBaixa,"926") //926 - BX PROV FGTS 13O.
AADD(aVbBaixa,"942") //942 - BX PROV PIS 13O.

AADD(aVbBaixa,"933") //933 - BX PROV 13O. RESCISAO
AADD(aVbBaixa,"934") //934 - BX PROV ADC 13O. RESCISAO
AADD(aVbBaixa,"935") //935 - BX PROV INSS 13O. RESCISAO
AADD(aVbBaixa,"936") //936 - BX PROV FGTS 13O. RESCISAO
AADD(aVbBaixa,"944") //944 - BX PROV PIS 13O. RESCISAO

//---------------------------------
//
//--------------------------------------------------

cTabComp := Iif( Empty( AllTrim( cTabComp ) ), Space( TamSX3("RCB_CODIGO")[1] ), cTabComp )
cTabEmp  := Iif( Empty( AllTrim( cTabEmp  ) ), Space( TamSX3("RCB_CODIGO")[1] ), cTabEmp  )

GPE02Val(cTabComp,@cDescComp,, .F.)
GPE02Val(cTabEmp ,@cDescEmp ,, .F.)

DbSelectArea( "ZD6" )
DbSetOrder( 1 )

//---------------------------------
//
//--------------------------------------------------

For nL := 2000 To Year( dDataBase )

   Aadd( aAnoBase, Str( nL, 4 ) )

Next

Aadd( aMesBase, "Janeiro"   )
Aadd( aMesBase, "Fevereiro" )
Aadd( aMesBase, "Março"     )
Aadd( aMesBase, "Abril"     )
Aadd( aMesBase, "Maio"      )
Aadd( aMesBase, "Junho"     )
Aadd( aMesBase, "Julho"     )
Aadd( aMesBase, "Agosto"    )
Aadd( aMesBase, "Setembro"  )
Aadd( aMesBase, "Outubro"   )
Aadd( aMesBase, "Novembro"  )
Aadd( aMesBase, "Dezembro"  )

cMesBase := aMesBase[ VAL(SUBSTR(cPERIODO,5,2))] //aMesBase[ Month( dDataBase ) ]

//---------------------------------
// Painel 1
//--------------------------------------------------

DEFINE WIZARD oWizard TITLE cTitle HEADER cTitle MESSAGE "Rateio de Verba por Percentual de Horas Alocadas" PANEL NEXT {|| GPE02Ok( lFolha .And. lFerias .And. l13Salario .And. ExistCpo( "RCB", cTabComp, 1 ) .And. ExistCpo( "RCB", cTabEmp, 1 ) ) } FINISH {|| .T. }

ogr01 := TGroup():New( 005, 005, 060, 295, "Competência"     , oWizard:oMPanel[1],,,.T.,.T.,, .T.)
ogr02 := TGroup():New( 063, 005, 107, 100, "Rateio de Verbas", oWizard:oMPanel[1],,,.T.,.T.,, .T.)
ogr02 := TGroup():New( 063, 105, 107, 295, "Tabelas"         , oWizard:oMPanel[1],,,.T.,.T.,, .T.)
ogr03 := TGroup():New( 110, 005, 135, 295, "Log de Acesso"   , oWizard:oMPanel[1],,,.T.,.T.,, .T.)

@ 012,010 Say "Mês:"                                                                               Of oWizard:oMPanel[1] Pixel
@ 020,010 ComboBox oMesBase   Var cMesBase   When .f.  Items aMesBase                 Size 100, 36 Of oWizard:oMPanel[1] Pixel

@ 035,010 Say "Ano:"                                                                               Of oWizard:oMPanel[1] Pixel
@ 043,010 ComboBox oAnoBase   Var cAnoBase   When .f.  Items aAnoBase                 Size 070, 36 Of oWizard:oMPanel[1] Pixel

@ 073,010 CheckBox oFolha     Var lFolha     Prompt "Folha de Pagamento"              Size 140, 08 Of oWizard:oMPanel[1] Pixel
@ 085,010 CheckBox o13Salario Var lFerias    Prompt "Provisão de Férias"              Size 140, 08 Of oWizard:oMPanel[1] Pixel
@ 097,010 CheckBox oFerias    Var l13Salario Prompt "Provisão de 13º Salário"         Size 140, 08 Of oWizard:oMPanel[1] Pixel

@ 075,110 Say "Percentuais:"                                                                       Of oWizard:oMPanel[1] Pixel
@ 073,145 MsGet oTabComp      Var cTabComp   F3 "RCB"                                 Size 040, 07 Of oWizard:oMPanel[1] Pixel Valid GPE02Val(cTabComp,@cDescComp,oDescComp)
@ 073,190 MsGet oDescComp     Var cDescComp  When .f.                                 Size 100, 07 Of oWizard:oMPanel[1] Pixel

@ 090,110 Say "Empresas:"                                                                          Of oWizard:oMPanel[1] Pixel
@ 088,145 MsGet oTabEmp       Var cTabEmp    F3 "RCB"                                 Size 040, 07 Of oWizard:oMPanel[1] Pixel Valid ( cTabEmp # cTabComp ) .And. GPE02Val(cTabEmp,@cDescEmp,oDescEmp)
@ 088,190 MsGet oDescEmp      Var cDescEmp   When .f.                                 Size 100, 07 Of oWizard:oMPanel[1] Pixel

@ 120,010 MsGet oUsrRat       Var cUsrRat    When .F.		                             Size 150, 07 Of oWizard:oMPanel[1] Pixel
@ 120,185 MsGet oDataRat      Var dDataRat   When .F.                        		     Size 050, 07 Of oWizard:oMPanel[1] Pixel
@ 120,255 MsGet oHoraRat      Var cHoraRat   When .F.	                          	     Size 025, 07 Of oWizard:oMPanel[1] Pixel


//---------------------------------
// Painel 2
//--------------------------------------------------

CREATE PANEL oWizard HEADER cTitle MESSAGE "Processamento: Gravando Rateio de Verbas por Percentual de Horas Alocadas.";
PANEL BACK {|| .F. } NEXT {|| .T. } FINISH {|| .T.} EXEC {|| .T. }

@ 007,100 Say "Gravação de Rateio de Verbas - Projeto...	  	"       Of oWizard:oMPanel[2] Pixel
@ 047,110 Say "Gravação de Rateio de Verbas - Compartilhada...	"       Of oWizard:oMPanel[2] Pixel
@ 087,100 Say "Gravação de Rateio de Verbas - Condomínio...		"       Of oWizard:oMPanel[2] Pixel

oTermGr1  := tMeter():New( 015, 010, { |u| Iif(Pcount()>0, nTermGr1 :=u,nTermGr1 )}, 100, oWizard:oMPanel[2], 285, 30,,.T.)
oTermGr2  := tMeter():New( 055, 010, { |u| Iif(Pcount()>0, nTermGr2 :=u,nTermGr2 )}, 100, oWizard:oMPanel[2], 285, 30,,.T.)
oTermGr3  := tMeter():New( 095, 010, { |u| Iif(Pcount()>0, nTermGr3 :=u,nTermGr3 )}, 100, oWizard:oMPanel[2], 285, 30,,.T.)

//---------------------------------
//
//--------------------------------------------------

oWizard:oCancel:bAction	:= {|| Iif( GPE02Rat( "C" ), ::End(), (lMsgFim := .T.) ) }
oWizard:oFinish:bAction	:= {|| Iif( GPE02Rat( "F" ), ::End(), .F. ) }

oWizard:oFinish:cCaption := "&Processar"
oWizard:oFinish:cTitle   := "&Processar"


ACTIVATE WIZARD oWizard CENTERED VALID {|| GPE02Rat( "X" ) }

Return Nil

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ GPE02Ok   ºAutor  ³Microsiga          º Data ³  01/05/14   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Validação das Informações para Cálculo                     º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ P11 - SISTEMA INDUSTRIA                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

Static Function GPE02Ok( lSelecao )

If !lSelecao
	Alert( "Favor selecionar um ou mais tipo de Verba para Rateio!" )
EndIf

Return lSelecao


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ GPE02Val  ºAutor  ³Microsiga          º Data ³  01/05/14   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Validacao do fechamento do Wizard                          º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ P11 - SISTEMA INDUSTRIA                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function GPE02Val(cTabela,cDesc,oDesc, lObj)

Local lRet := .T.

Default lObj := .T.

dbSelectArea("RCB")
dbSetOrder( 1 )

If lRet := RCB->( dbSeek( xFilial("RCB")+cTabela ) )

	cDesc := RCB->RCB_DESC

	If lObj
		oDesc:Refresh()
	EndIf
Else

	If lObj
		Help(" ",1,"REGNOIS")
	EndIf
EndIf

Return lRet

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ GPE02Rat  ºAutor  ³Microsiga          º Data ³  01/05/14   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Validacao do fechamento do Wizard                          º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ P11 - SISTEMA INDUSTRIA                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function GPE02Rat(cBtnFim)

Local    lRet    := .F.

If cBtnFim == "F"  //-- Botao Finalizar

	lRet      := .T.
	lMsgFim   := .F.
	lVolGPE02 := .F.

	GPE02Grv()

ElseIf cBtnFim == "C"  //-- Botao Cancelar

	lRet    := MsgYesNo("Confirma o Encerramento?")

	lMsgFim := .F.

EndIf

If lMsgFim

	lRet := MsgYesNo("Confirma o Encerramento?")

Else

	If cBtnFim == "X"

		lRet := .T.

	EndIf
 EndIf

Return lRet


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ GPE02Grv  ºAutor  ³Microsiga          º Data ³  01/05/14   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Gravação da Importação de Base de Horas                    º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ P11 - SISTEMA INDUSTRIA                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

Static Function GPE02Grv()

Local cMes       := StrZero( oMesBase:nAt, 2 )
Local cAno       := cAnoBase
Local cQuery     := ""
Local cAliasQr1  := GetNextAlias()
Local cAliasQr2  := GetNextAlias()
Local cAliasQr3  := GetNextAlias()
Local aAreaAtu   := GetArea()
Local nReg       := 0
Local nTotalReg  := 0
Local cTipoFol   := ""
Local aCompart   := {}
Local aEmpComp   := {}
Local aTamanhos  := {}
Local nTamanho   := 0
Local nVezes     := 0
Local nItem      := 0
Local cDT_IMPRAT := SuperGetMV("DT_IMPRAT")
Local nSizeCTT   := 4
Local nSizeCTD   := 4
Local nSizeItem  := TamSx3( "ZD7_ITEM" )[1] 
Local cCampoOri	 := ""          
Local nValAux	 := 0                          
Local nVTotal	 := 0
Local nA		 := 0 
Local aRatProj	 := {}
Local nTotRat	 := 0 
Local nDifRat	 := 0
Local cEmpAtu	 := ''
Local cVerAtu	 := ''
Local cTpProvAtu	:= ''
Local cTpCalcAtu 	:= '' 
Local cVerbaSeq		:= ' '
Local nPercTot		:= 0
Local _nValVrb		:= 0
Local _lDemMSeg		:= .F.
Local _lEstProvEnc	:= .F. //Variavel de controle de estorno de provisao de encargos para Gestao compartilhada
Local _cCtaLct		:= ''
Local _cTpLct		:= ''
Local _nValVrbAux	:= 0
Public aPercent		:= {}
Public aVlrDifCont	:= {} //array que conterá o valor das contribuicoes de ferias e 13.


PutMv( "DT_TBPERC", cTabComp )
PutMv( "DT_TBEMP" , cTabEmp  )

//----------------------------------------------
//
//-------------------------------------------------------------------

dbSelectArea("ZD7")
dbSetOrder( 1 )

dbSelectArea("RCB")
dbSetOrder( 1 )

dbSelectArea("RCC")
dbSetOrder( 1 )

If RCB->( dbSeek( xFilial("RCB")+cTabComp ) ) .And. RCC->( dbSeek( xFilial("RCC")+cTabComp ) )

	//--- Percentuais

	nTamanho := RCB->RCB_TAMAN

	While RCB->RCB_CODIGO == cTabComp .And. !RCB->( Eof() )

		nVezes += 1

		RCB->( dbSkip() )

	End

	aCompart := Array( nVezes )

	While RCC->RCC_CODIGO == cTabComp .And.  !RCC->( Eof() )

		If RCC->RCC_CHAVE == ( cAno + cMes )

			nItem := 1

			For nI := 1 To nVezes

				aCompart[nI] := Val( SubStr( RCC->RCC_CONTEU, nItem, nTamanho ) )

         	nItem += nTamanho

			Next

		EndIf

		RCC->( dbSkip() )

   End

	//--- Empresas

	If RCB->( dbSeek( xFilial("RCB")+cTabEmp ) ) .And. RCC->( dbSeek( xFilial("RCC")+cTabEmp ) )

		While RCB->RCB_CODIGO == cTabEmp .And. !RCB->( Eof() )

		   Aadd( aTamanhos, RCB->RCB_TAMAN )

			RCB->( dbSkip() )

		End

		While RCC->RCC_CODIGO == cTabEmp .And. !RCC->( Eof() )

			nItem := 1

			Aadd( aEmpComp, Array( Len(aTamanhos) ) )

			For nI := 1 To Len( aTamanhos )

				aEmpComp[Len(aEmpComp)][nI] := SubStr( RCC->RCC_CONTEU, nItem, aTamanhos[nI] )

         	nItem += aTamanhos[nI]

			Next

			RCC->( dbSkip() )
	   End
	EndIf
EndIf

//----------------------------------------------
// Rateio Modelo II - Projeto
//-------------------------------------------------------------------

U_PERCONTR()//CARREGA PERCENTUAIS DE CONTRIBUIÇÃO
U_CARGACONT()//GERA ARRAY COM VALOR DAS CONTRIBUIÇÕES QUANDO FERIAS E 13

U_DTGPE02Del() //DELETA TODA A ZD7 PARA REGRAVAR.

cQuery :=        " Select SRA.RA_FILIAL FILIAL, SRA.RA_SITFOLH SITUAC, ZD61.ZD6_MESANO, SUBSTR(ZD61.ZD6_FILIMP, 1, 4) FILIMP, ZD61.ZD6_MAT, ZD61.ZD6_CC, ZD61.ZD6_ITEM, ZD61.ZD6_PERCEN, SRC.RC_PD VERBA, SRC.RC_VALOR VALOR,SRC.RC_SEQ SEQ, '' TIPOPROV, '1' Tabela, SRC.RC_TIPO2 TIPO2,SRV.RV_XCTADEB DEB,SRV.RV_XCTACRD CRE,SRV.RV_XRATEIO RAT"
cQuery += CRLF + "   From " + RetSqlName("ZD6") + " ZD61"
cQuery += CRLF + "  Inner Join " + RetSqlName("SRA") + " SRA On SRA.D_E_L_E_T_ = ' ' And SRA.RA_MAT = ZD61.ZD6_MAT And (SRA.RA_DEMISSA = ' ' OR (SELECT MAX(RG_DATAHOM) FROM "+RetSqlName("SRG")+" WHERE D_E_L_E_T_ <> '*') >= '"+cDtDemIni+"') And SRA.RA_XTPRAT = '2' And SubStr( SRA.RA_FILIAL, 1, " + Str( nSizeCTT, 2 ) + ") = SubStr( ZD61.ZD6_FILIMP, 1, "      + Str( nSizeCTT, 2 ) + ")"
cQuery += CRLF + "  Inner Join " + cTabMov + " SRC On SRC.D_E_L_E_T_ = ' ' And SRC.RC_MAT = ZD61.ZD6_MAT And SubStr( SRC.RC_FILIAL, 1, "     + Str( nSizeCTT, 2 ) + ") = SubStr( ZD61.ZD6_FILIMP, 1, " + Str( nSizeCTT, 2 ) + ") AND SRC.RC_MAT = SRA.RA_MAT AND SRC.RC_FILIAL = SRA.RA_FILIAL"
cQuery += CRLF + "  Inner Join " + RetSqlName("SRV") + " SRV On SRV.D_E_L_E_T_ = ' ' And SRV.RV_FILIAL = '" + xFilial( "SRV" ) + "' And SRV.RV_COD = SRC.RC_PD And SRV.RV_XRATEIO <> 'N'"

cQuery += CRLF + "  Where ZD61.D_E_L_E_T_ = ' ' " //AND SRA.RA_FILIAL = '02MT0001' AND SRA.RA_MAT IN ('000003') 
cQuery += CRLF + "  AND SRA.RA_CATFUNC NOT IN ('A') AND SUBSTR(SRA.RA_FILIAL,1,4) = SUBSTR(ZD61.ZD6_FILIMP,1,4)" 
cQuery += CRLF + "  AND ZD61.ZD6_FILIMP||ZD61.ZD6_MAT||ZD61.ZD6_MESANO IN (SELECT ZD63.ZD6_FILIMP||ZD63.ZD6_MAT||MAX(ZD63.ZD6_MESANO) FROM "+RetSqlName("ZD6")+" ZD63 WHERE ZD63.ZD6_PERCEN > 0 AND ZD63.ZD6_MESANO <= '"+ cAno + cMes +"' AND ZD63.D_E_L_E_T_ <> '*' GROUP BY ZD63.ZD6_FILIMP,ZD63.ZD6_MAT)"
IF CMES = "12"
	cQuery += CRLF + "  Union "
	//13 SALARIO
	cQuery +=        " Select SRA.RA_FILIAL FILIAL, SRA.RA_SITFOLH SITUAC, ZD61.ZD6_MESANO, SUBSTR(ZD61.ZD6_FILIMP, 1, 4) FILIMP, ZD61.ZD6_MAT, ZD61.ZD6_CC, ZD61.ZD6_ITEM, ZD61.ZD6_PERCEN, SRI.RI_PD VERBA, SRI.RI_VALOR VALOR,' ' SEQ, '' TIPOPROV, '3' Tabela, SRI.RI_TIPO2 TIPO2,SRV.RV_XCTADEB DEB,SRV.RV_XCTACRD CRE,SRV.RV_XRATEIO RAT"
	cQuery += CRLF + "   From " + RetSqlName("ZD6") + " ZD61"
	cQuery += CRLF + "  Inner Join " + RetSqlName("SRA") + " SRA On SRA.D_E_L_E_T_ = ' ' And SRA.RA_MAT = ZD61.ZD6_MAT And (SRA.RA_DEMISSA = ' ' OR (SELECT MAX(RG_DATAHOM) FROM "+RetSqlName("SRG")+" WHERE D_E_L_E_T_ <> '*') >= '"+cDtDemIni+"') And SRA.RA_XTPRAT = '2' And SubStr( SRA.RA_FILIAL, 1, " + Str( nSizeCTT, 2 ) + ") = SubStr( ZD61.ZD6_FILIMP, 1, "      + Str( nSizeCTT, 2 ) + ")"
	cQuery += CRLF + "  Inner Join " + cTabMovRI + " SRI On SRI.D_E_L_E_T_ = ' ' And SRI.RI_MAT = ZD61.ZD6_MAT And SubStr( SRI.RI_FILIAL, 1, "     + Str( nSizeCTT, 2 ) + ") = SubStr( ZD61.ZD6_FILIMP, 1, " + Str( nSizeCTT, 2 ) + ") AND SRI.RI_MAT = SRA.RA_MAT AND SRI.RI_FILIAL = SRA.RA_FILIAL"
	cQuery += CRLF + "  Inner Join " + RetSqlName("SRV") + " SRV On SRV.D_E_L_E_T_ = ' ' And SRV.RV_FILIAL = '" + xFilial( "SRV" ) + "' And SRV.RV_COD = SRI.RI_PD And SRV.RV_XRATEIO <> 'N'"
	
	cQuery += CRLF + "  Where ZD61.D_E_L_E_T_ = ' '" 
	cQuery += CRLF + "  AND SRA.RA_CATFUNC NOT IN ('A') AND SUBSTR(SRA.RA_FILIAL,1,4) = SUBSTR(ZD61.ZD6_FILIMP,1,4)" // AND SRA.RA_FILIAL = '02MT0001' AND SRA.RA_MAT IN ('000003')"  
	cQuery += CRLF + "  AND ZD61.ZD6_FILIMP||ZD61.ZD6_MAT||ZD61.ZD6_MESANO IN (SELECT ZD63.ZD6_FILIMP||ZD63.ZD6_MAT||MAX(ZD63.ZD6_MESANO) FROM "+RetSqlName("ZD6")+" ZD63 WHERE ZD63.ZD6_PERCEN > 0 AND ZD63.ZD6_MESANO <= '"+ cAno + cMes +"' AND ZD63.D_E_L_E_T_ <> '*' GROUP BY ZD63.ZD6_FILIMP,ZD63.ZD6_MAT)"
ENDIF
cQuery += CRLF + "  Union "
//PROVISAO
cQuery += CRLF + " Select SRA.RA_FILIAL FILIAL, SRA.RA_SITFOLH SITUAC, ZD62.ZD6_MESANO,SUBSTR(ZD62.ZD6_FILIMP, 1, 4) FILIMP, ZD62.ZD6_MAT, ZD62.ZD6_CC, ZD62.ZD6_ITEM, ZD62.ZD6_PERCEN, SRT.RT_VERBA VERBA, SRT.RT_XVALMES VALOR,' 'SEQ, SRT.RT_TIPPROV TIPOPROV, '2' TABELA, '' TIPO2,SRV.RV_XCTADEB DEB,SRV.RV_XCTACRD CRE,SRV.RV_XRATEIO RAT"

cQuery += CRLF + "   From " + RetSqlName("ZD6") + " ZD62"

cQuery += CRLF + "  Inner Join " + RetSqlName("SRA") + " SRA On SRA.D_E_L_E_T_ = ' ' And SRA.RA_MAT = ZD62.ZD6_MAT And (SRA.RA_DEMISSA = ' ' OR (SELECT MAX(RG_DATAHOM) FROM "+RetSqlName("SRG")+" WHERE D_E_L_E_T_ <> '*') >= '"+cDtDemIni+"') And SRA.RA_XTPRAT = '2' And SubStr( SRA.RA_FILIAL, 1, " + Str( nSizeCTT, 2 ) + ") = SubStr( ZD62.ZD6_FILIMP, 1, " + Str( nSizeCTT, 2 ) + ")"
cQuery += CRLF + "  Inner Join " + RetSqlName("SRT") + " SRT On SRT.D_E_L_E_T_ = ' ' And SRT.RT_MAT = ZD62.ZD6_MAT And SubStr( SRT.RT_DATACAL , 1, 6 ) = '" + cAno + cMes + "' And SubStr( SRT.RT_FILIAL, 1, " + Str( nSizeCTT, 2 ) + ") = SubStr( ZD62.ZD6_FILIMP, 1, " + Str( nSizeCTT, 2 ) + ") AND SRT.RT_MAT = SRA.RA_MAT AND SRT.RT_FILIAL = SRA.RA_FILIAL "
cQuery += CRLF + "  Inner Join " + RetSqlName("SRV") + " SRV On SRV.D_E_L_E_T_ = ' ' And SRV.RV_FILIAL = '" + xFilial( "SRV" ) + "' And SRV.RV_COD = SRT.RT_VERBA And SRV.RV_XRATEIO <> 'N'"

//cQuery += CRLF + "  Where ZD62.D_E_L_E_T_ = ' ' AND SRT.RT_XVALMES > 0" | william - 08/12/2015 - Retirado para contabilizar o ajuste de provisao
cQuery += CRLF + "  Where ZD62.D_E_L_E_T_ = ' ' "
cQuery += CRLF + "  AND SRA.RA_CATFUNC NOT IN ('A') AND SUBSTR(SRA.RA_FILIAL,1,4) = SUBSTR(ZD62.ZD6_FILIMP,1,4) "//AND SRA.RA_FILIAL = '02MT0001'AND SRA.RA_MAT IN ('000003')" 
cQuery += CRLF + " AND ZD62.ZD6_FILIMP||ZD62.ZD6_MAT||ZD62.ZD6_MESANO IN (SELECT ZD64.ZD6_FILIMP||ZD64.ZD6_MAT||MAX(ZD64.ZD6_MESANO) FROM "+RetSqlName("ZD6")+" ZD64 WHERE ZD64.ZD6_PERCEN > 0 AND ZD64.ZD6_MESANO <= '"+ cAno + cMes +"' AND ZD64.D_E_L_E_T_ <> '*' GROUP BY ZD64.ZD6_FILIMP,ZD64.ZD6_MAT) "
//cQuery += CRLF + " AND ZD62.ZD6_FILIAL||ZD62.ZD6_MAT||ZD62.ZD6_MESANO IN (SELECT ZD6_FILIAL||ZD6_MAT||MAX(ZD6_MESANO) FROM "+RetSqlName("ZD6")+" WHERE ZD6_PERCEN > 0 GROUP BY ZD6_FILIAL,ZD6_MAT) "
cQuery += CRLF + " AND SRT.RT_DATACAL = '"+cDataProv+"'"

cQuery += CRLF + "  Order By TABELA, TIPOPROV, SEQ, VERBA, TIPO2,ZD6_MAT, ZD6_CC, ZD6_ITEM"

//cQuery := ChangeQuery( cQuery )

dbUseArea( .T., "TOPCONN", TcGenQry(,,cQuery), cAliasQr1, .T., .T. )

TcSetField( cAliasQr1, "ZD6_PERCEN", "N", TamSX3("ZD6_PERCEN")[1], TamSX3("ZD6_PERCEN")[2] )
TcSetField( cAliasQr1, "VALOR"     , "N", TamSX3("RC_VALOR"  )[1], TamSX3("RC_VALOR"  )[2] )

( cAliasQr1 )->( dbEval( { || nTotalReg++ },, { || !EOF() } ) )

( cAliasQr1 )->(dbGotop())

cEmpAtu	:= ( cAliasQr1 )->(ZD6_MAT)
cVerAtu := ( cAliasQr1 )->VERBA
cFilAtu := ( cAliasQr1 )->(FILIAL)
cTpProvAtu := ( cAliasQr1 ) -> TIPOPROV
cTpCalcAtu := ( cAliasQr1 ) -> TIPO2
While ( cAliasQr1 )->( !Eof() )

	IF ( cAliasQr1 )->VALOR = 0
		( cAliasQr1 )->( dbSkip() )
		Loop	
	EndIf
	
	_lDemMSeg := U_RetDtDem(cEmpAtu,cFilAtu) //-- Verifica se a data de demissão é do periodo de rateio ou próximo periodo.
    
	nReg += 1
	
	//------------------------------------------------------------------
	//AJUSTE DE VERBAS DE CONTRIBUICAO
	//------------------------------------------------------------------
	
	_nValVrb 	:= ( cAliasQr1 )->( VALOR )
	_nValVrbAux := ( cAliasQr1 )->( VALOR )
		
	//CONTROLE DE CONTRIBUICAO
	If ( cAliasQr1 )->( VERBA) $ ('702,703,704,727,728,733,750')
			
		//RESTA FERIAS
		IF (( cAliasQr1 )->( VERBA) <> '727' .AND. ( cAliasQr1)->( VERBA) <> '733')
			_nPos := ASCAN(aVlrDifCont ,{|x| X[1]  == ( cAliasQr1 )->(FILIAL) .AND. X[2] == ( cAliasQr1 )->(ZD6_MAT) .AND. X[3] == '967'})
		ELSE
			_nPos := ASCAN(aVlrDifCont ,{|x| X[1]  == ( cAliasQr1 )->(FILIAL) .AND. X[2] == ( cAliasQr1 )->(ZD6_MAT) .AND. X[3] == '968'})
		ENDIF
					
		If _nPos > 0
			If ( cAliasQr1 )->( VERBA ) $ ('702') .And. ( cAliasQr1 )->( TIPO2 ) <> 'S' //-- INSS
				_nValVrb := (_nValVrb - aVlrDifCont[_nPos][4]) 
			EndIf
			If ( cAliasQr1 )->( VERBA) $ ('703') .And. ( cAliasQr1 )->( TIPO2 ) <> 'S' //-- TERCEIROS
				_nValVrb := (_nValVrb - aVlrDifCont[_nPos][5]) 
			EndIf
			If ( cAliasQr1 )->( VERBA) $ ('704') .And. ( cAliasQr1 )->( TIPO2 ) <> 'S' //-- ACID.TRAB
				_nValVrb := (_nValVrb - aVlrDifCont[_nPos][6]) 
			EndIf			
			If ( cAliasQr1 )->( VERBA) $ ('727,733') //-- FGTS
				_nValVrb := (_nValVrb - aVlrDifCont[_nPos][7]) 
			EndIf
			If ( cAliasQr1 )->( VERBA) $ ('750') .And. ( cAliasQr1 )->( TIPO2 ) <> 'S' //-- PIS
				_nValVrb := (_nValVrb - aVlrDifCont[_nPos][8]) 
			EndIf				
		EndIf
		
		//RESTA 13o. SALARIO
		IF (( cAliasQr1 )->( VERBA) <> '728' .AND. ( cAliasQr1 )->( VERBA) <> '733')
			_nPos := ASCAN(aVlrDifCont ,{|x| X[1]  == ( cAliasQr1 )->(FILIAL) .AND. X[2] == ( cAliasQr1 )->(ZD6_MAT) .AND. X[3] == '969'})
		ELSE
			_nPos := ASCAN(aVlrDifCont ,{|x| X[1]  == ( cAliasQr1 )->(FILIAL) .AND. X[2] == ( cAliasQr1 )->(ZD6_MAT) .AND. X[3] == '970'})
		ENDIF
			
		If _nPos > 0
			If ( cAliasQr1 )->( VERBA) $ ('702') .And. ( cAliasQr1 )->( TIPO2 ) <> 'S' //-- INSS
				_nValVrb := (_nValVrb - aVlrDifCont[_nPos][4]) 
			EndIf
			If ( cAliasQr1 )->( VERBA) $ ('703') .And. ( cAliasQr1 )->( TIPO2 ) <> 'S' //-- TERCEIROS
				_nValVrb := (_nValVrb - aVlrDifCont[_nPos][5]) 
			EndIf
			If ( cAliasQr1 )->( VERBA) $ ('704') .And. ( cAliasQr1 )->( TIPO2 ) <> 'S' //-- ACID.TRAB
				_nValVrb := (_nValVrb - aVlrDifCont[_nPos][6]) 
			EndIf			
			If ( cAliasQr1 )->( VERBA) $ ('728,733') //-- FGTS
				_nValVrb := (_nValVrb - aVlrDifCont[_nPos][7]) 
			EndIf
			If ( cAliasQr1 )->( VERBA) $ ('750') .And. ( cAliasQr1 )->( TIPO2 ) <> 'S' //-- PIS
				_nValVrb := (_nValVrb - aVlrDifCont[_nPos][8]) 
			EndIf				
		EndIf
	EndIf 
	
	//----------------------------------------------//
	//13/02/2015  - william                         //
	//foi inserida a validação LEN(aRATPROJ)>0      //
	//Para complementar a validação do SEQ <> ''    //
	//que permitia o ingresso da verba sem rateio	//
	//----------------------------------------------//
	
	If (cEmpAtu == ( cAliasQr1 )->(ZD6_MAT) .AND. cVerAtu <> ( cAliasQr1 )->VERBA .AND. LEN(ARATPROJ) > 0) .OR.;  
  		(cEmpAtu == ( cAliasQr1 )->(ZD6_MAT) .AND. cVerAtu == ( cAliasQr1 )->VERBA .AND. ( cAliasQr1 )->( RAT ) == 'I' .AND. cVerbaInt = cVerAtu .AND. LEN(ARATPROJ) > 0) .OR.;
	   (cEmpAtu <> ( cAliasQr1 )->(ZD6_MAT) .AND. LEN(ARATPROJ) > 0)  .OR.;
	   (cEmpAtu == ( cAliasQr1 )->(ZD6_MAT) .AND. cFilAtu <> ( cAliasQr1 )->(FILIAL) .AND. LEN(ARATPROJ) > 0) .OR.;
	   (cEmpAtu == ( cAliasQr1 )->(ZD6_MAT) .AND. AllTrim(( cAliasQr1 )->( SEQ )) <> '' .AND. LEN(ARATPROJ) > 0 .AND. ( cAliasQr1 )->( SEQ ) > cVerbaSeq ) .OR.;
	   (cTpProvAtu <> ( cAliasQr1 ) -> TIPOPROV .AND. LEN(ARATPROJ) > 0 ) .OR.;
	   (cTpCalcAtu <> ( cAliasQr1 ) -> TIPO2 .AND. LEN(ARATPROJ) > 0)
		
				
		If len(aRatProj) = 0
			nJ := 0
		EndIf
		
		//If Len(aRatProj) = 0
			nDifRat := aRatProj[1][8] - nTotRat
			
			If nDifRat <> 0
				ASORT(aRatProj,,,{|x,y| x[10] < y[10]})
				For nx := 1 to 2
					aRatProj[nX][10] := aRatProj[nX][10] + nDifRat
				Next		
			EndIf       
			
			
			For nX := 1 to Len(aRatProj)
				
				RecLock("ZD7", .t. )   
				
				ZD7->ZD7_FILIAL := aRatProj[nX][1]
				ZD7->ZD7_MESANO := aRatProj[nX][2]
				ZD7->ZD7_TIPFOL := aRatProj[nX][3]
				ZD7->ZD7_MAT    := aRatProj[nX][4]
				ZD7->ZD7_CC     := aRatProj[nX][5]
				ZD7->ZD7_ITEM	:= aRatProj[nX][6]
				ZD7->ZD7_VERBA  := aRatProj[nX][7]
				ZD7->ZD7_VALOR  := aRatProj[nX][8]
				ZD7->ZD7_PERC   := aRatProj[nX][9]
				ZD7->ZD7_VALRAT := aRatProj[nX][10]
				ZD7->ZD7_FILRAT := aRatProj[nX][11]
				ZD7->ZD7_TPRAT	:= aRatProj[nX][12]
				ZD7->ZD7_USRRAT := aRatProj[nX][13]
				ZD7->ZD7_DATRAT := aRatProj[nX][14]
				ZD7->ZD7_HORRAT := aRatProj[nX][15]
				ZD7->zd7_ORIGEM	:= aRatProj[nX][16]
				IF aRatProj[nX][18] == "D"                 
					ZD7->ZD7_CTADEB := aRatProj[nX][17]
				ELSE
					ZD7->ZD7_CTACRE := aRatProj[nX][17]
				ENDIF
			
				ZD7->( MsUnLock() )
			Next
		//EndIf
		        
		aRatProj:={}                              
		nDifRat := 0
		nTotRat := 0
		nPercTot := 0
		
		
	EndIf
	
	/*IF ( cAliasQr1 )->(ZD6_MAT) = '000072' .AND. ( cAliasQr1 )->(VERBA)='446'
	   MsgAlert("Achou")
	End*/
	
   //-- 1=Folha;2=Provisao 13º Salario;3=Provisao Ferias,4=1ª Parcela,5=2ª Parcela,6=Férias,7=Rescisão
   
   //----------------------------------------------------------------|
   //
   //13/02/2015 - WILLIAM                                            |
   //Retirado da validação do tipo de folha 7 a                      |
   //seguinte condição '(( cAliasQr1 )->( TIPO2 ) $ "I/G/R" .AND.'   |
   //para que independente o tipo de verba esteja no calculo         |
   //de rescisao, irá tomá-lo como calculo de rescisao.              |
   //                                                                |
   //---------------------------------------------------------------//     
   
	If !Empty( ( cAliasQr1 )->( TIPOPROV ) )
		If ( cAliasQr1 )->( TIPOPROV ) $ "1/2"
			cTipoFol := "3"
		ElseIf ( cAliasQr1 )->( TIPOPROV ) $ "3/4"
			cTipoFol := "2"
		EndIf
	Else
		If (( cAliasQr1 )->( TIPO2 ) $ "I/G/E/C/V" .AND. (( cAliasQr1 )->( SITUAC ) <> 'D' .OR. (( cAliasQr1 )->( SITUAC ) == 'D' .AND. _lDemMSeg = .T.)) .AND. ( cAliasQr1 )->( TABELA ) == '1')
			cTipoFol := "1"
		ElseIf (( cAliasQr1 )->( TIPO2 ) $ "P" .AND. (( cAliasQr1 )->( SITUAC ) <> 'D' .OR. (( cAliasQr1 )->( SITUAC ) == 'D' .AND. _lDemMSeg = .T.)))
			cTipoFol := "4"
		ElseIf ((( cAliasQr1 )->( TIPO2 ) $ "S" .AND. (( cAliasQr1 )->( SITUAC ) <> 'D' .OR. (( cAliasQr1 )->( SITUAC ) == 'D' .AND. _lDemMSeg = .T.))) .OR. ( cAliasQr1 )->( TABELA ) == '3') 
			cTipoFol := "5"
		ElseIf (( cAliasQr1 )->( TIPO2 ) $ "K" .AND. (( cAliasQr1 )->( SITUAC ) <> 'D' .OR. (( cAliasQr1 )->( SITUAC ) == 'D' .AND. _lDemMSeg = .T.)))
			cTipoFol := "6"
		ElseIf ( cAliasQr1 )->( SITUAC ) == 'D' .AND. _lDemMSeg == .F.
			cTipoFol := "7"
	   EndIf
   EndIf

	/*If ( cAliasQr1 )->VERBA = '704'
		Alert('Achei')
	EndIf*/

   //--- ZD7_FILIAL+ZD7_MESANO+ZD7_TIPFOL+ZD7_MAT+ZD7_CC+ZD7_ITEM
	IF ( cVerbaInt <> ( cAliasQr1 )->( VERBA ) .OR.;
	   ( cVerbaInt == ( cAliasQr1 )->( VERBA ) .AND. AllTrim(( cAliasQr1 )->( SEQ )) <> '' .AND. ( cAliasQr1 )->( SEQ ) > cVerbaSeq ) .OR.; 
		( cVerbaInt == ( cAliasQr1 )->( VERBA ) .AND. cEmpAtu <> ( cAliasQr1 )->(ZD6_MAT)) .OR.;
		( cVerbaInt == ( cAliasQr1 )->( VERBA ) .AND. cEmpAtu == ( cAliasQr1 )->(ZD6_MAT) .AND. SUBSTR(cFilAtu,1,4) <> ( cAliasQr1 )->(FILIMP)))
			
		For nX := 1 to 2  //Este for garante a geração de dois registros DEB/CRED
			
		 	//Trata Campo Entidade Original
			If substr((cAliasQr1)->(FILIAL),1,2) == "01"
				cCampoOri := "091"
	   		ElseIf substr((cAliasQr1)->(FILIAL),1,2) == "02"
				cCampoOri := "088"
			ElseIf substr((cAliasQr1)->(FILIAL),1,2) == "03"
				cCampoOri := "089"
			ElseIf substr((cAliasQr1)->(FILIAL),1,2) == "04"
				cCampoOri := "090"		
			ElseIf substr((cAliasQr1)->(FILIAL),1,2) == "05"
				cCampoOri := "092"		
			EndIf 
			 
			//IF ( cAliasQr1 )->( RAT ) = 'R'
			
			//--------------------------------------------------|
			// Autor: William Santos - 09/12/2015               |
			// Desc: Bloco criado abaixo inicialmente para      |
			// realizar o estorno da provisão, situação que     |
			// ocorre quando o valor está negativo. Porém irá   |
			// abranger qualquer valor negativo.                |
			//--------------------------------------------------|
			IF _nValVrbAux > 0
				If nX = 1
					_cCtaLct	:= ( cAliasQr1 )->( DEB )
					_cTpLct		:= "D"
				Else
					_cCtaLct := ( cAliasQr1 )->( CRE )
					_cTpLct		:= "C"
				EndIf
			ELSE
				If nX = 1
					_nValVrb	:= _nValVrb * -1
					_cCtaLct	:= ( cAliasQr1 )->( CRE )
					_cTpLct		:= "D"
				Else
					_cCtaLct := ( cAliasQr1 )->( DEB )
					_cTpLct		:= "C"
				EndIf
			ENDIF
			
	
			AADD(aRatProj, {(cAliasQr1)->(FILIAL),;
							cAno + cMes,;
							cTipoFol,;
							( cAliasQr1 )->( ZD6_MAT),;
							( cAliasQr1 )->( ZD6_CC),;
							( cAliasQr1 )->( ZD6_ITEM),;
							( cAliasQr1 )->( VERBA),;
							_nValVrb,;
							IIF( ( cAliasQr1 )->( RAT ) = 'I',100,(cAliasQr1 )->( ZD6_PERCEN )),;
						   	IIF(( cAliasQr1 )->( RAT ) = 'I',_nValVrb, ROUND( _nValVrb *  (( cAliasQr1 )->( ZD6_PERCEN ) / 100), 2) ),;
							( cAliasQr1 )->( FILIAL),;
							"P",;
							cUsrRat,;
							dDataRat,;
							cHoraRat,;
							cCampoOri,;
							_cCtaLct,;
							_cTpLct})							
			
		Next 
		
   		nTotRat += 	IIF(( cAliasQr1 )->( RAT ) = 'I',_nValVrb, ROUND( _nValVrb *  (( cAliasQr1 )->( ZD6_PERCEN ) / 100), 2) )
   		nPercTot += ( cAliasQr1 )->( ZD6_PERCEN )
    	
    	IF ( cAliasQr1 )->( RAT ) = 'I'
        	cVerbaInt := ( cAliasQr1 )->( VERBA )
      Else
      	cVerbaInt := ''
    	EndIf                              
    	
    	
    	cEmpAtu		:= ( cAliasQr1 )->(ZD6_MAT)
    	cVerAtu 	:= ( cAliasQr1 )->VERBA 
    	cFilAtu 	:= ( cAliasQr1 )->(FILIAL)
    	cTpProvAtu 	:= ( cAliasQr1 )-> TIPOPROV
    	cTpCalcAtu 	:= ( cAliasQr1 )-> TIPO2  
    	cVerbaSeq	:= ( cAliasQr1 )-> SEQ
    	
   	EndIf

	oTermGr1:Set( Int( nReg * 100 / nTotalReg ) )

	( cAliasQr1 )->( dbSkip() )

End

oTermGr1:Set( 100 )
oTermGr1:Refresh()

( cAliasQr1 )->( dbCloseArea() )

//------------------------------------------------------
// Rateio Modelo I - Compartilhado
//---------------------------------------------------------------------------------

nTotalReg := 0
nReg      := 0

cQuery :=        " Select SRA.RA_MAT MATRICULA, SRA.RA_SITFOLH SITUAC, SRC.RC_PD VERBA, SRC.RC_VALOR VALOR, '' TIPOPROV, '1' Tabela, SRC.RC_TIPO2 TIPO2, RA_CC, RA_ITEM,RA_FILIAL,SRV.RV_XCTADEB DEB,SRV.RV_XCTACRD CRE,SRV.RV_XRATEIO RAT"

cQuery += CRLF + "   From " + cTabMov + " SRC"

cQuery += CRLF + "  Inner Join " + RetSqlName("SRA") + " SRA On SRA.D_E_L_E_T_ = ' ' And (SRA.RA_DEMISSA = ' ' OR (SELECT MAX(RG_DATAHOM) FROM "+RetSqlName("SRG")+" WHERE D_E_L_E_T_ <> '*') >= '"+cDtDemIni+"') And SRA.RA_MAT = SRC.RC_MAT And SRA.RA_XTPRAT  = '1' And SRA.RA_FILIAL = SRC.RC_FILIAL"
cQuery += CRLF + "  Inner Join " + RetSqlName("SRV") + " SRV On SRV.D_E_L_E_T_ = ' ' And SRV.RV_FILIAL = '" + xFilial( "SRV" ) + "' And SRV.RV_COD = SRC.RC_PD And SRV.RV_XRATEIO <> 'N'"

cQuery += CRLF + "  Where         SRC.D_E_L_E_T_      = ' ' "//AND SRA.RA_FILIAL = '12MT0012' AND SRA.RA_MAT IN ('004588')"
cQuery += CRLF + "    And SRC.RC_MAT = SRA.RA_MAT AND SRC.RC_FILIAL = SRA.RA_FILIAL"

IF CMES = '12'
	cQuery += CRLF + "  Union"
	//13 SALARIO
	cQuery +=        " Select SRA.RA_MAT MATRICULA, SRA.RA_SITFOLH SITUAC, SRI.RI_PD VERBA, SRI.RI_VALOR VALOR, '' TIPOPROV, '3' Tabela, SRI.RI_TIPO2 TIPO2, RA_CC, RA_ITEM,RA_FILIAL,SRV.RV_XCTADEB DEB,SRV.RV_XCTACRD CRE,SRV.RV_XRATEIO RAT"
	
	cQuery += CRLF + "   From " + cTabMovRI + " SRI"
	
	cQuery += CRLF + "  Inner Join " + RetSqlName("SRA") + " SRA On SRA.D_E_L_E_T_ = ' ' And (SRA.RA_DEMISSA = ' ' OR (SELECT MAX(RG_DATAHOM) FROM "+RetSqlName("SRG")+" WHERE D_E_L_E_T_ <> '*') >= '"+cDtDemIni+"') And SRA.RA_MAT = SRI.RI_MAT And SRA.RA_XTPRAT  = '1' And SRA.RA_FILIAL = SRI.RI_FILIAL"
	cQuery += CRLF + "  Inner Join " + RetSqlName("SRV") + " SRV On SRV.D_E_L_E_T_ = ' ' And SRV.RV_FILIAL = '" + xFilial( "SRV" ) + "' And SRV.RV_COD = SRI.RI_PD And SRV.RV_XRATEIO <> 'N'"
	
	cQuery += CRLF + "  Where         SRI.D_E_L_E_T_      = ' ' "
	cQuery += CRLF + "    And SRI.RI_MAT = SRA.RA_MAT AND SRI.RI_FILIAL = SRA.RA_FILIAL"
ENDIF

cQuery += CRLF + "  Union"
//PROVISAO

cQuery += CRLF + " Select SRA.RA_MAT MATRICULA, SRA.RA_SITFOLH SITUAC, SRT.RT_VERBA VERBA, SRT.RT_XVALMES VALOR, SRT.RT_TIPPROV TIPOPROV, '2' TABELA, '' TIPO2, RA_CC, RA_ITEM,RA_FILIAL,SRV.RV_XCTADEB DEB,SRV.RV_XCTACRD CRE,SRV.RV_XRATEIO RAT"

cQuery += CRLF + "   From " + RetSqlName("SRT") + " SRT"

cQuery += CRLF + "  Inner Join " + RetSqlName("SRA") + " SRA On SRA.D_E_L_E_T_ = ' ' And SRA.RA_MAT = SRT.RT_MAT And (SRA.RA_DEMISSA = ' ' OR (SELECT MAX(RG_DATAHOM) FROM "+RetSqlName("SRG")+" WHERE D_E_L_E_T_ <> '*') >= '"+cDtDemIni+"') And SRA.RA_XTPRAT  = '1' And SRA.RA_FILIAL = SRT.RT_FILIAL"
cQuery += CRLF + "  Inner Join " + RetSqlName("SRV") + " SRV On SRV.D_E_L_E_T_ = ' ' And SRV.RV_FILIAL = '" + xFilial( "SRV" ) + "' And SRV.RV_COD = SRT.RT_VERBA And SRV.RV_XRATEIO <> 'N'"

cQuery += CRLF + "  Where         SRT.D_E_L_E_T_         = ' ' " //AND SRA.RA_FILIAL = '12MT0012' AND SRA.RA_MAT IN ('004588')"
cQuery += CRLF + "  AND SRA.RA_CATFUNC NOT IN ('A') AND SRT.RT_MAT = SRA.RA_MAT AND SRT.RT_FILIAL = SRA.RA_FILIAL"
cQuery += CRLF + "  AND SRT.RT_DATACAL = '"+cDataProv+"'"


cQuery += CRLF + "  Order By TABELA, MATRICULA"

//cQuery := ChangeQuery( cQuery )

dbUseArea( .T., "TOPCONN", TcGenQry(,,cQuery), cAliasQr2, .T., .T. )

TcSetField( cAliasQr2, "VALOR", "N", TamSX3("RC_VALOR")[1], TamSX3("RC_VALOR")[2] )

( cAliasQr2 )->( dbEval( { || nTotalReg++ },, { || !EOF() } ) )

( cAliasQr2 )->(dbGotop())

While ( cAliasQr2 )->( !Eof() )
	
	nPos 		:= ASCAN(aVbBaixa,{|x| X  == (cAliasQr2)->(VERBA)})
	cEmpAtu	:= ( cAliasQr2 )->(MATRICULA)
	cFilAtu 	:= ( cAliasQr2 )->(RA_FILIAL)	
	
	/*----------------------------------------------------------|
	|---13/05/2015 - William Santos								|
	|															|
	|Inserido codigo abaixo para controlar o rateio das verbas 	|
	|de Estorno de Provisão de Encargos. Atualmente as verbas	|
	|são 972,973,974 e somente quando for a conta 2 a conta 3	| 
	|deve ratear normalmente na gestão						  	|														|
	|----------------------------------------------------------*/
	
	If (cAliasQr2)->(VERBA) $  ('972,973,974') //.AND. SUBSTR(( cAliasQr2 )->( CRE ),1,1) = '3')
	
		_lEstProvEnc := .T.
		
	ELSE
		
		_lEstProvEnc := .F.
		
	EndIf
		
	nReg += 1
	IF ( cAliasQr2 )->VALOR = 0
		( cAliasQr2 )->( dbSkip() )
		Loop	
	EndIf
	
	_lDemMSeg := U_RetDtDem(cEmpAtu,cFilAtu) //-- Verifica se a data de demissão é do periodo de rateio ou próximo periodo.

   //-- 1=Folha;2=Provisao 13º Salario;3=Provisao Ferias,4=1ª Parcela,5=2ª Parcela,6=Férias,7=Rescisão

	If !Empty( ( cAliasQr2 )->( TIPOPROV ) )
		If ( cAliasQr2 )->( TIPOPROV ) $ "1/2"
			cTipoFol := "3"
		ElseIf ( cAliasQr2 )->( TIPOPROV ) $ "3/4"
			cTipoFol := "2"
		EndIf
	Else
		If (( cAliasQr2 )->( TIPO2 ) $ "I/G/E/C/V" .AND. (( cAliasQr2 )->( SITUAC ) <> 'D' .OR. (( cAliasQr2 )->( SITUAC ) == 'D' .AND. _lDemMSeg = .T.)) .AND. ( cAliasQr2 )->( TABELA ) = '1')
			cTipoFol := "1"
		ElseIf (( cAliasQr2 )->( TIPO2 ) $ "P" .AND. (( cAliasQr2 )->( SITUAC ) <> 'D' .OR. (( cAliasQr2 )->( SITUAC ) == 'D' .AND. _lDemMSeg = .T.)))
			cTipoFol := "4"
		ElseIf (( cAliasQr2 )->( TIPO2 ) $ "S" .AND. (( cAliasQr2 )->( SITUAC ) <> 'D' .OR. (( cAliasQr2 )->( SITUAC ) == 'D' .AND. _lDemMSeg = .T.)) .OR. ( cAliasQr2 )->( TABELA ) = '3')
			cTipoFol := "5"
		ElseIf (( cAliasQr2 )->( TIPO2 ) $ "K" .AND. (( cAliasQr2 )->( SITUAC ) <> 'D' .OR. (( cAliasQr2 )->( SITUAC ) == 'D' .AND. _lDemMSeg = .T.)))
			cTipoFol := "6"
		ElseIf (( cAliasQr2 )->( SITUAC ) == 'D' .AND. _lDemMSeg == .F.)
			cTipoFol := "7"
	   EndIf
   EndIf

   //--- ZD7_FILIAL+ZD7_MESANO+ZD7_TIPFOL+ZD7_MAT+ZD7_CC+ZD7_ITEM
    cFil01 := ( cAliasQr2 )->( RA_FILIAL )
    cFil01 := Substr(cFil01,1,2)
	
	//------------------------------------------------------------------
	//AJUSTE DE VERBAS DE CONTRIBUICAO
	//------------------------------------------------------------------
	
	_nValVrb := ( cAliasQr2 )->( VALOR )
		
		//CONTROLE DE CONTRIBUICAO
		If ( cAliasQr2 )->( VERBA) $ ('702,703,704,727,728,733,750')
			
			//RESTA FERIAS
			IF (( cAliasQr2 )->( VERBA) <> '727' .AND. ( cAliasQr2 )->( VERBA) <> '733')
				_nPos := ASCAN(aVlrDifCont ,{|x| X[1]  == ( cAliasQr2 )->( RA_FILIAL ) .AND. X[2] == ( cAliasQr2 )->(MATRICULA) .AND. X[3] == '967'})
			ELSE
				_nPos := ASCAN(aVlrDifCont ,{|x| X[1]  == ( cAliasQr2 )->( RA_FILIAL ) .AND. X[2] == ( cAliasQr2 )->(MATRICULA) .AND. X[3] == '968'})
			ENDIF
							
			If _nPos > 0
				If ( cAliasQr2 )->( VERBA) $ ('702') .And. ( cAliasQr2 )->( TIPO2 ) <> 'S' //-- INSS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][4]) 
				EndIf
				If ( cAliasQr2 )->( VERBA) $ ('703') .And. ( cAliasQr2 )->( TIPO2 ) <> 'S' //-- TERCEIROS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][5]) 
				EndIf
				If ( cAliasQr2 )->( VERBA) $ ('704') .And. ( cAliasQr2 )->( TIPO2 ) <> 'S' //-- ACID.TRAB
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][6]) 
				EndIf			
				If ( cAliasQr2 )->( VERBA) $ ('727,733') //-- FGTS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][7]) 
				EndIf
				If ( cAliasQr2 )->( VERBA) $ ('750') .And. ( cAliasQr2 )->( TIPO2 ) <> 'S' //-- PIS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][8]) 
				EndIf				
			EndIf
			
			//RESTA 13o. SALARIO
			IF (( cAliasQr2 )->( VERBA) <> '728' .AND. ( cAliasQr2 )->( VERBA) <> '733')
				_nPos := ASCAN(aVlrDifCont ,{|x| X[1]  == ( cAliasQr2 )->( RA_FILIAL ) .AND. X[2] == ( cAliasQr2 )->(MATRICULA) .AND. X[3] == '969'})
			ELSE
				_nPos := ASCAN(aVlrDifCont ,{|x| X[1]  == ( cAliasQr2 )->( RA_FILIAL ) .AND. X[2] == ( cAliasQr2 )->(MATRICULA) .AND. X[3] == '970'})
			ENDIF
						
			If _nPos > 0
				If ( cAliasQr2 )->( VERBA) $ ('702') .And. ( cAliasQr2 )->( TIPO2 ) <> 'S' //-- INSS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][4]) 
				EndIf
				If ( cAliasQr2 )->( VERBA) $ ('703') .And. ( cAliasQr2 )->( TIPO2 ) <> 'S' //-- TERCEIROS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][5]) 
				EndIf
				If ( cAliasQr2 )->( VERBA) $ ('704') .And. ( cAliasQr2 )->( TIPO2 ) <> 'S' //-- ACID.TRAB
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][6]) 
				EndIf			
				If ( cAliasQr2 )->( VERBA) $ ('728,733') //-- FGTS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][7]) 
				EndIf
				If ( cAliasQr2 )->( VERBA) $ ('750') .And. ( cAliasQr2 )->( TIPO2 ) <> 'S' //-- PIS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][8]) 
				EndIf				
			EndIf
	
		EndIf
	
	IF ( cAliasQr2 )->( RAT ) == "R"
	
		nValAux := 0 
		aValRat := {}
	
		For nA := 1 to 4
			nValAux += IIF(nA < 4,ROUND(( _nValVrb * aCompart[nA] / 100),2),0) 
			AADD(aValRat,{ StrZero( nA , 2 ) , _nValVrb , IIF(nA < 4, ROUND(_nValVrb * aCompart[nA] / 100,2),ROUND(_nValVrb - nValAux,2))})
		Next nA                       
		
		For nI := 1 To Len( aCompart )
		
			IF cFil01 = '03' .AND. ( cAliasQr2 )->(MATRICULA) = '000906' .AND. ( cAliasQr2 )->(VERBA) = '100'
			     cCtaDeb := ( cAliasQr2 )->( DEB )
			ENDif
			
			
			IF cFil01 = aEmpComp[nI][01]
				cCtaDeb 	:= ( cAliasQr2 )->( DEB )
				cCtaCre		:= ( cAliasQr2 )->( CRE )
				nInt 		:= 5   
				nVRat		:= aValRat[nI][3]
				nVTotal		:= _nValVrb
				lFilEmp		:= .T.  
				cCtaMut		:= AllTrim(aEmpComp[nI][04])
				cFilRat 	:= IIf( nI <= Len( aEmpComp ), aEmpComp[nI][01]+'MT0001', '' )  
				nCont		:= nI
			ELSE                              
				cCtaDeb 	:= ( cAliasQr2 )->( DEB )
				cCtaCre		:= ( cAliasQr2 )->( CRE )
				nInt 		:= 2 
				nVRat		:= aValRat[nI][3]
				nVTotal		:= _nValVrb
				lFilEmp 	:= .F.
				cCtaMut		:= AllTrim(aEmpComp[Val(cFil01)][04])
				cFilRat 	:= Iif( nI <= Len( aEmpComp ), aEmpComp[nI][01]+'MT0001', '' ) 
			EndIf  
	                   
			For nX := 1 To nInt
			
		 	//Trata Campo Entidade Original
			If cFil01 == "01"
				cCampoOri := "091"
	   		ElseIf cFil01 == "02"
				cCampoOri := "088"
			ElseIf cFil01 == "03"
				cCampoOri := "089"
			ElseIf cFil01 == "04"
				cCampoOri := "090"		
			ElseIf cFil01 == "05"
				cCampoOri := "092"		
			EndIf  
				
			RecLock("ZD7", !( ZD7->( dbSeek( xFilial( "ZD7" ) + Iif( nI <= Len( aEmpComp ), aEmpComp[nI][02], xFilial("ZD7") ) + cAno + cMes + ( cAliasQr2 )->RA_CC + Space( nSizeItem ) + ( cAliasQr2 )->VERBA ) ) ) )
		   
		   	IF (nPos = 0 .AND. ( cAliasQr2 )->( VERBA ) <> '823' .AND. _lEstProvEnc = .F.)
		        
				ZD7->ZD7_FILIAL := ( cAliasQr2 )->( RA_FILIAL ) //Iif( nI <= Len( aEmpComp ), aEmpComp[nI][02], xFilial("ZD7") )
				ZD7->ZD7_MESANO := cAno + cMes
				ZD7->ZD7_TIPFOL := cTipoFol
				ZD7->ZD7_MAT    := ( cAliasQr2 )->( MATRICULA )
				ZD7->ZD7_CC     := ( cAliasQr2 )->( RA_CC     )
				ZD7->ZD7_ITEM	:= ( cAliasQr2 )->( RA_ITEM     ) //""
				ZD7->ZD7_VERBA  := ( cAliasQr2 )->( VERBA     )
				ZD7->ZD7_VALOR  := _nValVrb
				//ZD7->ZD7_PERC   := aCompart[nI]
				ZD7->ZD7_FILRAT := cFilRat
				ZD7->ZD7_TPRAT	:= "G"
				ZD7->ZD7_USRRAT := cUsrRat
				ZD7->ZD7_DATRAT := dDataRat
				ZD7->ZD7_HORRAT := cHoraRat
				ZD7->ZD7_ORIGEM := cCampoOri
				If (lFilEmp = .T. .AND. nX = 1)
					ZD7->ZD7_CTADEB := ""
					ZD7->ZD7_CTACRE := ( cAliasQr2 )->( CRE )   
					ZD7->ZD7_VALRAT := _nValVrb
					ZD7->ZD7_PERC	:= 100
				ELSEIF (lFilEmp = .T. .AND. nX = 2 )              
					ZD7->ZD7_CTADEB := ( cAliasQr2 )->( DEB )
					ZD7->ZD7_CTACRE := ""                    
					ZD7->ZD7_VALRAT := nVRat
					ZD7->ZD7_PERC	:=  aCompart[nI]
				ELSEIF (lFilEmp = .T. .AND. (nX >= 3 .AND. nX <= 5) )
					nCont += 1                                                         
					IF nCont > 4 //Controla o loop de empresas
					 	nCont := 1
					EndIf
					ZD7->ZD7_CTADEB := AllTrim(aEmpComp[nCont][04])
					ZD7->ZD7_CTACRE := ""
					ZD7->ZD7_VALRAT := aValRat[nCont][3] //( cAliasQr2 )->( VALOR ) * aCompart[nCont] / 100
					ZD7->ZD7_PERC	:= aCompart[nCont]
				ELSEIF (lFilEmp = .F. .AND. nX = 1)
					ZD7->ZD7_CTADEB := ( cAliasQr2 )->( DEB )
					ZD7->ZD7_CTACRE := "" 
					ZD7->ZD7_VALRAT := nVRat                   
					ZD7->ZD7_PERC	:=  aCompart[nI]
				ELSEIF (lFilEmp = .F. .AND. nX = 2)
					ZD7->ZD7_CTADEB := ""
					ZD7->ZD7_CTACRE := AllTrim(cCtaMut)
					ZD7->ZD7_VALRAT := nVRat        
					ZD7->ZD7_PERC	:=  aCompart[nI]
				ELSE
				   //nada
				EndIf                              
			ELSE
				ZD7->ZD7_FILIAL := ( cAliasQr2 )->( RA_FILIAL ) //Iif( nI <= Len( aEmpComp ), aEmpComp[nI][02], xFilial("ZD7") )
				ZD7->ZD7_MESANO := cAno + cMes
				ZD7->ZD7_TIPFOL := cTipoFol
				ZD7->ZD7_MAT    := ( cAliasQr2 )->( MATRICULA )
				ZD7->ZD7_CC     := ( cAliasQr2 )->( RA_CC     )
				ZD7->ZD7_ITEM	:= ( cAliasQr2 )->( RA_ITEM     ) //""
				ZD7->ZD7_VERBA  := ( cAliasQr2 )->( VERBA     )
				ZD7->ZD7_VALOR  := _nValVrb
				//ZD7->ZD7_PERC   := aCompart[nI]
				ZD7->ZD7_FILRAT := cFilRat
				ZD7->ZD7_TPRAT	:= "G"
				ZD7->ZD7_USRRAT := cUsrRat
				ZD7->ZD7_DATRAT := dDataRat
				ZD7->ZD7_HORRAT := cHoraRat
				ZD7->ZD7_ORIGEM := cCampoOri
				If (lFilEmp = .T. .AND. nX = 1)
					ZD7->ZD7_CTADEB := ( cAliasQr2 )->( DEB )
					ZD7->ZD7_CTACRE :=  ""  
					ZD7->ZD7_VALRAT := _nValVrb
					ZD7->ZD7_PERC	:= 100
				ELSEIF (lFilEmp = .T. .AND. nX = 2 )              
					ZD7->ZD7_CTADEB := ""
					ZD7->ZD7_CTACRE := ( cAliasQr2 )->( CRE )                    
					ZD7->ZD7_VALRAT := nVRat
					ZD7->ZD7_PERC	:=  aCompart[nI]
				ELSEIF (lFilEmp = .T. .AND. (nX >= 3 .AND. nX <= 5) )
					nCont += 1                                                         
					IF nCont > 4 //Controla o loop de empresas
					 	nCont := 1
					EndIf
					ZD7->ZD7_CTADEB := ""
					ZD7->ZD7_CTACRE := AllTrim(aEmpComp[nCont][04])
					ZD7->ZD7_VALRAT := aValRat[nCont][3] //( cAliasQr2 )->( VALOR ) * aCompart[nCont] / 100
					ZD7->ZD7_PERC	:= aCompart[nCont]
				ELSEIF (lFilEmp = .F. .AND. nX = 1)
					ZD7->ZD7_CTADEB := AllTrim(cCtaMut)
					ZD7->ZD7_CTACRE := "" 
					ZD7->ZD7_VALRAT := nVRat                   
					ZD7->ZD7_PERC	:=  aCompart[nI]
				ELSEIF (lFilEmp = .F. .AND. nX = 2)
					ZD7->ZD7_CTADEB := ""
					ZD7->ZD7_CTACRE := ( cAliasQr2 )->( CRE )
					ZD7->ZD7_VALRAT := nVRat        
					ZD7->ZD7_PERC	:=  aCompart[nI]
				ELSE
				   //nada
				EndIf
			EndIf	
				
				ZD7->( MsUnLock() )
			Next
	
		Next
    ELSE // -----VERBAS QUE CONTABILIZAM INTEGRAL-----
        	For nX := 1 to 2
        	
		 	//Trata Campo Entidade Original
			If cFil01 == "01"
				cCampoOri := "091"
	   		ElseIf cFil01 == "02"
				cCampoOri := "088"
			ElseIf cFil01 == "03"
				cCampoOri := "089"
			ElseIf cFil01 == "04"
				cCampoOri := "090"		
			ElseIf cFil01 == "05"
				cCampoOri := "092"		
			EndIf  
			
			
	       	RecLock("ZD7", !( ZD7->( dbSeek( xFilial( "ZD7" ) + Iif( nI <= Len( aEmpComp ), aEmpComp[nI][02], xFilial("ZD7") ) + cAno + cMes + ( cAliasQr2 )->RA_CC + Space( nSizeItem ) + ( cAliasQr2 )->VERBA ) ) ) )
			      
			ZD7->ZD7_FILIAL := ( cAliasQr2 )->( RA_FILIAL ) //Iif( nI <= Len( aEmpComp ), aEmpComp[nI][02], xFilial("ZD7") )
			ZD7->ZD7_MESANO := cAno + cMes
			ZD7->ZD7_TIPFOL := cTipoFol
			ZD7->ZD7_MAT    := ( cAliasQr2 )->( MATRICULA )
			ZD7->ZD7_CC     := ( cAliasQr2 )->( RA_CC     )
			ZD7->ZD7_ITEM	:= ( cAliasQr2 )->( RA_ITEM     ) //""
			ZD7->ZD7_VERBA  := ( cAliasQr2 )->( VERBA     )
			ZD7->ZD7_VALOR  := _nValVrb
			ZD7->ZD7_VALRAT := _nValVrb
			ZD7->ZD7_PERC   := 100
			ZD7->ZD7_FILRAT := ( cAliasQr2 )->( RA_FILIAL )
			ZD7->ZD7_TPRAT	:= "G"
			ZD7->ZD7_USRRAT := cUsrRat
			ZD7->ZD7_DATRAT := dDataRat
			ZD7->ZD7_HORRAT := cHoraRat
			ZD7->ZD7_CTADEB := IIF(nX = 1,( cAliasQr2 )->( DEB ),"")
			ZD7->ZD7_CTACRE := IIF(nX = 2,( cAliasQr2 )->( CRE ),"")
			ZD7->ZD7_ORIGEM := cCampoOri
			
			ZD7->( MsUnLock() )
			
			Next
			
        
    EndIf    
	oTermGr2:Set( Int( nReg * 100 / nTotalReg ) )
	
	nPos :=0
	
	( cAliasQr2 )->( dbSkip() )

End

oTermGr2:Set( 100 )
oTermGr2:Refresh()

( cAliasQr2 )->( dbCloseArea() )

//------------------------------------------------------
// Rateio Modelo III - Condomínio
//---------------------------------------------------------------------------------

nTotalReg := 0
nReg      := 0

cQuery :=        " Select SRA.RA_FILIAL FILIAL, SRA.RA_SITFOLH SITUAC, SRA.RA_MAT MATRICULA, SRC.RC_PD VERBA, SRC.RC_VALOR VALOR, '' TIPOPROV, '1' Tabela, SRC.RC_TIPO2 TIPO2, RA_CC,RA_ITEM,RA_FILIAL,SRV.RV_XCTADEB DEB,SRV.RV_XCTACRD CRE,SRV.RV_XRATEIO RAT"

cQuery += CRLF + "   From " + cTabMov + " SRC"

cQuery += CRLF + "  Inner Join " + RetSqlName("SRA") + " SRA On SRA.D_E_L_E_T_ = ' ' And SRA.RA_FILIAL = SRC.RC_FILIAL And SRA.RA_MAT = SRC.RC_MAT And (SRA.RA_DEMISSA = ' ' OR (SELECT MAX(RG_DATAHOM) FROM "+RetSqlName("SRG")+" WHERE D_E_L_E_T_ <> '*') >= '"+cDtDemIni+"') And SRA.RA_XTPRAT = '3' AND SRC.RC_MAT = SRA.RA_MAT AND SRC.RC_FILIAL = SRA.RA_FILIAL"
cQuery += CRLF + "  Inner Join " + RetSqlName("SRV") + " SRV On SRV.D_E_L_E_T_ = ' ' And SRV.RV_FILIAL = '" + xFilial( "SRV" ) + "' And SRV.RV_COD = SRC.RC_PD And SRV.RV_XRATEIO <> 'N'"

cQuery += CRLF + "  Where         SRC.D_E_L_E_T_      = ' '"

IF CMES = '12'
	cQuery += CRLF + "  Union"
	//13 SALARIO
	cQuery +=        " Select SRA.RA_FILIAL FILIAL, SRA.RA_SITFOLH SITUAC, SRA.RA_MAT MATRICULA, SRI.RI_PD VERBA, SRI.RI_VALOR VALOR, '' TIPOPROV, '3' Tabela, SRI.RI_TIPO2 TIPO2, RA_CC,RA_ITEM,RA_FILIAL,SRV.RV_XCTADEB DEB,SRV.RV_XCTACRD CRE,SRV.RV_XRATEIO RAT"
	
	cQuery += CRLF + "   From " + cTabMovRI + " SRI"
	
	cQuery += CRLF + "  Inner Join " + RetSqlName("SRA") + " SRA On SRA.D_E_L_E_T_ = ' ' And SRA.RA_FILIAL = SRI.RI_FILIAL And SRA.RA_MAT = SRI.RI_MAT And (SRA.RA_DEMISSA = ' ' OR (SELECT MAX(RG_DATAHOM) FROM "+RetSqlName("SRG")+" WHERE D_E_L_E_T_ <> '*') >= '"+cDtDemIni+"') And SRA.RA_XTPRAT = '3' AND SRI.RI_MAT = SRA.RA_MAT AND SRI.RI_FILIAL = SRA.RA_FILIAL"
	cQuery += CRLF + "  Inner Join " + RetSqlName("SRV") + " SRV On SRV.D_E_L_E_T_ = ' ' And SRV.RV_FILIAL = '" + xFilial( "SRV" ) + "' And SRV.RV_COD = SRI.RI_PD And SRV.RV_XRATEIO <> 'N'"
	
	cQuery += CRLF + "  Where         SRI.D_E_L_E_T_      = ' '"
ENDIF

cQuery += CRLF + "  Union"
//PROVISAO

cQuery += CRLF + " Select SRA.RA_FILIAL FILIAL, SRA.RA_SITFOLH SITUAC, SRA.RA_MAT MATRICULA, SRT.RT_VERBA VERBA, SRT.RT_XVALMES VALOR, SRT.RT_TIPPROV TIPOPROV, '2' TABELA, '' TIPO2, RA_CC,RA_ITEM,RA_FILIAL,SRV.RV_XCTADEB DEB,SRV.RV_XCTACRD CRE,SRV.RV_XRATEIO RAT"

cQuery += CRLF + "   From " + RetSqlName("SRT") + " SRT"

cQuery += CRLF + "  Inner Join " + RetSqlName("SRA") + " SRA On SRA.D_E_L_E_T_ = ' ' And SRA.RA_FILIAL = SRT.RT_FILIAL And SRA.RA_MAT = SRT.RT_MAT And (SRA.RA_DEMISSA = ' ' OR (SELECT MAX(RG_DATAHOM) FROM "+RetSqlName("SRG")+" WHERE D_E_L_E_T_ <> '*') >= '"+cDtDemIni+"') And SRA.RA_XTPRAT = '3'"
cQuery += CRLF + "  Inner Join " + RetSqlName("SRV") + " SRV On SRV.D_E_L_E_T_ = ' ' And SRV.RV_FILIAL = '" + xFilial( "SRV" ) + "' And SRV.RV_COD = SRT.RT_VERBA And SRV.RV_XRATEIO <> 'N'"

cQuery += CRLF + "  Where         SRT.D_E_L_E_T_         = ' '"
cQuery += CRLF + "  And SRA.RA_CATFUNC NOT IN ('A') AND SRT.RT_MAT = SRA.RA_MAT AND SRT.RT_FILIAL = SRA.RA_FILIAL"
cQuery += CRLF + "  AND SRT.RT_DATACAL = '"+cDataProv+"'"

cQuery += CRLF + "  Order By TABELA, MATRICULA"

cQuery := ChangeQuery( cQuery )

dbUseArea( .T., "TOPCONN", TcGenQry(,,cQuery), cAliasQr3, .T., .T. )

TcSetField( cAliasQr3, "VALOR", "N", TamSX3("RC_VALOR"  )[1], TamSX3("RC_VALOR"  )[2] )

( cAliasQr3 )->( dbEval( { || nTotalReg++ },, { || !EOF() } ) )

( cAliasQr3 )->(dbGotop())

While ( cAliasQr3 )->( !Eof() )

	nReg += 1
	IF ( cAliasQr3 )->VALOR = 0
		( cAliasQr3 )->( dbSkip() )
		Loop	
	EndIf
	
	_lDemMSeg := U_RetDtDem(cEmpAtu,cFilAtu) //-- Verifica se a data de demissão é do periodo de rateio ou próximo periodo.

   //-- 1=Folha;2=Provisao 13º Salario;3=Provisao Ferias,4=1ª Parcela,5=2ª Parcela,6=Férias,7=Rescisão

	If !Empty( ( cAliasQr3 )->( TIPOPROV ) )
		If ( cAliasQr3 )->( TIPOPROV ) $ "1/2"
			cTipoFol := "3"
		ElseIf ( cAliasQr3 )->( TIPOPROV ) $ "3/4"
			cTipoFol := "2"
		EndIf
	Else
		If (( cAliasQr3 )->( TIPO2 ) $ "I/G/E/C/V"  .AND. (( cAliasQr3 )->( SITUAC ) <> 'D' .OR. (( cAliasQr3 )->( SITUAC ) == 'D' .AND. _lDemMSeg = .T.)) .AND. ( cAliasQr3 )->( TABELA ) = "1")
			cTipoFol := "1"
		ElseIf (( cAliasQr3 )->( TIPO2 ) $ "P" .AND. (( cAliasQr3 )->( SITUAC ) <> 'D' .OR. (( cAliasQr3 )->( SITUAC ) == 'D' .AND. _lDemMSeg = .T.)))
			cTipoFol := "4"
		ElseIf (( cAliasQr3 )->( TIPO2 ) $ "S"  .AND. (( cAliasQr3 )->( SITUAC ) <> 'D' .OR. (( cAliasQr3 )->( SITUAC ) == 'D' .AND. _lDemMSeg = .T.)) .OR. ( cAliasQr3 )->( TABELA ) = "3" )
			cTipoFol := "5"
		ElseIf (( cAliasQr3 )->( TIPO2 ) $ "K"  .AND. (( cAliasQr3 )->( SITUAC ) <> 'D' .OR. (( cAliasQr3 )->( SITUAC ) == 'D' .AND. _lDemMSeg = .T.)))
			cTipoFol := "6"
		ElseIf (( cAliasQr3 )->( SITUAC ) == 'D' .AND. _lDemMSeg == .F.)
			cTipoFol := "7"
	   EndIf
   EndIf

	//------------------------------------------------------------------
	//AJUSTE DE VERBAS DE CONTRIBUICAO
	//------------------------------------------------------------------
	
	_nValVrb := ( cAliasQr3 )->( VALOR )
		
		//CONTROLE DE CONTRIBUICAO
		If ( cAliasQr3 )->( VERBA) $ ('702,703,704,727,728,733,750')
			
			//RESTA FERIAS
			IF (( cAliasQr3 )->( VERBA) <> '727' .AND. ( cAliasQr3 )->( VERBA) <> '733')
				_nPos := ASCAN(aVlrDifCont ,{|x| X[1]  == ( cAliasQr3 )->(FILIAL) .AND. X[2] == ( cAliasQr3 )->(MATRICULA) .AND. X[3] == '967'})
			ELSE
				_nPos := ASCAN(aVlrDifCont ,{|x| X[1]  == ( cAliasQr3 )->(FILIAL) .AND. X[2] == ( cAliasQr3 )->(MATRICULA) .AND. X[3] == '968'})
			ENDIF
				
			If _nPos > 0
				If ( cAliasQr3 )->( VERBA) $ ('702') .And. ( cAliasQr3 )->( TIPO2 ) <> 'S'//-- INSS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][4]) 
				EndIf
				If ( cAliasQr3 )->( VERBA) $ ('703') .And. ( cAliasQr3 )->( TIPO2 ) <> 'S'//-- TERCEIROS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][5]) 
				EndIf
				If ( cAliasQr3 )->( VERBA) $ ('704') .And. ( cAliasQr3 )->( TIPO2 ) <> 'S'//-- ACID.TRAB
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][6]) 
				EndIf			
				If ( cAliasQr3 )->( VERBA) $ ('727,733') //-- FGTS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][7]) 
				EndIf
				If ( cAliasQr3 )->( VERBA) $ ('750')  .And. ( cAliasQr3 )->( TIPO2 ) <> 'S' //-- PIS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][8]) 
				EndIf				
			EndIf
			
			//RESTA 13o. SALARIO
			//RESTA FERIAS
			IF (( cAliasQr3 )->( VERBA) <> '728' .AND. ( cAliasQr3 )->( VERBA) <> '733')
				_nPos := ASCAN(aVlrDifCont ,{|x| X[1]  == ( cAliasQr3 )->(FILIAL) .AND. X[2] == ( cAliasQr3 )->(MATRICULA) .AND. X[3] == '969'})
			ELSE
				_nPos := ASCAN(aVlrDifCont ,{|x| X[1]  == ( cAliasQr3 )->(FILIAL) .AND. X[2] == ( cAliasQr3 )->(MATRICULA) .AND. X[3] == '970'})
			ENDIF
				
			
			If _nPos > 0
				If ( cAliasQr3 )->( VERBA) $ ('702') .And. ( cAliasQr3 )->( TIPO2 ) <> 'S'//-- INSS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][4]) 
				EndIf
				If ( cAliasQr3 )->( VERBA) $ ('703') .And. ( cAliasQr3 )->( TIPO2 ) <> 'S'//-- TERCEIROS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][5]) 
				EndIf
				If ( cAliasQr3 )->( VERBA) $ ('704') .And. ( cAliasQr3 )->( TIPO2 ) <> 'S'//-- ACID.TRAB
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][6]) 
				EndIf			
				If ( cAliasQr3 )->( VERBA) $ ('728,733') //-- FGTS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][7]) 
				EndIf
				If ( cAliasQr3 )->( VERBA) $ ('750')  .And. ( cAliasQr3 )->( TIPO2 ) <> 'S' //-- PIS
					_nValVrb := (_nValVrb - aVlrDifCont[_nPos][8]) 
				EndIf				
			EndIf
	
		EndIf

	
	   //--- ZD7_FILIAL+ZD7_MESANO+ZD7_TIPFOL+ZD7_MAT+ZD7_CC+ZD7_ITEM
	                                                    
		For nX := 1 to 2
		
		//Trata Campo Entidade Original
			
		 	//Trata Campo Entidade Original
			If substr((cAliasQr3)->(FILIAL),1,2) == "01"
				cCampoOri := "091"
	   		ElseIf substr((cAliasQr3)->(FILIAL),1,2) == "02"
				cCampoOri := "088"
			ElseIf substr((cAliasQr3)->(FILIAL),1,2) == "03"
				cCampoOri := "089"
			ElseIf substr((cAliasQr3)->(FILIAL),1,2) == "04"
				cCampoOri := "090"		
			ElseIf substr((cAliasQr3)->(FILIAL),1,2) == "05"
				cCampoOri := "092"		
			EndIf  
			
			RecLock("ZD7", !( ZD7->( dbSeek( xFilial( "ZD7" ) + ( cAliasQr3 )->( FILIAL ) + cAno + cMes + ( cAliasQr3 )->RA_CC + Space( nSizeItem ) + ( cAliasQr3 )->VERBA ) ) ) )
		
			ZD7->ZD7_FILIAL := ( cAliasQr3 )->( RA_FILIAL )//xFilial( "ZD7" )
			ZD7->ZD7_MESANO := cAno + cMes
			ZD7->ZD7_TIPFOL := cTipoFol
			ZD7->ZD7_MAT    := ( cAliasQr3 )->( MATRICULA )
			ZD7->ZD7_CC     := ( cAliasQr3 )->( RA_CC     )
			ZD7->ZD7_ITEM	:= ( cAliasQr3 )->( RA_ITEM     )
			ZD7->ZD7_VERBA  := ( cAliasQr3 )->( VERBA     )
			ZD7->ZD7_VALOR  := _nValVrb
			ZD7->ZD7_PERC   := 100
			ZD7->ZD7_VALRAT := _nValVrb
			ZD7->ZD7_FILRAT := ( cAliasQr3 )->( FILIAL    )
			ZD7->ZD7_TPRAT	:= "C"
			ZD7->ZD7_USRRAT := cUsrRat
			ZD7->ZD7_DATRAT := dDataRat
			ZD7->ZD7_HORRAT := cHoraRat 
			IF nX = 1
				ZD7->ZD7_CTADEB := ( cAliasQr3 )->( DEB )
			ELSE
				ZD7->ZD7_CTACRE := ( cAliasQr3 )->( CRE )
			ENDIF
			ZD7->ZD7_ORIGEM := cCampoOri
		
			ZD7->( MsUnLock() )
		Next

	oTermGr3:Set( Int( nReg * 100 / nTotalReg ) )

	( cAliasQr3 )->( dbSkip() )

End

oTermGr3:Set( 100 )
oTermGr3:Refresh()

( cAliasQr3 )->( dbCloseArea() )

//----------------------------------------------
//
//-------------------------------------------------------------------

RestArea(aAreaAtu)

MsgInfo( "Rateio concluído com sucesso!" )

Return .T.
           

//----------------------------------------------------------
// APAGA REGISTROS PARA NOVA ITERAÇÃO DO CALCULO DO RATEIO
//---------------------------------------------------------

User Function DTGPE02Del()  

aArea := GETAREA()
      
cQuery :=  "DELETE FROM "+RetSqlName("ZD7")+" "
cQuery +=	"Where ZD7_MESANO = "+cPeriodo+" AND D_E_L_E_T_ <> '*'"

IF TCSQLEXEC(cQuery) < 0 
  MSGSTOP("tcsqlerror()" + tcsqlerror())
else
 tcsqlexec("commit")
EndIf                            

RestArea(aArea)

Return


//=========================================================
//
// Carrega percentuais de Contribuição para calculo
// Data: 11/03/2015
// Autor: William Santos
//
//=========================================================


User Function PERCONTR()

Local _aArea 	:= GetArea()
Local _aArea1	:= GetArea()
Local _cCodigo  := ''
Local _nPInss	:= 0
Local _nPTer	:= 0
Local _nPAT		:= 0
Local _nFgts	:= 0
Local _nB		:= 0


cQuery := "SELECT RA_FILIAL FIL FROM " + RetSqlName("SRA") + " "
cQuery += "Where D_E_L_E_T_ <> '*' "
cQuery += "GROUP BY RA_FILIAL "
cQuery += "ORDER BY RA_FILIAL "

cQuery := ChangeQuery( cQuery )
dbUseArea( .T., "TOPCONN", TcGenQry(,,cQuery), "TRBPERC", .T., .T. )

While TRBPERC->(!EOF())
	
	For nX := 0 to 1
		If nX = 0
			_cCodigo := TRBPERC->FIL + Space(10) + "11" 
			AADD(aPercent,{TRBPERC->FIL,"1",0,0,0,0,0.01})
			_nB += 1
		Else
			_cCodigo := TRBPERC->FIL + Space(10) + "21" 
			AADD(aPercent,{TRBPERC->FIL,"2",0,0,0,0,0.01})
			_nB += 1
		EndIf
		
		_aArea1 := GetArea()
		
		DBSelectArea("SRX")
		DBSetOrder(1)
		DBSeek(xFilial()+"14"+TRBPERC->FIL)
	
		IF FPHIST82(TRBPERC->FIL,"14",_cCodigo)
			aPercent[_nB,3] := VAL(SUBSTR(SRX->RX_TXT,1,7))/100 //INSS
			aPercent[_nB,4] := VAL(SUBSTR(SRX->RX_TXT,9,7))/100 //TERCEIROS
			aPercent[_nB,5]	:= VAL(SUBSTR(SRX->RX_TXT,17,7))/100//ACID. TRAB.
			aPercent[_nB,6]	:= VAL(SUBSTR(SRX->RX_TXT,25,7))/100//FGTS
		EndIf
		
		RestArea(_aArea1)
		
	Next nX 
	TRBPERC->(DbSkip())
EndDo

TRBPERC->(DbCloseArea())
RestArea(_aArea)

Return


//=========================================================
//
// 	Gera Array aVlrDivCont que irá conter o valor das 
//	contribuições referente ao calculo de férias e 13o.
//
// 	Data: 11/03/2015
// 	Autor: William Santos
//
//=========================================================

User Function CARGACONT()

Local _aArea 	:= GetArea()
Local _nPos		:= 0
Local _nValInss := 0
Local _nValTer	:= 0
Local _nValAT	:= 0
Local _nValFGTS	:= 0
Local _nValPis	:= 0

cQuery := "SELECT RC_FILIAL FIL,RC_MAT MAT,RC_PD PD,RC_VALOR VALOR,RA_TPCONTR CONT FROM " + cTabMov + " RC  "
cQuery += "INNER JOIN "+RetSqlName("SRA")+" RA ON (RC_MAT = RA_MAT AND  RC_FILIAL = RA_FILIAL) "
cQuery += "Where RC.D_E_L_E_T_ <> '*' AND RC.RC_PD IN ('967','968','969','970') AND RA_CATFUNC <> 'E' AND RA_MAT < '900000'"// AND RC.RC_MAT = '003888'"
cQuery += "ORDER BY RC_FILIAL,RC_MAT,RC_PD "

cQuery := ChangeQuery( cQuery )
dbUseArea( .T., "TOPCONN", TcGenQry(,,cQuery), "TRB", .T., .T. )

While TRB->(!EOF())

	_nPos := 0

	_nPos := ASCAN(aPercent ,{|x| X[1]  == TRB->FIL .AND. x[2] == TRB->CONT })
	
	//If _nPos == 0
	//		Msg('Achei')
	//EndIf

	IF (TRB->PD == '968' .OR. TRB->PD == '970') 
		_nValFGTS	:= Round((TRB->VALOR * aPercent[_nPos,6]),2)
	ELSE
		_nValInss 	:= Round((TRB->VALOR * aPercent[_nPos][3]),2)
		_nValTer 	:= Round((TRB->VALOR * aPercent[_nPos,4]),2)
		_nValAT	 	:= Round((TRB->VALOR * aPercent[_nPos,5]),2)
		_nValPis	:= Round((TRB->VALOR * aPercent[_nPos,7]),2)
	EndIf
	
	AADD(aVlrDifCont,{TRB->FIL,TRB->MAT,TRB->PD,_nValInss,_nValTer,_nValAT,_nValFGTS,_nValPis})
	
	_nValInss 	:= 0
	_nValTer 		:= 0
	_nValAT	 	:= 0
	_nValFGTS		:= 0
	_nValPis		:= 0
	
	TRB->(DbSkip())
EndDo

TRB->(DbCloseArea())

RestArea(_aArea)

Return

//=========================================================
//
// 	Verifica se existe demissao para o funcionario e se 
//	a demissao e do mes de rateio ou mes seguinte.     
//
// 	Data: 17/03/2015
// 	Autor: William Santos
//
//=========================================================

User Function RetDtDem(cMat,cFil)

Local _aArea 	:= GetArea()
Local _lRet		:= .F.
Local _dDtAux	:= ctod('//')
Local _cDtAux	:= ''

cQuery := "SELECT MAX(RG_DATAHOM) DT FROM "+RetSqlName("SRG")+" "
cQuery += " WHERE D_E_L_E_T_ <> '*' AND RG_MAT = '"+cMat+"' AND RG_FILIAL = '"+cFil+"'"

cQuery := ChangeQuery( cQuery )
dbUseArea( .T., "TOPCONN", TcGenQry(,,cQuery), "TRB", .T., .T. )

While TRB->(!EOF())

	//william  02/07/15 - Modificação para corrigir o controle da demissão no mes e mes seguite.
	
	//_dDtAux := CTOD(substr(TRB->(DT),7,2)+"/"+substr(TRB->(DT),5,2)+"/"+substr(TRB->(DT),1,4))
	_cDtAux	:= substr(TRB->(DT),1,6)
	
	If _cDtAux > cDtDemIni
		_lRet := .T.	
	Else
		_lRet := .F.
	EndIf
	
	TRB->(DbSkip())
EndDo

TRB->(DbCloseArea())

RestArea(_aArea)

Return _lRet


/*/f/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
<Descricao> : Rotina para controle de versao
<Data> : 24/05/2014
<Parametros> : Nenhum
<Retorno> : cRet
<Processo> : Controle de versao
<Tipo> (Menu,Trigger,Validacao,Ponto de Entrada,Genericas,Especificas ) : V
<Autor> : Doit Sistemas
<Obs> :
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
*/

User Function DTGPE02V()

Local cRet := ""
cRet := "20140523"
 
Return cRet