#INCLUDE "RWMAKE.CH"
#INCLUDE "PROTHEUS.CH"
#INCLUDE "TOPCONN.CH"
#INCLUDE "AP5MAIL.CH"

#XCOMMAND CLOSETRANSACTION LOCKIN <aAlias,...>   => EndTran( \{ <aAlias> \}  ); End Sequence

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  袖ICOMA43  態utor  彪laudinei Ferreira  � Data �  19/10/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     袒otina para Solicitacao de Viagem            				  滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function SICOMA43()

Local aCores    := {}
Local cFilSQL := Nil
Local cQuery    := ''
Local cTp  := '3'

Private cCadastro:= "Solicita誽o de Viagens e Fundo Fixo"
Private cUserSV := GetMv("SI_XLOGVI",.F.,"")
Private aRotina := MenuDef()
Private cCodFor := ''
Private cTpUsr := ''
Private cEmailAg:= ''

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
//覓erifica se usuario possui cadastro de Aprovador�
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
Private lUsrAprv:=IIF(!Empty(Posicione('SAK',2,xFilial('SAK')+__cUserID,"AK_USER")),.T.,.F.)

aCores:={{'ZA6_STATUS=="1"','ENABLE'  		},;  //Nao enviada para aprovacao
		{'ZA6_STATUS=="2"' ,'BR_LARANJA' 	},;  //Aguardando Passagem/Hospedagem
   		{'ZA6_STATUS=="3"' ,'BR_AMARELO' 	},;  //Aguardando Validacao
   		{'ZA6_STATUS=="4"' ,'BR_PRETO'  	},;  //Aguardando Aprovacao do Gestor 
   		{'ZA6_STATUS=="5"' ,'BR_AZUL'  		},;  //Aprovada pelo Gestor 
   		{'ZA6_STATUS=="6"' ,'BR_VERMELHO'  	},;  //Finalizada 
   		{'ZA6_STATUS=="7"' ,'BR_PINK'  		},;  //Solicitacao Cancelada 
   		{'ZA6_STATUS=="8"' ,'LIGHTBLU'  	}}   //Reprovada pelo Gestor       

//矬闡闡闡闡闡闡闡闡闡闡闡闡�
//覓erifica tipo do usuario �
//斂闡闡闡闡闡闡闡闡闡闡闡闡�
cTpUsr:=Posicione('ZA8',2,xFilial('ZA8')+__cUserID,"ZA8_TIPO")
ZA8->(DbCloseArea())

If cTpUsr <> '3' //Agencia de Viagem
	If  !__cUserID $ cUserSV
		//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
		//蚶iltrar solicitacao conforme usuario logado e parametro SI_XLOGVI �
		//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
		DbSelectArea("SA2")
		SA2->(DbOrderNickName("SICOMA4301"))
		MsSeek(xFilial("SA2")+__cUserID)
		
		If  !__cUserID $ cUserSV .AND. !lUsrAprv
			cFilSQL:="(ZA6_FORNEC='"+SA2->A2_COD+"' AND ZA6_LOJA='"+ SA2->A2_LOJA +"') OR ZA6_USRINC='"+__cUserID+"'"
		ElseIf __cUserID $ cUserSV .AND. cTpUsr == '3' .AND. !lUsrAprv
			//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
			//覓erifica se usuario e do Tipo 3(Agencia de Viagens) e nao seleciona solitacoes de F.Fixo  �
			//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
			cFilSQL:=" ZA6_TPSOL <> '1'"
		Endif
		
		If lUsrAprv
			cFilSQL:=" ZA6_STATUS <> '1'
		Endif
	Endif
Else
	cFilSQL:=" ZA6_TPSOL <> '1' AND ZA6_STATUS <> '1'"
Endif

If cTpUsr == '1'
 cFilSQL:=" ZA6_TPSOL <> '1' AND ZA6_STATUS = '3'"
Endif

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
//彪od.Fornecedor+Loja para utilizacao na avaliacao de solitacoes em aberto  �
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
cCodFor:=SA2->(A2_COD+A2_LOJA)

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡�
//袖elecione e-mail da Agencia�
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡�
BEGINSQL ALIAS "TRBAG"
 
 SELECT
 ZA8_EMAIL
 FROM  %table:ZA8% ZA8
 WHERE  ZA8.%notDel%
 AND ZA8_FILIAL  = %exp:xFilial("ZA8")%
 AND ZA8_TIPO = %exp:cTp%
 
ENDSQL

cEmailAg:= TRBAG->ZA8_EMAIL

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
//蚶echa o temporario                |
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
TRBAG->(dbCloseArea())

MBrowse(6,1,22,75,"ZA6",,,,,,aCores,,,,,,,,cFilSQL)

Return

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43MntSV  態utor  彪laudinei Ferreira  � Data �  19/10/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     袒otina para Inclusao da Solicitacao de Viagem      		  滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function A43MntSV(cAlias, nReg, nOpc)

Local aPosObj   := {}
Local aObjects  := {}
Local aSize     := {}
Local aPosGet   := {}
Local aInfo     := {}
Local nOpcx		:= 0
Local lMemory   := .F.
Local aNoFields := {}
Local cSeek     := ""
Local cQuery    := ""
Local nQtdReg	:= 0
Local aButtons  := {}
Local oGetCot 	:= Nil
Local cSeek     := ""
Local bWhile    := {|| }
Local lContinua := .T.
Local lExPCta	:= .F.

Private lA43Inclui	:= .F.
Private lA43Visual	:= .F.
Private lA43Altera	:= .F.
Private cTpSol  	:= ''
Private aHeader		:= {}
Private aCols   	:= {}
Private oGetD 		:= {}
Private oGetSV 		:= Nil
Private cNrSol  	:= ZA6->ZA6_NUM  
PRIVATE aTELA[0][0],aGETS[0]

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
//� Calculo automatico de dimensoes de objetos �
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
aSize := MsAdvSize()
aObjects := {}
AAdd( aObjects, { 100, 100, .T., .T. } )
AAdd( aObjects, { 100, 090, .T., .F. } )
aInfo := { aSize[ 1 ], aSize[ 2 ], aSize[ 3 ], aSize[ 4 ], 3, 3 }
aPosObj := MsObjSize( aInfo, aObjects )
aPosGet := MsObjGetPos(aSize[3]-aSize[1],315,{{003,033,160,200,240,263}} )

DEFINE MSDIALOG oDlg TITLE cCadastro From aSize[7],0 to aSize[6],aSize[5] of oMainWnd PIXEL STYLE nOR( WS_VISIBLE ,DS_MODALFRAME )

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
//� Define a funcao utilizada ( Incl.,Alt.,Visual.,Exclu.)  �
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
If aRotina[nOpc][4] == 3
 lA43Inclui:= .T.
ElseIf aRotina[nOpc][4] == 2
 lA43Visual:= .T.
ElseIf aRotina[nOpc][4] == 4
 lA43Altera:= .T.
 
 //Localiza lancamento de Prestacao de Contas
 dbSelectArea("ZAB")
 dbSetOrder(1)
 If DbSeek(xFilial("ZAB")+ZA6->ZA6_NUM)
  lExPCta:=.T.
  lContinua:= .F.
 Endif
Endif

//矬闡闡闡醴
//蛆nclusao�
//斂闡闡闡囁
If lA43Inclui
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
 //� Salva a integridade dos campos de Bancos de Dados    �
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
 dbSelectArea("ZA6")
 dbSetOrder(1)
 
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
 //� Criar uma nova instancia de variaveis private       �
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
RegToMemory( "ZA6", .T., .F. )

 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
 //蛉ontagem do aHeader e aCols                           �
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
 oGetSV :=MSMGet():New( "ZA6", nReg, nOpc, , , , , aPosObj[1],,3,,,,,,lMemory)
 
 FillGetDados(nOPc,"ZA7",1,/*cSeek*/,/*{|| &cWhile }*/,{||.T.},/*aNoFields*/,/*aYesFields*/,/*lOnlyYes*/,/*cQuery*/,/*bMontCols*/,.T.,,,{|| AfterCols(aCols) })
 aCols[1][1] := "001"
 
 oGetD :=MsGetDados():New(aPosObj[2,1],aPosObj[2,2],aPosObj[2,3],aPosObj[2,4],nOpc,/*"U_A43LinOk"*/, "U_A43TudoOk", "+ZA7_ITEM",.T.,,,.T.,,"U_A43FildOK()",/*"U_A43ADel"*/, ,/*"U_A43DelOK"*/)
 
Endif

//矬闡闡闡闡闡醴
//覓isualizacao�
//斂闡闡闡闡闡囁
If lA43Visual
 
 If lUsrAprv .and. ZA6->ZA6_TPSOL $ '2'
  Aadd(aButtons, {'PMSAPONT'    ,{||oGetD:oBrowse:lDisablePaint:=.F.,AnaliCot('APR')} ,"Analisa Cot."})
 Endif
 
 //ADM Cotacao ou Gestor para Aprovacao
 If cTpUsr == '1' .or. lUsrAprv 
  Aadd(aButtons, {'BUDGET'    ,{||oGetD:oBrowse:lDisablePaint:=.F.,U_A43Aprv(If(cTpUsr=='1','ADM','APR'))} ,"Aprovar"})
  Aadd(aButtons, {'SDUSOFTSEEK',{||oGetD:oBrowse:lDisablePaint:=.F.,U_A43Reprv(If(cTpUsr=='1','ADM','APR'))},"Reprovar"})
 Endif
 
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
 //� Inicializa a Variaveis da Enchoice.                  �
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
 RegToMemory( "ZA6", .F., .F. )
 
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
 //� Filtros para montagem do aCols                       �
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
 dbSelectArea("ZA7")
 dbSetOrder(1)
 
 cQuery := "SELECT * "
 cQuery += "FROM "+RetSqlName("ZA7")+" ZA7 "
 cQuery += "WHERE ZA7.ZA7_FILIAL='"+xFilial("ZA7")+"' AND "
 cQuery += "ZA7.ZA7_NUM='"+ZA6->ZA6_NUM+"' AND "
 cQuery += "ZA7.D_E_L_E_T_<>'*' "
 cQuery += "ORDER BY "+SqlOrder(ZA7->(IndexKey()))
 
 dbSelectArea("ZA7")
 dbCloseArea()
 
 cSeek  := xFilial("ZA7")+ZA6->ZA6_NUM
 bWhile := {|| ZA7_FILIAL+ZA7_NUM }
 
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
 //蛉ontagem do aHeader e aCols                           �
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
 oGetSV :=MSMGet():New( "ZA6", nReg, nOpc, , , , , aPosObj[1],,3,,,,,,lMemory)
 
 FillGetDados(nOPc,"ZA7",1,cSeek,bWhile,,,/*aYesFields*/,/*lOnlyYes*/,cQuery,/*bMontCols*/,.F.,/*aHeaderAux*/,/*aColsAux*/,,/*bBeforeCols*/,/*bAfterHeader*/,"ZA7aCols")
 
 oGetD := MsGetDados():New(aPosObj[2,1],aPosObj[2,2],aPosObj[2,3],aPosObj[2,4],nOpc,,,"",,,,,,,,,,,,)

 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
 //莧tualiza Visualizacao do aCols conforme Status do Trecho�
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
    U_ViewaCols()
 
Endif

//矬闡闡闡闡醴
//莧lteracao �
//斂闡闡闡闡囁
If lA43Altera .AND. !lExPCta .AND. !ZA6->ZA6_STATUS $ '6/7' //Finalizada e Solicitacao Cancelada
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
 //� Salva a integridade dos campos de Bancos de Dados    �
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
 dbSelectArea("ZA6")
 dbSetOrder(1)
 
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
 //� Criar uma nova instancia de variaveis private       �
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
 RegToMemory( "ZA6", .T., .F. )
 
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
 //蛉ontagem do aHeader e aCols                           �
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
 cSeek  := xFilial("ZA7")+ZA6->ZA6_NUM
 bWhile := "ZA7_FILIAL+ZA7_NUM"
 
 FillGetDados(nOpc,"ZA7",1,cSeek,{|| &bWhile },,aNoFields,,,,,,,,)
 aCols[1][1] := If(Empty(aCols[1][1]),"001",aCols[1][1])
 
 oGetSV := MSMGet():New( "ZA6", nReg, 2, , , , , aPosObj[1],,/*nOpcx*/,,,/*"A415VldTOk"*/)
 
 nNraCols:= Len(aCols)
 oGetD :=MsGetDados():New(aPosObj[2,1],aPosObj[2,2],aPosObj[2,3],aPosObj[2,4],nOpc,,, "+ZA7_ITEM",.T.,,,.T.,,"U_A43FildAlt(nNraCols)")
    
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
 //莧tualiza Visualizacao do aCols conforme Status do Trecho�
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
    U_ViewaCols()
    
Elseif lA43Altera .AND. lExPCta
 MsgStop("Opera誽o n緌 permitida, solicita誽o com Presta誽o de Contas em andamento","Aten誽o")
Endif

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
//覓erifica se usuario e do Tipo 3 = Agencia de Viagens�
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
If cTpUsr == '3' //Agencia de Viagem
 Aadd(aButtons, {'DBG05'    ,{||oGetD:oBrowse:lDisablePaint:=.F.,U_SICOMA46()} ,"Inserir Cota誽o"})
Elseif cTpUsr == '1' //ADM Cotacao
 Aadd(aButtons, {'PMSAPONT'    ,{||oGetD:oBrowse:lDisablePaint:=.F.,AnaliCot('ADM')} ,"Analisa Cot."})
Endif

If lContinua
 ACTIVATE MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{|| nOpcX := 1,if(oGetd:TudoOk() .and. A43VldCols(),If(nOpc==3 .and. !Obrigatorio(aGets,aTela),nOpcX := 0,oDlg:End()),nOpcX := 0)},{||oDlg:End()},,aButtons) CENTERED
Endif

If (nOpcx == 1 .and. lA43Inclui) .or. (nOpcx == 1 .and. lA43Altera) 
 A43Inclui()
Elseif (nOpcx == 0 .and. lA43Inclui)
 RollBackSX8()
Endif

Return

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  覓iewaCols 態utor  彪laudinei Ferreira  � Data �  06/12/12   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     覓alida campo ZA7_STS para exibir aCols deletado caso o      滷�
控�          袖TATUS = 2 (Cancelado)                    				  滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/
User Function ViewaCols

Local nPosSts := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_STS"})

For Nx:=1 to Len(aCols)
 If aCols[nX][nPosSts]=='2'
  aCols[nX][Len(aCols[n])]:=.T.
 Endif
Next
oGetD:oBrowse:Refresh()

Return

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43VldTp  態utor  彪laudinei Ferreira  � Data �  19/10/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     覓alidar Tipo da Solicitacao com itens requeridos como       滷�
控�          袈assagens, Diarias/Ajuda de Custo e Vouchers                滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function A43VldTp

Local lRet		:= .T.
Local cVouche	:= M->ZA6_VOUCHE
Local cHosp		:= M->ZA6_HOSPED
Local nDiaria	:= M->ZA6_DIARIA

cTpSol := M->ZA6_TPSOL 

//1=F.Fixo
If cTpSol $ '1' .AND. lA43Inclui
 For nX:=1 to Len(aCols)
  aCols[nX][Len(aCols[n])]:=.T.
 Next
  oGetD:oBrowse:Refresh() 
//2=Diaria; 3=Aj.Custo
ElseIf cTpSol$'2/3' .AND. lA43Inclui
 For nX:=1 to Len(aCols)
  aCols[nX][Len(aCols[n])]:=.F.
 Next
  oGetD:oBrowse:Refresh() 
Endif

If cTpSol=='1' .AND. (cVouche > 0 .OR. cHosp=='1' .OR. nDiaria > 0  )
 MsgStop("Para solicita誽o de Fundo Fixo n緌 � permitido selecionar: Passagens, Di嫫ias/Ajuda de Custo e Vouchers !",cCadastro)
 lRet := .F.
Endif

If cTpSol=='3' .AND. (nDiaria > 0 )
 MsgStop("Di嫫ias e Ajuda de Custo n緌 podem ser requisitadas na mesma Solicita誽o !",cCadastro)
 lRet := .F.
Endif

Return lRet

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43VldCols態utor  彪laudinei Ferreira  � Data �  20/10/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     覓alidacao da GetDados               						  滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

Static Function A43VldCols

Local nPosSts		:= aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_STS"})
Local lRet			:= .T.
Local lTrechoAtivo	:= .F.

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
//覓alida se possui um registro com STATUS = ATIVO e aCols nao esta deletado�
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
lTrechoAtivo:= aScan(aCols,{|x| (x[nPosSts]) == "1" .and. (x[Len(aCols[n])])=.F. }) > 0

If lA43Altera
	If !lTrechoAtivo .and. M->ZA6_TPSOL == '2' //1=F.Fixo; 2=Diaria; 3=Aj.Custo
		lRet:= .F.
		MsgStop("Deve existir um trecho com status ATIVO. Utilize a rotina para cancelamento da Solicita誽o,","Altera誽o n緌 permitida")
	Endif
Endif

Return(lRet)

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43FildOK 態utor  彪laudinei Ferreira  � Data �  20/10/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     覓alidacao da GetDados                                       滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function A43FildOK()

Local lRet		:= .T.
Local cForn 	:= M->ZA6_FORNEC
Local cLoja 	:= M->ZA6_LOJA
Local cTpVg 	:= M->ZA6_TPVIAG
Local cDtIni	:= Dtos(M->ZA6_DTINI)
Local cDtFim	:= Dtos(M->ZA6_DTFIM)

cTpSol:= M->ZA6_TPSOL

If Empty(cTpVg) .AND. !cTpSol=='1'
 MsgInfo("Para inclus緌 de trechos, o campo TIPO VIAGEM deve ser preenchido"," Aten誽o ")
 lRet:=.F.
ElseIf cTpSol == '1'
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
 //覓alida se Tipo da Solicitacao nao e Fundo Fixo, pois nao�
 //逍ode haver inclusao de Trechos                          �
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
 lRet:=.F.
 MsgInfo("Para solicita誽o de Fundo Fixo, n緌 � permitido a inclus緌 de trechos."," Aten誽o ")
Endif

//Valida campos obrigatorios da MSMGet
If lRet
	lRet := Obrigatorio(aGets,aTela)
Endif

Return lRet

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43FildAlt態utor  彪laudinei Ferreira  � Data �  20/10/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     覓alidacao da GetDados na Alteracao           滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function A43FildAlt(nNraCols)

Local lRet		:= .F. 
Local cField	:= Alltrim(ReadVar()) 
Local nPosDtCan := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_DTCANC"})

If !"ZA7_STS" $ cField .and. n > nNraCols
	lRet := .T.
ElseIf "ZA7_STS" $ cField .and. n <= nNraCols
	If !Empty(DTOS(aCols[n][nPosDtCan]))
		MsgStop("N緌 � poss癉el alterar o STATUS de um item j� cancelado.","Opera誽o n緌 Permitida")
	Else
		lRet := .T.
	Endif
Else
	MsgStop("Ao efetuar a Altera誽o da Solicita誽o de Viagem,"+;
	" n緌 � permitido mudan蓷 nos trechos inseridos anteriormente."+;
	CRLF+CRLF+ "Altere o campo de STATUS para CANCELADO e insira um novo registro.",;
	"Opera誽o n緌 Permitida")
Endif

Return lRet

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控矬闡闡闡闡鐃闡闡闡闡闡薩闡闡闡薩闡闡闡闡闡闡闡闡闡闡闡薩闡闡鐃闡闡闡闡闡膨�
控蚶un��o    莧fterCols � Autor � Claudinei Ferreira    � Data � 24/10/12 陰�
控藥闡闡闡闡霰闡闡闡闡闡謐闡闡闡謐闡闡闡闡闡闡闡闡闡闡闡謐闡闡鐘闡闡闡闡闡敢�
控蛇escri��o 蚶uncao executada apos inclusao de nova linha no aCols pela  陰�
控�          蚶illgetDados.                                               陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡敢�
控袋so       � Especifico CNI                                             陰�
控斂闡闡闡闡鐘闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡棱�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/
Static Function AfterCols(aCols)

Local nPosSTS  := GDFieldPos("ZA7_STS")

// Necessario para disparar inicializador padrao
aCols[Len(aCols)][nPosSTS] := CriaVar("ZA7_STS")

Return .T.

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43CalDia 態utor  彪laudinei Ferreira  � Data �  20/10/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     覓alida se as datas de Inicio e Fim sao validas e calcula    滷�
控�          這 numero de dias da viagem             					  滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function A43CalDia(cTpVld)

Local lRet 	  := .T.
Local cDTIni  := Dtos(M->ZA6_DTINI)
Local cDTFim  := Dtos(M->ZA6_DTFIM)

cTpSol:= M->ZA6_TPSOL /* 1=F.Fixo/2=Diaria/3=Aj.Custo */

//Limpa campos ao alterar Tipo de Solicitacao
M->ZA6_ADIANT:= 0
M->ZA6_DIARIA:= 0
M->ZA6_VOUCHE:= 0

If cTpVld =='Data'
 If Empty(cDTIni) .and. !Empty(cDTFim)
  lRet := .F.
  MsgInfo("Informe a data Inicial"," Aten誽o ")
 Elseif !Empty(cDTIni) .and. !Empty(cDTFim)
  If M->ZA6_DTINI > M->ZA6_DTFIM
   lRet := .F.
   MsgInfo("A data inicial deve ser menor que a data Final"," Aten誽o ")
  Endif
 Endif
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
 //袈ara Fundo Fixo ou Ajuda de Custo nao calcula Diaria�
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
Elseif cTpVld =='Diaria' .and. cTpSol =='2'
 if !Empty(cDTIni) .and. !Empty(cDTFim)
  M->ZA6_DIARIA:=(M->ZA6_DTFIM - M->ZA6_DTINI) + 1
 Elseif !Empty(cDTIni) .and. Empty(cDTFim)
  M->ZA6_DIARIA:= 0
 Endif
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
 //蛀xecuta rotina para calculo do Adiantamento �
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
 U_A43CalAdto()
Endif

Return lRet

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43CalAdto態utor  彪laudinei Ferreira  � Data �  21/10/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     彪alculo do Adiantamento conforme numero de diarias       	  滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function A43CalAdto()

Local cCatVg	:= ''
Local cCodDi	:= ''
Local nQtDia	:= M->ZA6_DIARIA
Local aCalAdiat	:= {}
Local nX  		:= 0
Local nResto 	:= 0
Local nVlAdto	:= 0
Local lRet		:=.T.
Local aArea   	:= GetArea()
Local aAreaZA2  := ZA2->(GetArea())
Local aAreaZA3  := ZA3->(GetArea())
Local aAreaZA4  := ZA4->(GetArea())

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
//蚯ocaliza o codigo da Categoria da Viagem �
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
cCatVg:= Posicione('ZA2',1,xFilial('ZA2')+M->ZA6_FORNEC+M->ZA6_LOJA+M->ZA6_TPVIAG,"ZA2_CATEG")

If !Empty(cCatVg) .AND. !Empty(M->ZA6_TPVIAG)
	//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
	//蚯ocaliza o Codigo do Calculo da Diaria �
	//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
	cCodDi:= Posicione('ZA4',1,xFilial('ZA4')+cCatVg,"ZA4_DIARIA")

	//矬闡闡闡闡闡闡闡 �
	//蛀xecuta Calculo �
	//斂闡闡闡闡闡闡闡 �
	If !Empty(cCodDi) .AND. nQtDia > 0
		
		DBSelectArea('ZA3')
		ZA3->(DbSetOrder(1))
		ZA3->(DbSeek(xFilial('ZA3')+cCodDi))
		ZA3->(dbEval({|| AADD(aCalAdiat,{ZA3_CODIGO,ZA3_FAIXA,ZA3_QUANT,ZA3_VALOR,ZA3_MOEDA})},, {|| ZA3_FILIAL+ZA3_CODIGO == xFilial('ZA3')+cCodDi }))
		
		nResto:= nQtDia
		For nX := 1 To Len(aCalAdiat)
			nResto:= nResto - aCalAdiat[nX][3]
			If nResto > 0 .OR. nResto = 0
				nVlAdto+=aCalAdiat[nX][3] * aCalAdiat[nX][4]
				If nResto = 0
					nX:=Len(aCalAdiat)
				Endif
			Else
				nSldDias:=aCalAdiat[nX][3]+nResto
				nVlAdto+=nSldDias * aCalAdiat[nX][4]
				nX:=Len(aCalAdiat)
			Endif
		Next nX
		M->ZA6_ADIANT:= nVlAdto
	Endif
Elseif !Empty(M->ZA6_TPVIAG)
	lRet:=.F.
	MsgStop("Solicitante n緌 possui cadastro de Fornecedor X Viagem X Di嫫ia, efetue cadastro.","Aten誽o")
Endif

RestArea(aAreaZA4)
RestArea(aAreaZA3)
RestArea(aAreaZA2)
RestArea(aArea)

Return(lRet)

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43Inclui 態utor  彪laudinei Ferreira  � Data �  21/10/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     蛄rava informacoes do cabecalho da Viagem e Trechos          滷� 
控�          袖olicitados                                                 滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

Static Function A43Inclui()

Local nPosItem := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_ITEM"})
Local nPOrigem := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_ORIGEM"})
Local nPDestin := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_DESTIN"})
Local nPDtDes  := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_DTDES"})
Local nPhDes   := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_HRDES"})
Local nPSts    := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_STS"})
Local nPDtCan  := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_DTCANC"})
Local nPNum    := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_NUM"})
Local lFindRec := .F.

Begin Transaction

If lA43Inclui
 dbSelectArea("ZA6")
 RecLock("ZA6",.T.)
 ZA6->ZA6_FILIAL    := xFilial('ZA6')
 ZA6->ZA6_NUM       := M->ZA6_NUM
 ZA6->ZA6_FORNEC    := M->ZA6_FORNEC
 ZA6->ZA6_LOJA      := M->ZA6_LOJA
 ZA6->ZA6_DTINI     := M->ZA6_DTINI
 ZA6->ZA6_DTFIM     := M->ZA6_DTFIM
 ZA6->ZA6_TPSOL     := M->ZA6_TPSOL
 ZA6->ZA6_VOUCHE    := M->ZA6_VOUCHE
 ZA6->ZA6_HOSPED    := M->ZA6_HOSPED
 ZA6->ZA6_VLRHSP    := M->ZA6_VLRHSP
 ZA6->ZA6_MOEDA     := M->ZA6_MOEDA
 ZA6->ZA6_ADIANT    := M->ZA6_ADIANT
 ZA6->ZA6_MOEDAD    := If(M->ZA6_TPSOL=='1',AllTrim(Str(M->ZA6_MOEDAD)),M->ZA6_MOEDAD)
 ZA6->ZA6_DIARIA    := M->ZA6_DIARIA
 ZA6->ZA6_CC        := M->ZA6_CC
 ZA6->ZA6_ITEM      := M->ZA6_ITEM
 ZA6->ZA6_CONTA     := M->ZA6_CONTA
 ZA6->ZA6_CLASSE    := M->ZA6_CLASSE
 ZA6->ZA6_OBS       := M->ZA6_OBS
 ZA6->ZA6_OBJETI    := M->ZA6_OBJETI
 ZA6->ZA6_TPVIAG    := M->ZA6_TPVIAG
 ZA6->ZA6_VLRPAS    := M->ZA6_VLRPAS
 ZA6->ZA6_BANCO     := M->ZA6_BANCO
 ZA6->ZA6_AGENCI    := M->ZA6_AGENCI
 ZA6->ZA6_XDVAGE    := M->ZA6_XDVAGE 
 ZA6->ZA6_NUMCON    := M->ZA6_NUMCON
 ZA6->ZA6_XDVCTA    := M->ZA6_XDVCTA 
 ZA6->ZA6_STATUS    := '1'
 ZA6->ZA6_USRINC	:= __cUserID
 ZA6->(MsUnlock())
 
 ConfirmSX8()
 
 If !cTpSOl == '1' //Fundo Fixo
  dbSelectArea("ZA7")
  For nX:=1 to Len(aCols)
   If !aCols[nX][Len(aCols[n])] //Deletado
    RecLock("ZA7",.T.)
    ZA7->ZA7_FILIAL := xFilial('ZA7')
    ZA7->ZA7_ITEM := aCols[nX][nPosItem]
    ZA7->ZA7_ORIGEM := AllTrim(aCols[nX][nPOrigem])
    ZA7->ZA7_DESTIN := AllTrim(aCols[nX][nPDestin])
    ZA7->ZA7_DTDES := aCols[nX][nPDtDes]
    ZA7->ZA7_HRDES := aCols[nX][nPhDes]
    ZA7->ZA7_NUM := aCols[nX][nPNum]
    ZA7->ZA7_STS := aCols[nX][nPSts]
    ZA7->(MsUnlock())
   Endif
  Next nX
 Endif
Endif

If lA43Altera
 For nX:=1 to Len(aCols)
  
  DBSelectArea("ZA7")
  ZA7->(DBSetOrder(1))
  lFindRec:= DbSeek(xFilial("ZA7")+ZA6->ZA6_NUM+aCols[nX][nPosItem])
  
  If !lFindRec .and. !aCols[nX][Len(aCols[n])]
   RecLock("ZA7",.T.)
   ZA7->ZA7_FILIAL := xFilial('ZA7')
   ZA7->ZA7_ITEM := aCols[nX][nPosItem]
   ZA7->ZA7_ORIGEM := AllTrim(aCols[nX][nPOrigem])
   ZA7->ZA7_DESTIN := AllTrim(aCols[nX][nPDestin])
   ZA7->ZA7_DTDES := aCols[nX][nPDtDes]
   ZA7->ZA7_HRDES := aCols[nX][nPhDes]
   ZA7->ZA7_NUM := aCols[nX][nPNum]
   ZA7->ZA7_STS := aCols[nX][nPSts]
  Else
   RecLock("ZA7",.F.)
   If !aCols[nX][Len(aCols[n])] //Deletado
    Replace ZA7->ZA7_STS With aCols[nX][nPSts]
    If aCols[nX][nPSts]=='2'
      Replace ZA7->ZA7_DTCANC With DDataBase
    Endif
   ElseIf aCols[nX][Len(aCols[n])] .and. lFindRec .and. !ZA7->ZA7_STS=='2'
    Replace ZA7->ZA7_STS With '2'
    Replace ZA7->ZA7_DTCANC With DDataBase
   Endif
  Endif
  ZA7->(MsUnlock())
 Next nX

 //Solicitacao volta para o Status inicial
 dbSelectArea("ZA6")
 RecLock("ZA6",.F.)
 Replace ZA6->ZA6_STATUS With '1'
 ZA6->(MsUnlock())

Endif

End Transaction

Return

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43Aprv   態utor  彪laudinei Ferreira  � Data �  05/11/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     袒otina de Aprovacao da Solicitacao de viagem/Fundo Fixo     滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function A43Aprv(cTpAprov)

Local cEmail	:= ''
Local cTpUsr	:= ''
Local cPrFFixo 	:= GetMv("SI_xFFIXO",.F.,"FFX")
Local cPrDiaria := GetMv("SI_xDIARIA",.F.,"DIA")
Local cPrACusto := GetMv("SI_XACUSTO",.F.,"AJC")
Local cTpTitulo	:= GetMv("SI_XTPTITV",.F.,"DP")
Local cPrefixo 	:= ''
Local cNumPar	:= ''
Local cParcSE2	:= Space(TamSX3("E2_PARCELA")[1])
Local aAprv  	:= {}
Local lOkAprov  := .T.
Local cMsg      := ""

Private lMsErroAuto := .F.

cTpSol:=ZA6->ZA6_TPSOL

If cTpAprov == 'ADM'
	If MsgYesNo("Confirma envio da Solicita誽o para Aprova誽o do Gestor ?","Aten誽o")
		                                                                               		
		//Localiza Gestores
		aAprv:=u_GrpGestor()
		
		For nX:=1 to Len(aAprv)
			cEmail:= IIf(Empty(cEmail),AllTrim(aAprv[nX][2]),cEmail+ ";" + AllTrim(aAprv[nX][2]))
		Next
		
		//Envia e-mail para Aprovacao do Gestor
		cMensagem:= U_Geramail(cNrSol,ZA6->ZA6_OBJETI)
		FSSendMail( cEmail, "Cota蓷o Aprovada - Solicita誽o de Viagem: "+cNrSol, cMensagem )
		
		dbSelectArea("ZA6")
		
		//Aguardando Aprovacao do Gestor
		RecLock("ZA6",.F.)
		Replace ZA6_STATUS With '4'
		Replace ZA6_CAPROB With __cUserID
		Replace ZA6_DTAPRA With Dtoc(Date())+"-"+Time()
		ZA6->(MsUnlock())
		
		MsgInfo("Solicita誽o enviada para Aprova誽o do Gestor !","Cota誽o Aprovada")
	Endif
ElseIf cTpAprov =='APR'
    
	lOkAprov := U_ValAprov(ZA6->ZA6_CC,ZA6->ZA6_ITEM,ZA6->ZA6_TPVIAG)
	
	If lOkAprov
	
		//Rev* Validar se existe cotacao aprovada conforme trecho
		If ZA6->ZA6_STATUS == '4'
			If MsgYesNo("Confirma a aprova誽o da Solicita誽o ?","Aten誽o")
				
				Do Case
					Case cTpSol == '1'
						cPrefixo:= cPrFFixo
					Case cTpSol == '2'
						cPrefixo:= cPrDiaria
					Case cTpSol == '3'
						cPrefixo:= cPrACusto
				EndCase
				
				//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
				//蚯ocaliza o ultimo numero da parcela para gerar Titulo�
				//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
				BEGINSQL ALIAS "TRBSE2"
					
					SELECT
					MAX(E2_PARCELA) NUMPARC
					FROM  %table:SE2% SE2
					WHERE  SE2.%notDel%
					AND E2_FILIAL  = %exp:xFilial("SE2")%
					AND E2_PREFIXO = %exp:cPrefixo%
					AND E2_NUM = %exp:cNrSol%
					
				ENDSQL
				cNumPar:= If(Empty(TRBSE2->NUMPARC),"001",Soma1(TRBSE2->NUMPARC))
				
				//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
				//蚶echa o temporario                |
				//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
				TRBSE2->(dbCloseArea())
				
				//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
				//蛄erar Titulo no Financeiro     �
				//袈ossui Adiantamento ?          �
				//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
				Begin Transaction
				
				If ZA6->ZA6_ADIANT > 0
					cPrefixo := cPrefixo        	// Prefixo do Titulo
					cNum     := cNrSol         		// Numero do Titulo
					cParcela := cNumPar        		// Parcela do pedido
					cTipo    := cTpTitulo        	// Tipo do Titulo
					
					// Natureza
					If Alltrim(cPrefixo)	== cPrACusto //'AJC'
						//cNaturez := '10009001'
						//cNaturez := '2070201'
						cNaturez := Alltrim(GetMv("MV_XNATAJC"))
					Elseif Alltrim(cPrefixo) == cPrDiaria //'DIA'
						//cNaturez := '10009001'
						//cNaturez := '2070201'
						cNaturez := Alltrim(GetMv("MV_XNATDIA"))
					Elseif Alltrim(cPrefixo) == cPrFFixo //'FFX'
						//cNaturez	:= '10009002'
						//cNaturez	:= '2070201'
						cNaturez := Alltrim(GetMv("MV_XNATFFX"))
						
					Endif
					
					cContaD  := ZA6->ZA6_CONTA      // Conta Debito
					cCCustoD := ZA6->ZA6_CC			// Centro de Custo de Debito
					cItemD	 := ZA6->ZA6_ITEM		// Item Contabil de Debito
					cFornece := ZA6->ZA6_FORNEC     // Codigo do FORNECEDOR
					cLoja    := ZA6->ZA6_LOJA       // Loja do FORNECEDOR
					dEmissao := ddataBase        	// Data de emissao    
					If ZA6->ZA6_DTINI > dDataBase
						dVencto  := ZA6->ZA6_DTINI - 1      // Data do vencimento
						dVencRea := ZA6->ZA6_DTINI - 1    	// Vencimento Real    
					Else
						dVencto  := ZA6->ZA6_DTINI + 1     // Data do vencimento
						dVencRea := ZA6->ZA6_DTINI + 1   	// Vencimento Real
					EndIf
					nValor   := ZA6->ZA6_ADIANT     // Valor do titulo
					nMoeda   := ZA6->ZA6_MOEDA      // Moeda
					cBanco   := ZA6->ZA6_BANCO      // Banco
					cAgencia := ZA6->ZA6_AGENCI     // Agencia
					cDvAg	 := ZA6->ZA6_XDVAGE		// Digito Agencia
					cConta   := ZA6->ZA6_NUMCON     // Conta
					cDvCta	 := ZA6->ZA6_XDVCTA		// Dv Conta
					cUO    	 := ZA6->ZA6_CC         // Centro de Custo
					citem    := ZA6->ZA6_ITEM       // Item Contabil
					cClasVlr := ZA6->ZA6_CLASSE		// Classe de Valor
					cHist    := "ADT VIAGEM:"+cNrSol // Historico
					
					aColsSE2 := {}
					
					aAdd(aColsSE2,{"E2_FILIAL"  	,xFilial("SE2") ,Nil}) // Codigo da Filial
					aAdd(aColsSE2,{"E2_PREFIXO"  	,cPrefixo	,Nil}) // Prefixo do Titulo
					aAdd(aColsSE2,{"E2_NUM"   		,cNum   	,Nil}) // Numero do Titulo
					aAdd(aColsSE2,{"E2_PARCELA"  	,cParcela  	,Nil}) // Parcela do pedido
					aAdd(aColsSE2,{"E2_TIPO"  		,cTipo   	,Nil}) // Tipo do Titulo
					aAdd(aColsSE2,{"E2_FORNECE"  	,cFornece  	,Nil}) // Codigo do FORNECEDOR
					aAdd(aColsSE2,{"E2_LOJA"  		,cLoja   	,Nil}) // Loja do FORNECEDOR
					aAdd(aColsSE2,{"E2_EMISSAO"  	,dEmissao  	,Nil}) // Data de emissao
					aAdd(aColsSE2,{"E2_VENCTO"  	,dVencto  	,Nil}) // Data do vencimento
					aAdd(aColsSE2,{"E2_VENCREA"  	,dVencRea  	,Nil}) // Vencimento Real
					aAdd(aColsSE2,{"E2_MOEDA"  		,Val(nMoeda),Nil}) // Moeda
					aAdd(aColsSE2,{"E2_NATUREZ"		,cNaturez	,Nil}) // Natureza
					aAdd(aColsSE2,{"E2_VALOR"  		,nValor   	,Nil}) // Valor do titulo
					aAdd(aColsSE2,{"E2_SALDO"  		,nValor   	,Nil}) // Saldo do titulo
					aAdd(aColsSE2,{"E2_CONTAD" 		,cContaD   	,Nil}) // Conta de Debito
					aAdd(aColsSE2,{"E2_CCD" 		,cCCustoD  	,Nil}) // Centro de Custo de Debito
					aAdd(aColsSE2,{"E2_ITEMD" 		,cItemD  	,Nil}) // Item Contabil de Debito
					aAdd(aColsSE2,{"E2_CLVLDB" 		,cClasVlr  	,Nil}) // Classe de Valor
					aAdd(aColsSE2,{"E2_XBANCO"  	,cBanco   	,Nil}) // Banco
					aAdd(aColsSE2,{"E2_XAGENC"  	,cAgencia  	,Nil}) // Agencia
					aAdd(aColsSE2,{"E2_XDVAGE"  	,cDvAg  	,Nil}) // DV Agencia						
					aAdd(aColsSE2,{"E2_XNUMCON"  	,cConta   	,Nil}) // Numero da Conta
					aAdd(aColsSE2,{"E2_XDVCTA"  	,cDvCta   	,Nil}) // DV Numero da Conta
					aAdd(aColsSE2,{"E2_ITEMD"  		,cItem   	,Nil}) // Item Contabil
					aAdd(aColsSE2,{"E2_HIST"  		,cHist   	,Nil}) // Historico
					
					MSExecAuto({|x,y,z| FINA050(x,y,z)},aColsSE2,3)
					
					If lMsErroAuto
						DisarmTransaction()
						MostraErro()
					Endif
					
					IF !lMsErroAuto
						//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡� �
						//蛀nviar Email para Usuario ADM Adiantamento�
						//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡� �
						cTpUsr:= '2'
						BEGINSQL ALIAS "TRBZA8"
							
							SELECT
							ZA8_USER, ZA8_EMAIL
							
							FROM  %table:ZA8% ZA8
							
							WHERE  ZA8.%notDel%
							AND ZA8_FILIAL   = %exp:xFilial("ZA8")%
							AND ZA8_TIPO     = %exp:cTpUsr%
							AND ZA8.ZA8_USER = %exp:__cUserId%
							
						ENDSQL
						
						TRBZA8->(dbEval({|| AADD(aAprv,{ZA8_USER,ZA8_EMAIL})},, {|| !EOF() }))
						
						For nX:=1 to Len(aAprv)
							cEmail:= IIf(Empty(cEmail),AllTrim(aAprv[nX][2]),cEmail+ ";" + AllTrim(aAprv[nX][2]))
						Next
						
						//Fecha o temporario
						TRBZA8->(dbCloseArea())
						
						cMensagem:= U_Geramail(M->ZA6_NUM,M->ZA6_OBJETI)
						FSSendMail( cEmail, "Adiantamento Gerado - Solicita誽o de Viagem: "+cNrSol, cMensagem )
						                                                          
						If ZA6->ZA6_HOSPED == "1"
						
							//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
							//蛀nviar Email para Agencia para aquisicao das Passagens�
							//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
							cMensagem:= U_Geramail(cNrSol,ZA6->ZA6_OBJETI)
							FSSendMail( cEmailAg, "Aquisi誽o de Passagens Autorizada - Solicita誽o de Viagem: " +cNrSol, cMensagem )
							
						EndIf
						
					Endif
				Endif   
				//矬闡闡闡闡闡闡闡闡闡闡闡闡闡� �
				//莧ltera Status da Solicitacao �
				//斂闡闡闡闡闡闡闡闡闡闡闡闡闡� �
				RecLock("ZA6",.F.)
				Replace ZA6_STATUS With '5' //Aprovada pelo Gestor
				ZA6->(MsUnlock())
				
				//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
				//蛄era registro na tabela ZAA para permitir Presta誽o de Contas�
				//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
				dbSelectArea("ZAA")
				RecLock("ZAA",.T.)
				ZAA->ZAA_FILIAL    := xFilial("ZA6")
				ZAA->ZAA_NUM       := ZA6->ZA6_NUM
				ZAA->ZAA_FORNEC    := ZA6->ZA6_FORNEC
				ZAA->ZAA_LOJA      := ZA6->ZA6_LOJA
				ZAA->ZAA_DTINI     := ZA6->ZA6_DTINI
				ZAA->ZAA_DTFIM     := ZA6->ZA6_DTFIM
				ZAA->ZAA_TPSOL     := ZA6->ZA6_TPSOL
				ZAA->ZAA_VOUCHE    := ZA6->ZA6_VOUCHE
				ZAA->ZAA_HOSPED    := ZA6->ZA6_HOSPED
				ZAA->ZAA_VLRHSP    := ZA6->ZA6_VLRHSP
				ZAA->ZAA_MOEDA     := ZA6->ZA6_MOEDA
				ZAA->ZAA_ADIANT    := ZA6->ZA6_ADIANT
				ZAA->ZAA_MOEDAD    := ZA6->ZA6_MOEDAD
				ZAA->ZAA_DIARIA    := ZA6->ZA6_DIARIA
				ZAA->ZAA_CC        := ZA6->ZA6_CC
				ZAA->ZAA_ITEM      := ZA6->ZA6_ITEM
				ZAA->ZAA_CONTA     := ZA6->ZA6_CONTA
				ZAA->ZAA_CLASSE    := ZA6->ZA6_CLASSE
				ZAA->ZAA_OBS       := ZA6->ZA6_OBS
				ZAA->ZAA_OBJETI    := ZA6->ZA6_OBJETI
				ZAA->ZAA_TPVIAG    := ZA6->ZA6_TPVIAG
				ZAA->ZAA_VLRPAS    := ZA6->ZA6_VLRPAS
				ZAA->ZAA_BANCO     := ZA6->ZA6_BANCO
				ZAA->ZAA_AGENCI    := ZA6->ZA6_AGENCI
				ZAA->ZAA_XDVAGE	   := ZA6->ZA6_XDVAGE
				ZAA->ZAA_NUMCON    := ZA6->ZA6_NUMCON
				ZAA->ZAA_XDVCTA    := ZA6->ZA6_XDVCTA
				ZAA->ZAA_STATUS	  := '1'
				ZAA->(MsUnlock())
				End Transaction
				MsgInfo("Aprova誽o realizada com sucesso.","Aviso")
			Endif
		Else
			MsgInfo("O status desta solicita誽o n緌 permite aprova誽o, verifique status atual."," Aten誽o ")
	
		Endif
	
	Else
	                 
		cMsg := "Centro de Custo, Item Cont墎il ou Tipo de Viagem da Solicita誽o de Viagem � incompativel com o aprovador. "
		cMsg += "Verifique o cadastro de Al蓷das de Viagens."
		Aviso("Aten誽o!",cMsg,{"Ok"},2,"")
		
	EndIf
	
Endif

Return

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43Reprv  態utor  彪laudinei Ferreira  � Data �  05/11/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     袒otina de Reprovacao da Solicitacao de viagem/Fundo Fixo    滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function A43Reprv(cTpAprov)

If cTpAprov == 'ADM'
 dbSelectArea("ZA6")
 RecLock("ZA6",.F.)
 Replace ZA6_STATUS With '2'
 ZA6->(MsUnlock())
 
 //Envia e-mail para Agencia
 cMensagem:= U_Geramail(cNrSol,ZA6->ZA6_OBJETI)
 FSSendMail( cEmailAg, "Cota誽o Reprovada - Solicita誽o de Viagem: " +cNrSol, cMensagem )
 
 MsgInfo("Solicita誽o reprovada, envio de e-mail efetuado para Ag瘽cia de Viagens!","Cota誽o Reprovada")

ElseIf cTpAprov == 'APR'
 dbSelectArea("ZA6")
 RecLock("ZA6",.F.)
 Replace ZA6_STATUS With '8'
 ZA6->(MsUnlock())
 
Endif

Return

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43Canc   態utor  彪laudinei Ferreira  � Data �  05/11/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     袒otina de Reprovacao da Solicitacao de viagem/Fundo Fixo    滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function A43Canc

Local lContinua := .T.
Local aTits		:= {}
Local cCodFor	:= ZA6->ZA6_FORNEC
Local cCodLj	:= ZA6->ZA6_LOJA
Local cNum		:= ZA6->ZA6_NUM 
Local nX		:= 1

If MsgYesNo("Confirma Cancelamento ?","Aten誽o")
	
	BEGINSQL ALIAS "TRBSE2"
		SELECT
		E2_FORNECE, E2_LOJA, E2_NUM, E2_PREFIXO, E2_PARCELA, E2_STATUS, E2_VALOR, E2_SALDO, E2_NUMBOR, E2_OCORREN
		FROM  %table:SE2% SE2
		WHERE  SE2.%notDel%
		AND E2_FILIAL 	= %exp:xFilial("SE2")%
		AND E2_FORNECE  = %exp:cCodFor%
		AND E2_LOJA	    = %exp:cCodLj%
		AND E2_NUM	    = %exp:cNum%
	ENDSQL
	
	TRBSE2->(dbEval({|| AADD(aTits,{E2_FORNECE,E2_LOJA,E2_NUM,E2_PREFIXO,E2_PARCELA,E2_STATUS,E2_VALOR,E2_SALDO,E2_NUMBOR,E2_OCORREN})},, {|| !EOF() }))
	TRBSE2->(dbCloseArea())
	
	While nX <= Len(aTits) .and. lContinua
		//Verifica se titulo foi baixado Total/Parcial, cheque gerado ou baixado por renegociacao
		If !(aTits[nX][7] == aTits[nX][8]) .Or. !Empty(AllTrim(aTits[nX][6]))
			lContinua := .F.
			MsgStop("Solicita誽o com T癃ulo baixado Parcial ou Total, realize a Presta誽o de Contas."+CRLF+"" ,"Opera誽o n緌 Permitida")
		Else
			//Verifica de Titulo nao esta em Bordero
			If ( !Empty(AllTrim(aTits[nX][9])) .And. (AllTrim(aTits[nX][10]) $ "00/03/BD/BE" .or. Empty(aTits[nX][10]) ))
				lContinua := .F.
				MsgStop("Solicita誽o possui T癃ulo gerado em Border�, realize a Presta誽o de Contas."+CRLF+"" ,"Opera誽o n緌 Permitida")
			Endif
		Endif
		nX++
		Loop
	Enddo
	
	//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
	//蛀xecuta rotina para Gravacao da Reprovacao�
	//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
	If lContinua
		A43GvrCanc(aTits)
	Endif
Endif

Return

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43GvrCanc態utor  彪laudinei Ferreira  � Data �  05/11/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     袒otina para Gravacao da Solicitacao de viagem/Fundo Fixo    滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

Static Function A43GvrCanc(aTits)

Local aRet   := {}
Local aParamBox := {}
Local cCadastro := ""
Local cPrFFixo := GetMv("SI_xFFIXO",.F.,"FFX")
Local cPrDiaria := GetMv("SI_xDIARIA",.F.,"DIA")
Local cPrACusto := GetMv("SI_XACUSTO",.F.,"AJC")
Local aAprv		:= {}
Local cEmail	:= ''
Local cNrSol	:= ZA6->ZA6_NUM
Local lMsErroAuto := .F.

cTpSol:=ZA6->ZA6_TPSOL

aAdd(aParamBox,{1,"Motivo " ,Space(200),"","","" ,"",,.T.})
If ParamBox(aParamBox,"CANCELAR - Motivo do Cancelamento",@aRet)
	Begin Transaction
	
	dbSelectArea("ZA6")
	RecLock("ZA6",.F.)
	Replace ZA6_STATUS With '7'
	Replace ZA6_USRCAN With __cUserID
	Replace ZA6_DTCANC With DDatabase
	Replace ZA6_MOTCAN With Alltrim(aRet[1])
	ZA6->(MsUnlock())
	
	//Efetuar a exclusao do Titulo no Financeiro
	Do Case
		Case cTpSol == '1'
			cPrefixo:= cPrFFixo
		Case cTpSol == '2'
			cPrefixo:= cPrDiaria
		Case cTpSol == '3'
			cPrefixo:= cPrACusto
	EndCase
	
	DbSelectArea("SE2")
	SE2->(DbSetOrder(6)) //E2_FILIAL+E2_FORNECE+E2_LOJA+E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO
	If SE2->(MsSeek(xFilial("SE2")+ZA6->ZA6_FORNEC+ZA6->ZA6_LOJA+cPrefixo+ZA6->ZA6_NUM))
		
		aTitulo:= {}
		aTitulo := {   {"E2_FILIAL"  	,xFilial("SE2") ,Nil},;
		{"E2_PREFIXO"	, SE2->E2_PREFIXO	,	Nil},;
		{"E2_NUM"		, SE2->E2_NUM		, 	Nil},;
		{"E2_PARCELA"	, SE2->E2_PARCELA	,	Nil},;
		{"E2_TIPO"		, SE2->E2_TIPO		, 	Nil},;
		{"E2_NATUREZ"	, SE2->E2_NATUREZA	,	Nil},;
		{"E2_FORNECE"	, SE2->E2_FORNECE	,   Nil},;
		{"E2_LOJA"		, SE2->E2_LOJA		,	Nil},;
		{"E2_MOEDA"		, Val(ZA6->ZA6_MOEDAD),	NIL}}
		
		MSExecAuto({|x,y,z| FINA050(x,y,z)},aTitulo,,5)
		
		If lMsErroAuto
			DisarmTransaction()
			MostraErro()
		Else
			//Grava Status na Prestacao de Contas = Solicitacao Cancelada
			ZAA->(DbSelectArea("ZAA"))
			If ZAA->(DbSeek(xFilial("ZAA")+ZA6->(ZA6_NUM+ZA6_FORNEC+ZA6_LOJA)))
				RecLock("ZAA",.F.)
				ZAA->ZAA_STATUS	  := '7'
				ZAA->(MsUnlock())
			Endif
			
			//Enviar Mensagens conforme Usuario tipo 1-ADM Cotacao
			cTpEmail :='1'
			BEGINSQL ALIAS "TRBZA8"
				
				SELECT
				ZA8_USER, ZA8_EMAIL
				
				FROM  %table:ZA8% ZA8
				
				WHERE  ZA8.%notDel%
				AND ZA8_FILIAL = %exp:xFilial("ZA8")%
				AND ZA8_TIPO   = %exp:cTpEmail%
				
			ENDSQL
			
			TRBZA8->(dbEval({|| AADD(aAprv,{ZA8_USER,ZA8_EMAIL})},, {|| !EOF() }))
			
			For nX:=1 to Len(aAprv)
				cEmail:= IIf(Empty(cEmail),AllTrim(aAprv[nX][2]),cEmail+ ";" + AllTrim(aAprv[nX][2]))
			Next
			
			//Fecha o temporario
			TRBZA8->(dbCloseArea())
			
			If !Empty(cEmail)
				cMensagem:= U_Geramail(cNrSol,ZA6->ZA6_OBJETI)
				FSSendMail( cEmail, "Cancelada - Solicita誽o de Viagem: "+cNrSol, cMensagem )
			Endif	
				
				//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
				//蛀nviar Email para Agencia para aquisicao das Passagens�
				//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
			If !Empty(cEmailAg)
				cMensagem:= U_Geramail(cNrSol,ZA6->ZA6_OBJETI)
				FSSendMail( cEmailAg, "Cancelada - Solicita誽o de Viagem: " +cNrSol, cMensagem )
			Endif
		Endif
	Endif
	End Transaction
Endif

Return

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43EnvApr 態utor  彪laudinei Ferreira  � Data �  05/11/11   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     袒otina para Gravacao da Solicitacao de Viagem/Fundo Fixo    滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       蛀specifico CNI (Controle de Viagens)                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/
User Function A43EnvApr

Local cStatus := ZA6->ZA6_STATUS
Local aAprv  := {}
Local cQuery := ''
Local cEmail := ''
Local cTitulo := ''
Local cNrSol := ZA6->ZA6_NUM

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
//覓erifcar se Solicitacao posicionada possui Passagens/Trechos�
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
DbSelectArea("ZA7")
ZA7->(DbSetOrder(1))

If cStatus == '1'
	If DbSeek(xFilial('ZA7')+ZA6->ZA6_NUM) .or. ZA6->ZA6_HOSPED=='1'
		//Aguardando Passagem/Hospedagem
		cStatus:= '2'
		cTitulo:= "Passagem/Hospedagem Solicita誽o: " +cNrSol
		cEmail:= cEmailAg
	Else
		//Aguardando Aprovacao do Gestor
		cStatus:='4'
		cTitulo:= "Solic.F.Fixo para Aprova誽o: "+cNrSol
		
		//Localiza Gestores
		aAprv:= U_GrpGestor()
		
		For nX:=1 to Len(aAprv)
			cEmail:= IIf(Empty(cEmail),AllTrim(aAprv[nX][2]),cEmail+ ";" + AllTrim(aAprv[nX][2]))
		Next
	Endif
	
	//Envia e-mail para Agencia/Aprovacao do Gestor
	If Empty(cEmail)
		cStatus:='1'

		MsgInfo("N緌 foi poss癉el enviar e-mail para o Gestor Aprovador."+;
		CRLF+"Verifique cadastro *Al蓷das de Viagens* para este C.C e Item Cont墎il.","E-mail n緌 encontrado")
	Else
		cMensagem:= U_Geramail(cNrSol,ZA6->ZA6_OBJETI)
		FSSendMail( cEmail,cTitulo,cMensagem )
	Endif
	
	
	dbSelectArea("ZA6")
	RecLock("ZA6",.F.)
	Replace ZA6_STATUS With cStatus
	ZA6->(MsUnlock())
Else
	MsgStop("Esta solicita誽o foi enviada anteriormente para Aprova誽o.","Aten誽o")
Endif

Return

/*/
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控矬闡闡闡闡鐃闡闡闡闡闡薩闡闡闡薩闡闡闡闡闡闡闡闡闡闡闡薩闡闡鐃闡闡闡闡闡膨�
控袈rograma  蛉enuDef   � Autor � TOTVS        � Data �16/10/2012陰�
控藥闡闡闡闡霰闡闡闡闡闡謐闡闡闡謐闡闡闡闡闡闡闡闡闡闡闡謐闡闡鐘闡闡闡闡闡敢�
控蛇escri��o � Utilizacao de menu Funcional                               陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡敢�
控袒etorno   莧rray com opcoes da rotina.                                 陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡敢�
控袈arametros袈arametros do array a Rotina:                               陰�
控�          �1. Nome a aparecer no cabecalho                             陰�
控�          �2. Nome da Rotina associada                                 陰�
控�          �3. Reservado                                                陰�
控�          �4. Tipo de Transa��o a ser efetuada:                        陰�
控�          �    1 - Pesquisa e Posiciona em um Banco de Dados           陰�
控�          �    2 - Simplesmente Mostra os Campos                       陰�
控�          �    3 - Inclui registros no Bancos de Dados                 陰�
控�          �    4 - Altera o registro corrente                          陰�
控�          �    5 - Remove o registro corrente do Banco de Dados        陰�
控�          �5. Nivel de acesso                                          陰�
控�          �6. Habilita Menu Funcional                                  陰�
控斂闡闡闡闡鐘闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡棱�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
/*/

Static Function MenuDef()

Private aRotina := {}

//矬闡闡闡闡闡闡闡闡闡闡�
//� Inicializa aRotina  �
//斂闡闡闡闡闡闡闡闡闡闡�
aAdd(aRotina,{"Pesquisar",    		"AxPesqui"		, 0 , 1, 0, .F.})  //"Pesquisar"
aAdd(aRotina,{"Visualiza",   		"U_A43MntSV" 	, 0 , 2, 0, nil})  //"Visualiza"
aAdd(aRotina,{"Incluir",    		"U_A43MntSV" 	, 0 , 3, 0, nil})  //"Incluir"
aAdd(aRotina,{"Alterar",    		"U_A43MntSV" 	, 0 , 4, 0, nil})  //"Altera"
aAdd(aRotina,{"Cancelar",    		"U_A43Canc"  	, 0 , 5, 0, nil})  //"Cancelar"
aAdd(aRotina,{"Enviar p/ Aprovacao","U_A43EnvApr" 	, 0 , 2, 0, nil})  //"Enviar para Aprovacao"
aAdd(aRotina,{"Legenda",    		"U_A43Legenda" 	, 0 , 2, 0, .F.}) //"Legenda"

Return(aRotina)

/*/
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控
控矬闡闡闡闡鐃闡闡闡闡闡薩闡闡闡薩闡闡闡闡闡闡闡闡闡闡闡薩闡闡鐃闡闡闡闡闡醴控
控蚶un��o    莧43Legend 莧utor  � Claudinei Ferreira    � Data �16.10.2012 陰�
控藥闡闡闡闡霰闡闡闡闡闡謐闡闡闡謐闡闡闡闡闡闡闡闡闡闡闡謐闡闡鐘闡闡闡闡闡譬控
控�          蛇emonstra a legenda das cores da mbrowse                     陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡譬控
控袈arametros術enhum                                                       陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡譬控
控袒etorno   術enhum                                                       陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡譬控
控蛇escri��o 蛀sta rotina monta uma dialog com a descricao das cores da    陰�
控�          蛉browse.                                                     陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡譬控
控袋so       � CNI-Solicitacao de Viagens e Fundo Fixo                     陰�
控斂闡闡闡闡鐘闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁控
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔
/*/

User Function A43Legend()

Local aCores := {}

aCores := {{'ENABLE'	,"Nao enviada para aprovacao"},;      
           {'BR_LARANJA',"Aguardando Passagem/Hospedagem"},;    
           {'BR_AMARELO'	,"Aguardando Validacao"},;
           {'BR_PRETO'	,"Aguardando Aprovacao do Gestor"},;
		   {'BR_AZUL'	,"Aprovada pelo Gestor"},;
           {'BR_VERMELHO'	,"Finalizada"},;
           {'BR_PINK'	,"Solicitacao Cancelada"},;
           {'LIGHTBLU' 	,"Reprovada pelo Gestor"}}

BrwLegenda("","Solicita誽o de Viagem",aCores)

Return(.T.)

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  蛄eramail  態utor  彪laudinei Ferreira  � Data �  23/11/12   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     蛄era HTML para envio do e-mail                              滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       � Especifico CNI                                             滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function Geramail(cNrSol,cObjSol)

Local cMsg:= ""
Local cUrlLgl:= GetMv("SI_HTTPLGL",.F.,"")
Local cLkWeb := GetMv("SI_XLKWEB",.F.,"")
Local lATVLNK	:= GetMv("SI_ATVLNK")

cMsg :='<html>'
cMsg += '<head>'
cMsg += '<title>Untitled Document</title>'
cMsg += '</head>'
cMsg += '<body>'
cMsg += '<form name="form1" method="post" action="mailto:%WFMailTo%">'
cMsg += '  <table width="100%" height="23" border="0" vspace="0" hspace="0" cellspacing="0" cellpadding="0">'
cMsg += '    <tr>'
cMsg += '      <td bgcolor="#DEAE63" rowspan="2" style="font-size: 8pt">'
cMsg += '        <p align="left">'
cMsg += '  <img src= "' + cUrlLgl + '" width="130" height="40"></p>'
cMsg += '      </td>'
cMsg += '      <td width="99%" bgcolor="#003063" style="font-size: 8pt">' 
cMsg += '        <p align="right">'
cMsg += '        <font face="Arial" size="4" color="#FFFFFF"><span style="background-color: #003473">Notifica誽o Protheus</span></font></p>'
cMsg += '      </td>'
cMsg += '    </tr>'
cMsg += '    <tr>' 
cMsg += '      <td width="100%" bgcolor="#DEAE63" style="font-size: 8pt">&nbsp;</td>'
cMsg += '    </tr>'
cMsg += '  </table>'
cMsg += '  <font size="4">'
cMsg += '<p><font face="Arial">' 
cMsg += '         <span lang="pt-br"><font size="2">Prezado(a),</font></span></font></p>'
cMsg += ' <p><font face="Arial" size="2">Houve mudan蓷 de status na solicita誽o de Viagem/Fundo Fixo de n𤦤ero:  ' + cNrSol + ' , acesse'
cMsg += '        o ERP para continuidade no processo.</a></font></p>'
cMsg += ' <p></p>'
cMsg += ' <p><font face="Arial" size="2">Empresa/Filial : '+SM0->M0_CODFIL+' - '+SM0->M0_NOME+'. </a></font></p>'
cMsg += ' <p></p>'
cMsg += ' <p><font face="Arial" size="2">Objetivo da Solicita誽o:' +cObjSol+ '</font></p>'
cMsg += ' <p></p>'
If lATVLNK	// T acessa o link
	cMsg += ' <p>Clique no link para acesso ao ' +cLkWeb+ '</p>'
Else
	cMsg += ' <p>Favor acessar o ERP para libera誽o da Solicita誽o. </p>'
EndIf
cMsg += ' <p></p>'
cMsg += ' <p><font face="Arial" size="2">Favor n緌 responder este e-mail.</font></p>'
cMsg += '  </form>'
cMsg += '</body>'
cMsg += '</html>'

Return(cMsg)

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  蛉ailUser  態utor  彪laudinei Ferreira  � Data �  19/11/12   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     覓erifica email do responsavel pelo C.Custo(UO)              滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       � Especifico CNI                                             滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function MailUser(cCodUsr)

Local cEmail

PswOrder(1)
If PswSeek( cCodUsr )
 cEmail := PswRet()[1,14]
Endif

Return(cEmail)

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧naliCot  態utor  彪laudinei Ferreira  � Data �  19/11/12   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     莧nalisa Cotacao                                             滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       � Especifico CNI                                             滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

Static Function AnaliCot(cTpAprov)

Local lMark     := .F.
Local aHeadSV := {}
Local aColsSV := {}
Local nOpca     := 0
Local oOk       := LoadBitmap( GetResources(), "CHECKED" )
Local oNo       := LoadBitmap( GetResources(), "UNCHECKED" )
Local cTitulo   := "Analisa Cota誽o"
Local oDlgC     := NIL
Local oLbx      := NIL
Local cItemSV
Local cNum  := ZA6->ZA6_NUM
Local cCodFor := ZA6->ZA6_FORNEC
Local cLojFor := ZA6->ZA6_LOJA

Private lChk    := .F.
Private aVetor  := {}

aHeadSV := aClone(aHeader)
aColsSV := aClone(aCols)

cItemSV := aColsSV[n][1]

BEGINSQL ALIAS "TRBZAD"
 
 SELECT
 ZAD_ITEMC, ZAD_CIA, ZAD_DATA, ZAD_HRSAI, ZAD_HRCHE, ZAD_VLR, ZAD_STATUS, R_E_C_N_O_ RECNOZAD
 
 FROM  %table:ZAD% ZAD
 
 WHERE  ZAD.%notDel%
 AND ZAD_FILIAL  = %exp:xFilial("ZAD")%
 AND ZAD_NUM    = %exp:cNum%
 AND ZAD_FORNEC = %exp:cCodFor%
 AND ZAD_LOJA   = %exp:cLojFor%
 AND ZAD_ITEM   = %exp:cItemSV%
 
ENDSQL

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
//蛄rava o vetor com os itens da ZAD |
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
TRBZAD->( dbEval({ || AADD(aVetor, {lMark,;
ZAD_ITEMC,;
ZAD_CIA,;
STOD(ZAD_DATA),;
Transform((ZAD_HRSAI),PesqPict("ZAD","ZAD_HRSAI")),;
Transform((ZAD_HRCHE),PesqPict("ZAD","ZAD_HRCHE")),;
Transform((ZAD_VLR),PesqPict("ZAD","ZAD_VLR")),;
ZAD_STATUS,;
RECNOZAD }) },, { || !EOF()} ))

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
//蚶echa o temporario                |
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
TRBZAD->(dbCloseArea())

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
//� Calculo automatico de dimensoes de objetos �
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
aSize := MsAdvSize()
aObjects := {}
AAdd( aObjects, { 100, 100, .T., .T. } )
aInfo := { aSize[ 1 ], aSize[ 2 ], aSize[ 3 ], aSize[ 4 ], 3, 3 }
aPosObj := MsObjSize( aInfo, aObjects )
aPosGet := MsObjGetPos(aSize[3],315,{{003,033,160,200,240,263}} )

DEFINE MSDIALOG oDlgC TITLE cTitulo FROM aSize[7],0 to aSize[3]-aSize[4],aSize[5]-aSize[4] PIXEL STYLE DS_MODALFRAME STATUS

If cTpAprov == 'ADM'
 @ 06,08 LISTBOX oLbx VAR cVar FIELDS HEADER ;
 "","Item Cotacao", "Cia", "Data", "Hr.Saida", "Hr.Ch.", "Vlr.Trecho", "Status" SIZE aSize[5]/2.7,aSize[4]/2.1 OF oDlgC;
 PIXEL
Elseif cTpAprov == 'APR'
 @ 06,08 LISTBOX oLbx VAR cVar FIELDS HEADER ;
 "","Item Cotacao", "Cia", "Data", "Hr.Saida", "Hr.Ch.", "Vlr.Trecho", "Status" SIZE aSize[5]/2.7,aSize[4]/2.1 OF oDlgC;
 PIXEL ON dblClick(CtrMark(oLbx:nAt),oLbx:Refresh())
Endif

oLbx:SetArray( aVetor )
oLbx:bLine := {|| {Iif(aVetor[oLbx:nAt,1],oOk,oNo),;
aVetor[oLbx:nAt,2],;
aVetor[oLbx:nAt,3],;
aVetor[oLbx:nAt,4],;
aVetor[oLbx:nAt,5],;
aVetor[oLbx:nAt,6],;
aVetor[oLbx:nAt,7],;
If(cTpAprov == 'APR',If(aVetor[oLbx:nAt,8]=='1',aVetor[oLbx:nAt,8]:='Aprovado',aVetor[oLbx:nAt,8]:='Reprovado'),"")}}
 
 If cTpAprov == 'ADM'
  ACTIVATE MSDIALOG oDlgC ON INIT EnchoiceBar(oDlgC,{|| nOpcA := 1,oDlgC:End(),nOpcA := 0},{||oDlgC:End()}) CENTERED
 Elseif cTpAprov == 'APR'
  ACTIVATE MSDIALOG oDlgC ON INIT EnchoiceBar(oDlgC,{|| nOpcA := 1,If(GrvAprov(),oDlgC:End(),nOpcA := 0)},{||oDlgC:End()}) CENTERED
 Endif
Return

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  彪trMark   態utor  彪laudinei Ferreira  � Data �  22/11/12   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     彪ontrole do Mark na tela de selecao da Aprovacao            滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       � Especifico CNI                                             滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

Static Function CtrMark(nPos)

If ZA6->ZA6_STATUS == '4'
 For nX:= 1 to Len(aVetor)
  If nPos == nX
   aVetor[nX][1]:=!aVetor[nX][1]
  Else
   aVetor[nX][1]:= .F.
  Endif
 Next
 
Else
 MsgInfo("O status desta Solicita誽o n緌 permite Analisar Cota誽o, verifique status atual."," Aten誽o ")
Endif

Return 
/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  蛄rpGestor 態utor  彪laudinei Ferreira  � Data �  22/11/12   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     蛄rupo de Gestores para aprovacao            				  滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       � Especifico CNI                                             滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function GrpGestor

Local cUO  := ZA6->ZA6_CC
Local cCR  := ZA6->ZA6_ITEM
Local cTpVg  := ZA6->ZA6_TPVIAG
Local cGrpAp := ''
Local aAprv  := {} 

DbSelectArea('ZA5')
ZA5->(DbSetOrder(1))
If !Empty(cTpVg)
	ZA5->(DbSeek(xFilial("ZA5")+cUO+cTpVg))
Else
	ZA5->(DbSeek(xFilial("ZA5")+cUO))
Endif

cGrpAp:=ZA5->ZA5_GRPAPR

DbSelectArea('SAL')
SAL->(DbSetOrder(1))
SAL->(DbSeek(xFilial('SAL')+cGrpAp))
SAL->(dbEval({|| AADD(aAprv,{AL_USER,U_MailUser(AL_USER)})},, {|| AL_FILIAL+AL_COD == xFilial('SAL')+cGrpAp }))

Return (aAprv)

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  蛄rvAprov  態utor  彪laudinei Ferreira  � Data �  22/11/12   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     蛄rava aprovacao da Cotacao                                  滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       � Especifico CNI                                             滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

Static Function GrvAprov

Local nTotPas := 0
Local nNumVg := ZA6->ZA6_NUM 
Local nPCiaEFE  := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_CIAEFE"})
Local nPDataEFE := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_DTEFE"})
Local nPHrSEFE  := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_HREFE"})
Local nPVlEFE  := aScan(aHeader,{|x| AllTrim(x[2]) == "ZA7_VLR"})

Begin Transaction
For nX:= 1 to Len(aVetor)
 
 dbSelectArea("ZAD")
 ZAD->(DbGoTo(aVetor[nX][9]))
 
 RecLock("ZAD",.F.)
 If aVetor[nX][1]
  Replace ZAD_STATUS With '1'
 Else
  Replace ZAD_STATUS With '2'
 Endif
 lGrvZAD:=ZAD->(MsUnlock())
 
 //矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
 //蛀fetua a gravacao da cotacao Aprovada nos itens�
 //責a Solicitacao de Viagem              �
 //斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
 If lGrvZAD .AND. aVetor[nX][1]
  DbSelectArea("ZA7")
  ZA7->(DbSetOrder(1))
  If DbSeek(xFilial("ZA7")+ZAD->ZAD_NUM+ZAD->ZAD_ITEM)
   Reclock("ZA7",.F.)
   Replace ZA7_VLR  With ZAD->ZAD_VLR
   Replace ZA7_DTEFE With ZAD->ZAD_DATA
   Replace ZA7_HREFE With ZAD->ZAD_HRSAI
   Replace ZA7_CIAEFE With ZAD->ZAD_CIA
   ZA7->(MsUnlock())
   
   aCols[n][nPVlEFE] := ZAD->ZAD_VLR
   aCols[n][nPDataEFE] := ZAD->ZAD_DATA
   aCols[n][nPHrSEFE] := ZAD->ZAD_HRSAI
   aCols[n][nPCiaEFE] := ZAD->ZAD_CIA
  Endif
 Endif
Next

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
//袍otaliza total de Passagens no cabecalho da Solicitacao�
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
DbSelectArea("ZA7")
DbSetOrder(1)

BEGINSQL ALIAS "TOTPAS"
 SELECT
 SUM(ZA7_VLR) TBILH
 FROM  %table:ZA7% ZA7
 WHERE  ZA7.%notDel%
 AND ZA7_FILIAL  = %exp:xFilial("ZA7")%
 AND ZA7_NUM  = %exp:nNumVg%
ENDSQL

nTotPas:= TOTPAS->TBILH

TOTPAS->(dbCloseArea())

RecLock("ZA6",.F.)
Replace ZA6_VLRPAS With nTotPas 
Replace ZA6_GAPROV With __cUserID
Replace ZA6_GDTAPR With Dtoc(Date())+"-"+Time()
ZA6->(MsUnlock())

End Transaction

 

Return .T.

/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧utInclui 態utor  彪laudinei Ferreira  � Data �  22/11/12   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     蛄rava aprovacao da Cotacao                                  滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       � Especifico CNI                                             滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function AutInclui(cCodFor)

Local aVet  := {}
Local nXQTDVI  := GetMv("SI_XQTDVI",.F.,0)  //Quantidade de Viagens
Local nXDIASVI := GetMv("SI_XDIASVI",.F.,0) //Quantidade de Dias para Prestacao de Contas
Local lBlDias := .F.
Local lRet  :=.T.
Local aAreaZA6 := ZA6->(GetArea())

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
//�# Carrega Vetor com Solicitacoes Abertas  �
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁
DbSelectArea('ZA6')
ZA6->(DbSetOrder(2))
ZA6->(DbSeek(xFilial('ZA6')+cCodFor))
ZA6->(dbEval({|| AADD(aVet,{ZA6_NUM,DDataBase-ZA6_DTINI})},, {|| ZA6_FILIAL+ZA6_FORNEC+ZA6_LOJA == xFilial('ZA6')+cCodFor .AND. ZA6_STATUS=='5' }))

//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
//�# Verifica a quantidade de Solicitacoes em aberto X SI_XQTDVI                    �
//�# Verifica a quantidade de dias que as Solicitacoes estao Pendentes X SI_XDIASVI �
//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡�
lBlDias := Ascan(aVet,{|x| x[2] > nXDIASVI}) > 0

If Len(aVet) > nXQTDVI .OR. lBlDias                                                        
 MsgInfo("Usuario Bloqueado para novas Inclus髊s. Realize a Presta誽o de Contas das Solicita踥es anteriores."," Aten誽o ")
 lRet:=.F.
Endif

RestArea(aAreaZA6)

Return(lRet)   


/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  莧43TudoOk 態utor  蚯ucas Riva Tsuda    � Data �  04/26/13   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     �                                                            滷�
控�          �                                                            滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       � AP                                                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function A43TudoOk

If M->ZA6_TPSOL == "2" .And. Empty(M->ZA6_TPVIAG)

	Aviso("Aten誽o!","Para Tipo de Solicita誽o 'Diaria' � obrigatorio informar o campo 'Tipo de Viagem'.",{"Ok"},2,"")                                                        
	Return .F.

ElseIf M->ZA6_TPSOL == "1" .And. Empty(M->ZA6_ADIANT)

	Aviso("Aten誽o!","Para Tipo de Solicita誽o 'F.Fixo' � obrigatorio informar o campo 'Adiantamento'.",{"Ok"},2,"")                                                        
	Return .F.

EndIf      

Return .T.                


/*
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控奼迋迋迋迋迕迋迋迋迋迋冞迋迋迋敊迋迋迋迋迋迋迋迋迋豖迋迋迋敊迋迋迋迋迋迋跼�
控摺rograma  覓alAprov  態utor  蚯ucas Riva Tsuda    � Data �  04/26/13   滷�
控昅迋迋迋迋阹迋迋迋迋迋庋迋迋迋玵迋迋迋迋迋迋迋迋迋虮迋迋迋玵迋迋迋迋迋迋僚�
控慣esc.     �                                                            滷�
控�          �                                                            滷�
控昅迋迋迋迋阹迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋僚�
控摻so       � AP                                                        滷�
控￢迋迋迋迋迍迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋迋摹�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
*/

User Function ValAprov(cCC,xItem,cTpViag)                                           
      
Local lRet     := .F.
Local aArea    := GetArea()          
Local aAreaSAL := SAL->(GetArea())
Local aAreaZA5 := ZA5->(GetArea())

DbSelectArea("SAL")               
dbOrderNickName("USERAPROV")
If SAL->(MsSeek(xFilial("SAL")+__cUserId))
	
	While SAL->(!EOF()) .And. SAL->(xFilial("SAL")+AL_USER) == xFilial("SAL")+__cUserId
		
		
		ZA5->(DbSetOrder(2))
		If ZA5->(MsSeek(SAL->(xFilial("ZA5")+AL_COD)))
			
			While ZA5->(!EOF()) .AND. ZA5->(ZA5_FILIAL+ZA5_GRPAPR) == xFilial("ZA5")+SAL->AL_COD
				If M->ZA6_TPSOL == "1"
					
					If ZA5->ZA5_CC == cCC
						
						lRet := .T.
						Exit
						
					EndIf
					
				Else
					
					If ZA5->ZA5_CC == cCC .And. ZA5->ZA5_TPVIAG == cTpViag
						
						lRet := .T.
						Exit
						
					EndIf
					
				EndIf
			ZA5->(DbSkip())
			ENDDO
		EndIf
		
		SAL->(DbSkip())
		
	EndDo
	
EndIf

RestArea(aArea)
RestArea(aAreaSAL)
RestArea(aAreaZA5)

Return lRet
