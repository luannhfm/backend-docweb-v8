#Include 'Protheus.ch'
/*
Autor: Walmir Junior
Data: 29/02/2016
Finalidade: Retornar saldo de produtos para contratos baseado nas movimentações SD3.
*/
User Function SF0207X(_cTipSld, _cChvCN9, _cETMRq)
Local _nRetSld := 0
Local _aAreaSD3 := SD3->(GetArea())
//Tipos de Movimento de Requisição.
Private _cTMRq := _cETMRq

//Verifica qual tipo de saldo deve retornar
Do Case
	//Se for saldo de saída do contrato
	Case _cTipSld == "S"
		_nRetSld := fRetSaida(_cChvCN9)
	//Se for saldo de perda do contrato
	Case _cTipSld == "P"
		_nRetSld := fRetPerd(_cChvCN9)
EndCase

RestArea(_aAreaSD3)

Return _nRetSld

Static Function fRetSaida(_cChvCN9)
Local _nSld := 0

If !Empty(_cChvCN9)
	DBSelectArea("SD3")
	DBOrderNickName("CHVCN9")
	If SD3->(dbSeek(_cChvCN9))
		While SD3->(!Eof()) .And. SD3->D3_XFILCN9+SD3->D3_XNUMCN9+SD3->D3_XREVCN9 == _cChvCN9
			If SD3->D3_ESTORNO = ' ' .And. SD3->D3_TM $ _cTMRq+";999"
				_nSld += SD3->D3_QUANT
			ElseIf SD3->D3_ESTORNO = ' '
				_nSld := _nSld - SD3->D3_QUANT
			EndIf
			SD3->(DbSkip())
		EndDo
	EndIf
EndIf

Return _nSld

Static Function fRetPerd(_cChvCN9)
Local _nSld := 0

Return _nSld