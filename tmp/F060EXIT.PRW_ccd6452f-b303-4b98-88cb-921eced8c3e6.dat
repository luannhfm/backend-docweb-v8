#INCLUDE "TOTVS.CH"

/*/{Protheus.doc} F060EXIT
(long_description)
@author j2a.luizjunior
@since 05/10/2016
@version 1.0
@example
(examples)
@see (links_or_references)
/*/

User Function F060EXIT

	Local lRet      := .T.
	Local _cSitPar  := GetNewPar("MV_XPCSDR")
	Local _aE1Area	:= GetArea()
	Local lGerRel   := .F.
	Local _nX

	If !IsBlind()

		If IsInCallStack("U_SF06A13X") .And. Altera

			If Type("_cSituaca") != "U"

				If _cSituaca == "8"

					If Len(_aSelE1) > 0
						lGerRel := .T.
					EndIf

					DbSelectArea("SE1")
					DbSetOrder(1)

					For	_nX := 1 To Len(_aSelE1)

						//{TRB->E1_FILIAL, TRB->E1_PREFIXO, TRB->E1_NUM, TRB->E1_PARCELA, TRB->E1_TIPO}
						If SE1->(DbSeek(_aSelE1[_nX,1]+_aSelE1[_nX,2]+_aSelE1[_nX,3]+_aSelE1[_nX,4]+_aSelE1[_nX,5]))

							If RecLock("SE1",.F.)
								SE1->E1_XSPC   := "S"
								SE1->E1_XSPCDT := dDataBase
								MsUnLock()
							EndIf

						EndIf

					Next _nX

					RestArea(_aE1Area)

				ElseIf _cSituaca == "4"

					If Len(_aSelE1) > 0
						lGerRel := .T.
					EndIf


					For	_nX := 1 To Len(_aSelE1)

						//{TRB->E1_FILIAL, TRB->E1_PREFIXO, TRB->E1_NUM, TRB->E1_PARCELA, TRB->E1_TIPO}
						If SE1->(DbSeek(_aSelE1[_nX,1]+_aSelE1[_nX,2]+_aSelE1[_nX,3]+_aSelE1[_nX,4]+_aSelE1[_nX,5]))

							If RecLock("SE1",.F.)
								SE1->E1_XDR    := "1"
								SE1->E1_XDTTER := dDataBase
								MsUnLock()
							EndIf

						EndIf

					Next _nX

				EndIf

			EndIf

		Else

			If Inclui .And. Type("_cNumDR") != "U"

				If nOpca = 1 .And. !Empty(_cNumDR)

					If _cSituaca == "8"

						lGerRel := .T.

						DbSelectArea("SE1")
						DbSetOrder(5)
						If DbSeek(xFilial("SE1") + _cNumDR)

							While !SE1->(Eof()) .And. SE1->E1_FILIAL + SE1->E1_NUMBOR == xFilial("SE1") + _cNumDR

								If RecLock("SE1",.F.)
									SE1->E1_XSPC   := "S"
									SE1->E1_XSPCDT := dDataBase

									If SE1->E1_XNUMBOR != ''
										SE1->E1_XSITUAC := ''
									EndIf

									MsUnLock()
								EndIf

								SE1->(DbSkip())
							EndDo

						EndIf

					ElseIf _cSituaca == _cSitPar

						lGerRel := .T.

						DbSelectArea("SE1")
						DbSetOrder(5)
						If DbSeek(xFilial("SE1") + _cNumDR)

							While !SE1->(Eof()) .And. SE1->E1_FILIAL + SE1->E1_NUMBOR == xFilial("SE1") + _cNumDR

								If RecLock("SE1",.F.)
									SE1->E1_XDR    := "1"
									SE1->E1_XDTTER := dDataBase

									If SE1->E1_XNUMBOR != ''
										SE1->E1_XSITUAC := ''
									EndIf

									MsUnLock()
								EndIf

								SE1->(DbSkip())
							EndDo

						EndIf

					EndIf

				EndIf

			else
				IF ALTERA .and. Empty(SE1->E1_NUMBOR) .and. !(SE1->E1_PREFIXO $ ('SGE|RMC') )
					RecLock("SE1", .F.)
				 	SE1->E1_XIDCNAB :=   " "	
					MsUnlock()
				EndIf
			EndIf

		EndIf
		
		If lGerRel

			If MsgNoYes("Deseja gerar o relatorio de transferencia?","Atenção")
				If ExistBlock("SF06R06X")
					ExecBlock("SF06R06X",.F.,.F.)
				EndIf
			EndIf

		EndIf
	EndIf
	
Return lRet
