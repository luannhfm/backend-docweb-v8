#INCLUDE "PROTHEUS.ch"

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ SIPCOR08     ºAutor  ³Microsiga         º Data ³ 09/05/12  º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Relatório Oficial: Quadro de Previsão de Despesas          º±±
±±º          ³ Identificação CNI: RORC073/RORC074                         º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ P11 - SISTEMA INDUSTRIA                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

User Function SIPCOR08(aConfig2)
Local aArea  	:= GetArea()
Local nCont 	:= 1000
Local cBitMap3 	:= "PCOR063.BMP"
Local _nSaldo1G := 0
Local _nSaldo2G := 0
Private oPrint
Private oBrGray := TBrush():New("",CLR_GRAY)
Private _nRow	:= 8000
Private nTamForm	:= 3000 //Tamanho formulario
Private lFirst		:= .f.
Private nPag		:= 0
Private cCadastro 	:= OemToAnsi("Quadro de Previsão de Despesas")
Private oFont09		:= TFont():New("Courier",9,9,.T.,.F.,5,.T.,5,.T.,.F.)
Private oFont09b	:= TFont():New("Courier",9,9,.T.,.T.,5,.T.,5,.T.,.F.)
Private oFont12b	:= TFont():New("Courier",9,12,.T.,.T.,5,.T.,5,.T.,.F.)
Private oFont10 	:= TFont():New("Courier",9,10,.T.,.F.,5,.T.,5,.T.,.F.)
Private oFont10b 	:= TFont():New("Courier",9,10,.T.,.T.,5,.T.,5,.T.,.F.)
Private oFont12 	:= TFont():New("Courier",9,12,.T.,.F.,5,.T.,5,.T.,.F.)
// Parametros:
Private _dDataIni := aConfig2[1]
Private _dDataFim := aConfig2[2]
Private _nMoeda   := Val(aConfig2[3])
Private _cCfgCubo := aConfig2[4]
Private _cModelo  := aConfig2[5]
Private _cCubo    := Posicione("AL4",1, xFilial("AL4")+ _cCfgCubo, "AL4_CONFIG")

// Busca estrutura do cubo selecionado para chegagem
IF Len( _aStruCub := PcoStructCube( _cCubo,_cCfgCubo ):ACHAVE ) == 0
	Aviso("Cubo","Cubo inválido ou não informado.",{"Voltar"})
	Return()
ENDIF

// Validação do Cubo
// DIMENSÃO ESPERADA = OPERACAO + QUALQUER CHAVE +TIPO DE SALDO

IF _aStruCub[1] <> "AKF->AKF_CODIGO"
	Aviso("Cubo","Primeiro nível do cubo deve ser OPERAÇÃO.",{"Voltar"})
	Return()
ENDIF

IF _aStruCub[Len(_aStruCub)] <> "AL2->AL2_TPSALD"
	Aviso("Cubo","Último nível do cubo deve ser TIPO DE SALDO.",{"Voltar"})
	Return()
ENDIF

IF Len( _aDados := SIPCO08Cub() ) == 0
	Aviso("Aviso","Não existem dados a serem exibidos.",{"Sair"})
	Return()
ENDIF

oPrint:= TMSPrinter():New(cCadastro)

oPrint:Setup()
oPrint:SetPortrait()
oPrint:StartPage()

SIPCO08Cab(aConfig2)
lFirst := .t.

_nRow := 700
_nLin := 1

For i := 1 to Len(_aDados)
	
	If _nLin > 43
		oPrint:EndPage()
		oPrint:StartPage()
		SIPCO08Cab(aConfig2)
		_nLin := 1
		_nRow := 420
	EndIf
	
	// Descricao da Operacao
	oPrint:Say(_nRow,0065,Alltrim(Posicione("AKF",1,XFilial("AKF")+_aDados[i][1],"AKF_DESCRI")),oFont09)
	
	// Valores
	_aValores := _aDados[i][2]
	For y := 1 to Len(_aValores)
		// Valores por Operacao
		_nSaldo1   := _aValores[1]
		_nSaldo2   := _aValores[2]
		_nVariacao := _nSaldo2 - _nSaldo1
		
		oPrint:Say(_nRow,980,Transform(_nSaldo1,"@E 99,999,999,999.99"),oFont09)
		oPrint:Say(_nRow,1330,Transform(_nSaldo2,"@E 99,999,999,999.99"),oFont09)
		oPrint:Say(_nRow,1680,Transform(_nVariacao,"@E 99,999,999,999.99"),oFont09)
		oPrint:Say(_nRow,2030,Transform((_nVariacao/_nSaldo1)*100,"@E 99,999,999,999.99"),oFont09)
		
	Next
	
	// Acumuladores
	_nSaldo1G += _aValores[1]
	_nSaldo2G += _aValores[2]
	
	_nRow += 50
	_nLin++
	
Next

_nRow += 100

aCoord:={3000,060,3070,2380}
oPrint:FillRect(aCoord,oBrGray)
oPrint:Say(3020,075,"Total Geral",oFont09b,,CLR_WHITE)

// Imprime total geral
oPrint:Say(3020,0980,Transform(_nSaldo1G,"@E 99,999,999,999.99"),oFont09b,,CLR_WHITE)
oPrint:Say(3020,1330,Transform(_nSaldo2G,"@E 99,999,999,999.99"),oFont09b,,CLR_WHITE)
oPrint:Say(3020,1680,Transform(_nSaldo2G-_nSaldo1G,"@E 99,999,999,999.99"),oFont09b,,CLR_WHITE)
oPrint:Say(3020,2030,Transform((_nSaldo2G-_nSaldo1G)/_nSaldo1G,"@E 99,999,999,999.99"),oFont09b,,CLR_WHITE)

oPrint:Preview()
oPrint:End()

Return()

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ SIPCO08Cab ³ Autor ³ Microsiga           ³ Data ³ Abr/2012 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Imprime cabecalho e trata quebra de pagina.                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ P11 - SISTEMA INDUSTRIA                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

Static Function SIPCO08Cab(aConfig2)
Local _cBitMap := "LOGO_OFICIAL.BMP"

oPrint:Box(100,050,340,2380)//Box Externo
oPrint:Box(110,060,330,2370)//Box Interno

oPrint:SayBitmap(115,065,_cBitMap,0210,0210)	 //Tem que estar no diretorio system

oPrint:Say(130,060,PadC( "Quadro de Previsão de "+IIF(_cModelo$("1/3"),"Receita","Despesa"), 90 ),oFont12b)
IF _cModelo$("1/2")
	oPrint:Say(200,060,PadC( "SESI - Serviço Social da Indústria", 90 ),oFont12b)
ELSE
	oPrint:Say(200,060,PadC( "SENAI - Serviço Nacional de Aprendizagem Industrial", 90 ),oFont12b)
ENDIF
oPrint:Say(270,060,PadC( "Retificação Orçamentária "+Left(Dtos(_dDataIni),4), 90 ),oFont12b)

oPrint:Say(130,0300,"Orçamento",oFont10b)
oPrint:Say(130,2110,"Pág. 1 de 1",oFont10)
oPrint:Say(200,2130,Dtoc(dDataBase),oFont10)
oPrint:Say(270,2150,"Quadro 01",oFont10b)

// Box do Cabeçalho
aCoord:={450,060,675,2380}
oPrint:FillRect(aCoord,oBrGray)

// Moeda
oPrint:Say(400,2010,"valores em R$ "+Alltrim(Transform(_nMoeda,"@E 9.99")),oFont09b)

oPrint:Box(450,060,675,0980 )
oPrint:Box(450,980,525,2380 )
oPrint:Box(525,0980,675,1330 )
oPrint:Box(525,1330,675,1680 )
oPrint:Box(525,1680,600,2380 )
oPrint:Box(600,1680,675,2030 )
oPrint:Box(600,2030,675,2380 )

oPrint:Say(540,075,"Unidades Administrativas",oFont12b,,CLR_WHITE)

oPrint:Say(465,1600,"Recursos",oFont12b,,CLR_WHITE)
oPrint:Say(580,1050,"Previsão",oFont12b,,CLR_WHITE)
oPrint:Say(580,1355,"Retificação",oFont12b,,CLR_WHITE)

oPrint:Say(540,1940,"Variação",oFont12b,,CLR_WHITE)

oPrint:Say(620,1830,"R$",oFont12b,,CLR_WHITE)
oPrint:Say(620,2190,"%",oFont12b,,CLR_WHITE)

Return()

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³SIPCO08Cub  ºAutor  ³Microsiga         º Data ³  09/12/12   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Processamento do Cubo                                      º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ P11 - SISTEMA INDUSTRIA                                   º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

Static Function SIPCO08Cub()
Local _aRet     := {}
Local aFiltro   := {}
Local aCfgAux   := {}
Local aItCfgBlq := {}
Private aCfgCub := {}
Private COD_CUBO  := _cCubo

aCuboCfg := {}

aAdd(aCuboCfg, { 1  ,"Config.Cubo Serie 1",Space(LEN(AL3->AL3_CODIGO))		  ,"@!" 	 ,''  ,"AL3" ,"" ,25 ,.F. })
aAdd(aCuboCfg, { 1  ,"Config.Cubo Serie 2",Space(LEN(AL3->AL3_CODIGO))		  ,"@!" 	 ,''  ,"AL3" ,"" ,25 ,.F. })

If ParamBox(aCuboCfg, "Configuracao de Cubos", aCfgCub,/*bOk*/,/*aButtons*/,/*lCentered*/,/*nPosx*/,/*nPosy*/, /*oDlgWizard*/, /*cArqParam*/,,.T.) //"Configuracao de Cubos"
	
	// Processa saldo 1 - Previsao
	aProcessa := PcoRunCube(_cCubo, 1, "U__PCO08Sld", aCfgCub[1] ,1,.F.,.T.,aFiltro,aFiltro,.T.,aCfgAux,/*lProcessa*/,/*lVerAcesso*/,/*lForceNoSint*/,aItCfgBlq,/*aFiltCfg*/,/*cArqAKT*/,/*lLimpArqAKT*/,/*lVisao*/,.T./*lBloqueio*/)
	
	For i := 1 to Len(aProcessa)
		
		IF aProcessa[i][4] == "AKF" // Operacao
			Aadd(_aRet,{aProcessa[i][1]})
			Aadd(_aRet[Len(_aRet)],{aProcessa[i][2][1],0})
		ENDIF
		
	Next
	
	// Processa saldo 2 - Retitificação
	aProcessa := PcoRunCube(_cCubo, 1, "U__PCO08Sld", aCfgCub[2] ,1,.F.,.T.,aFiltro,aFiltro,.T.,aCfgAux,/*lProcessa*/,/*lVerAcesso*/,/*lForceNoSint*/,aItCfgBlq,/*aFiltCfg*/,/*cArqAKT*/,/*lLimpArqAKT*/,/*lVisao*/,.T./*lBloqueio*/)
	
	For i := 1 to Len(aProcessa)
		
		IF aProcessa[i][4] == "AKF" // Operacao
			IF (_nPos := Ascan(_aRet,{|x| x[1] == aProcessa[i][1]})) == 0
				Aadd(_aRet,{aProcessa[i][1]})
				Aadd(_aRet[Len(_aRet)],{0,aProcessa[i][2][1]})
			ELSE
				Aadd(_aRet[Len(_aRet)],{aProcessa[i][2][1],0})
				_aRet[_nPos][2][2] := aProcessa[i][2][1]
			ENDIF
		ENDIF
		
	Next
	
EndIf

Return(_aRet)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³_PCO08Sld  ºAutor  ³Microsiga          º Data ³  09/12/12   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Retorna saldo para o cubo                                  º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ P11 - SISTEMA INDUSTRIA                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

User Function _PCO08Sld(cConfig,cChave)
Local aRetSld := {}
Local nSldIni := 0
Local nSldFim := 0
Local _nRet   := 0

aRetIni := PcoRetSld(cConfig,cChave,_dDataIni-1)
nCrdIni := aRetIni[1, _nMoeda]
nDebIni := aRetIni[2, _nMoeda]

aRetFim := PcoRetSld(cConfig,cChave,_dDataFim)
nCrdFim := aRetFim[1, _nMoeda]
nDebFim := aRetFim[2, _nMoeda]

nSldIni := nCrdIni-nDebIni
nMovCrd := nCrdFim-nCrdIni
nMovDeb := nDebFim-nDebIni
nMovPer := nMovCrd-nMovDeb

_nRet += nMovPer

Return {_nRet}
