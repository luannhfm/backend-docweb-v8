#INCLUDE "PROTHEUS.CH"

User Function AjustaMulta()

Local aArea    	:= GetArea()
Local nValMulta := 0
Local cChaveF1 	:= ""
Local cChaveE2 	:= ""
Local nTotalNF	:= 0 
Local nTotTIT 	:= 0
Local nPorc		:= 0
                      
DbSelectArea("SD1")
SD1 ->(DbSetorder(1))
SD1 ->(DbGotop())

While !SD1->(eof())                                                                                              
	
	IF !Empty(SD1->D1_XMULTA)  // So entra na rotina quando houver multa no SD1
		
		nValMulta 	:= 0
		cChaveF1	:= SD1->(D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)
		CChaveE2	:= SD1->(D1_FILIAL+D1_FORNECE+D1_LOJA+D1_SERIE+D1_DOC)
		
		While SD1->(D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA) == cChaveF1
			
			nValMulta 	+= SD1->D1_XMULTA
			
			DbSelectArea("SD1")
			DbSkip()
			
		EndDo
		
		DbSelectArea("SF1") // Grava o total da multa dos itens no SF1
		DbSetOrder(1)
		DbSeek(cChaveF1)
		
		nTotalNF := SF1->F1_VALMERC
		
		RecLock("SF1",.F.)
		F1_XMULTA := nValMulta
		SF1->(MsUnLock())
		
		DbSelectArea("SE2")
		DbSetOrder(6)
		IF MsSeek(cChaveE2, .T. )
			
			While SE2->(E2_FILIAL+E2_FORNECE+E2_LOJA+E2_PREFIXO+E2_NUM) == cChaveE2
				
				IF SE2->E2_TIPO = "NF "
					
					nTotTIT := SE2->(E2_VALOR+E2_INSS+E2_ISS+E2_IRRF+E2_VRETCOF+E2_VRETPIS+E2_VRETCSL)
					
					nPorc := nTotTIT/nTotalNF
					
					RecLock("SE2",.F.)
					SE2->E2_DECRESC := nPorc * nValMulta
					SF1->(MsUnLock())
					
				EndIF
				
				DbSelectArea("SE2")
				DbSkip()
				
			EndDo
			
		EndIF
		
	EndIF
	
	DbSelectArea("SD1")
	DbSkip()
	
EndDo

RestArea(aArea)
Return()
