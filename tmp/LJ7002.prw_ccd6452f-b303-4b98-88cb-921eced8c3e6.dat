#INCLUDE "PROTHEUS.CH" 


/*/{Protheus.doc} LJ7002
@description Ponto de entrada acionado ao fim da venda. Sera usado para gerar impressão do
			 cupom nao fiscal, gravação da tabela de historico e validação de acesso ao parque.

@author  j2a.luizjunior
@since   29/06/2017
@version 1.0
@type 	 Function

@history 10/09/2019, Helitom Silva, Adicionado no Projeto Venda Assistida

/*/
User Function LJ7002
	
	//Local cEstat := U_SFGN001A(ProcName(0), "FTVD7002")
	Local aArea  := GetArea()
	Local oImp
	
    // Sesi Park (Venda de Day Use)
    If ( cFilAnt = '02MT0012' )
		
		//-> CLASSE PARA GERENCIAMENTO BILHETERIA
		oImp := SF0501X():New()
		
		//-> INICIA OBJETO DE IMPRESSAO
		oImp:Init()
		
		//-> GRAVA HISTORICO DE VENDA TABELA ZH0
		oImp:GRVHISTVEN()
		
		//-> ROTINA DE CADASTRO/USUARIOS DO PARK
		U_SF05A02A()
		
		//-> IMPRIME CUPOM NAO FISCAL
		oImp:PRINTDAYUSE()
		
		//-LIMPA CLASSES DE IMPRESSAO
		FreeObj(oImp)
		
		aAreaSL4 := SL4->(GetArea())
		
		// Elimina do cabeçcalho da venda o valor referente a gratuidade.
		DbSelectArea('SL4')
		SET FILTER TO AllTrim(L4_FORMA) = 'GT' .AND. L4_NUM = SL1->L1_NUM .AND. L4_FILIAL = SL1->L1_FILIAL
		SL4->(DbGoTop())
		
		nValGT := SL4->L4_VALOR 
		
		If nValGT > 0
			RecLock('SL1', .F.)
				SL1->L1_OUTROS := (SL1->L1_OUTROS - nValGT) 
			SL1->(MsUnLock())
		EndIf

		DbSelectArea('SL4')
		SET FILTER TO
		
		RestArea(aAreaSL4)
		
	EndIf
		
	RestArea(aArea)

Return
