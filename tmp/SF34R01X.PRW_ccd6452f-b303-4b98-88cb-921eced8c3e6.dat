#Include 'TOTVS.CH'
#Include 'TOPCONN.CH'
#Include 'RWMAKE.CH'
#Include 'AP5MAIL.CH'
#Include 'TOPCONN.CH'
#include 'TBICONN.CH'
#include 'PROTHEUS.CH'
#include 'RWMAKE.CH'
#include 'FONT.CH'
#include 'COLORS.CH'


User Function SF34R01X()
    Processa( { || RlAudito() }, 'Carregando...', 'Aguarde...')
Return
/*/{Protheus.doc} RlAudito
Relatório de Auditoria
@type function
@version  12.1.27
@author Gustavo Krebs 
@since 30/07/2022
@return variant, return_naoha 
/*/
Static function RlAudito()
 	Local aArea    	:= GetArea()   
	Local cTitulo  	:= ""
	Local cPrime   	:= "N"
	Local cFILIAL  	:= ""
	Local cDOC     	:= ""
	Local cSERIE   	:= ""
	Local cFORNECE 	:= ""
	Local cLOJA    	:= ""
	Local cPasta   	:= GetTempPath()
	Local cArquivo 	:= "" //"relatorio_" + dToS(Date()) + "_" + StrTran(Time(), ":", "-") + ".html"
	Private cHtml   := ""
	Private cArqv 	:= ""
 	Private cPerg  	:= "RLT_CFIC"
	ValidPerg()
	Pergunte(cPerg, .T.)
	//salva a extenção do arquivo segundo usuário 
	If mv_par01 == 1	
		cArquivo := "relatorio_" + dToS(Date()) + "_" + StrTran(Time(), ":", "-") + ".html"
	elseif mv_par01 == 2 
		cArquivo := "relatorio_" + dToS(Date()) + "_" + StrTran(Time(), ":", "-") + ".xml"
	elseif mv_par01 == 3 
	 	cArquivo := "relatorio_" + dToS(Date()) + "_" + StrTran(Time(), ":", "-") + ".html"
	endif 
	//Consulta para trazer os titulos do Relatório 
	cTitulo	:= GetNextAlias()
	BeginSql Alias cTitulo
			SELECT
				SE2.E2_FILORIG,
				SC7.C7_FILIAL,
				SD1.D1_FILIAL,
				SC7.C7_EMISSAO,
				SCR.CR_STATUS,
				SCR.CR_DATALIB,
				SCR.CR_USERLIB,
				SD1.D1_EMISSAO,
				SD1.D1_DTDIGIT,
				SD1.D1_COD,
				SD1.D1_DOC,
				SD1.D1_PEDIDO,
				SD1.D1_ITEMPC,
				SD1.D1_ITEM,
				SD1.D1_SERIE,
				SD1.D1_LOJA,
				SD1.D1_FORNECE,
				SE2.E2_NOMFOR,
				SD1.D1_TOTAL,
				SD1.D1_RATEIO,
				SD1.D1_CONTA,
				SD1.D1_CC,
				SD1.D1_ITEMCTA,
				SD1.D1_CLVL,
				SE2.E2_VALOR,
				SE2.E2_VRETIRF,
				SE2.E2_INSSRET,
				SE2.E2_BAIXA,
				SE2.E2_TITPAI,
				SE2.E2_NUM,
				SE2.E2_TIPO,
				SE2.E2_FORNECE,
				SE2.E2_LOJA,
				SE5.E5_FILIAL,
				SE5.E5_MOTBX,
				SE5.E5_BANCO,
				SE5.E5_AGENCIA,
				SE5.E5_CONTA,
				SF1.F1_DTLANC,
				SF1.F1_DTLANC,
				SF1.F1_VALBRUT,
				(SE2.E2_PIS + SE2.E2_COFINS + SE2.E2_CSLL) AS TTPCC
			FROM
				%Table:SD1% SD1
				LEFT JOIN %Table:SF1% SF1 ON SF1.F1_FILIAL = SD1.D1_FILIAL
				AND SF1.F1_DOC = SD1.D1_DOC
				AND SF1.F1_FORNECE = SD1.D1_FORNECE
				AND SF1.F1_LOJA = SD1.D1_LOJA
				LEFT JOIN %Table:SC7% SC7 ON SD1.D1_FILIAL = SC7.C7_FILIAL
				AND SD1.D1_PEDIDO = SC7.C7_NUM
				AND SD1.D1_ITEM = SC7.C7_ITEM
				INNER JOIN %Table:SE2% SE2 ON SE2.E2_FILIAL = SF1.F1_FILIAL
				AND SE2.E2_NUM = SF1.F1_DOC
				AND SE2.E2_PREFIXO = SF1.F1_SERIE
				AND SE2.E2_FORNECE = SF1.F1_FORNECE
				AND SE2.E2_LOJA = SF1.F1_LOJA
				INNER JOIN %Table:SE5% SE5 ON SE5.E5_NUMERO = SE2.E2_NUM
				AND SE5.E5_PREFIXO = SE2.E2_PREFIXO
				AND SE5.E5_CLIFOR = SE2.E2_FORNECE
				AND SE5.E5_LOJA = SE2.E2_LOJA
				AND SE5.E5_TIPO = SE2.E2_TIPO
				LEFT JOIN %Table:SCR% SCR ON SC7.C7_FILIAL = SCR.CR_FILIAL
				AND SC7.C7_NUM = SCR.CR_NUM
				AND SCR.CR_STATUS IN ('03', '05')
			WHERE
				D1_FILIAL BETWEEN %exp:mv_par02%
				AND %exp:mv_par03%
				AND D1_DOC BETWEEN %exp:mv_par08%
				AND %exp:mv_par09%
				AND D1_FORNECE BETWEEN %exp:mv_par06%
				AND %exp:mv_par07%
				AND F1_TIPO = 'N'
				AND D1_EMISSAO BETWEEN %exp:mv_par04%
				AND %exp:mv_par05%
				AND SD1.%NotDel%
				AND SE2.%NotDel%
				AND SE5.%NotDel%
				AND SC7.%NotDel%
				AND SCR.%NotDel%
			ORDER BY
				SD1.D1_FILIAL,
				SD1.D1_FORNECE,
				SD1.D1_EMISSAO

	EndSql
	//Incio a montagem do Relatório em HTML5
	cHtml := '	<!DOCTYPE html>' +CRLF
	cHtml += '	<html lang="pt-br">'+CRLF
	cHtml += ' <head> '+CRLF
	cHtml += '	<meta charset="ws-1252">'+CRLF
	cHtml += '	<meta http-equiv="X-UA-Compatible" content="IE=edge">'+CRLF
	cHtml += '	<meta name="viewport" content="width=device-width, initial-scale=1.0">'+CRLF
	cHtml += '	<title> RELATÓRIO DE AUDITORIA FINANCEIRA, CONTABILIDADE E COMPRAS </title>'+CRLF
	cHtml += '</head>'+CRLF
	cHtml += '<body>'+CRLF
	//Monto o estilo do cabeçario e grid 
	cHtml += '<style>'+CRLF            		    
	cHtml += '	.demo {                      '+CRLF
	cHtml += '		border:1px sólido #C0C0C0;'+CRLF
	cHtml += '		border-collapse:colapso;  '+CRLF
	cHtml += '		padding:5px;              '+CRLF
	cHtml += '	}                            '+CRLF
	cHtml += '	.demo th {                   '+CRLF
	cHtml += '		border:1px sólido #C0C0C0;'+CRLF
	cHtml += '		padding:5px;              '+CRLF
	cHtml += '		background:#F0F0F0;       '+CRLF
	cHtml += '	}                            '+CRLF
	cHtml += '	.demo td {                   '+CRLF
	cHtml += '		border:1px sólido #C0C0C0;'+CRLF
	cHtml += '		padding:5px;              '+CRLF
	cHtml += '	}                            '+CRLF
	cHtml += '</style>                      '+CRLF
// Cabeçario do Relatório 
	cHtml +=	'<tr>'+CRLF
	cHtml +=	'<th><h1> Relatório Auditoria Compras, Financeiro x Contabilidade </h1></th>'+CRLF
	cHtml +=    '<th>'+CRLF
	cHtml +=     '<small>'+CRLF
	cHtml +=	'<b>FILIAL DE:</b>'				+'&nbsp;' 	+ IIF(empty(mv_par02)			, '&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;' 		, Alltrim(mv_par02))			+'<br>'+CRLF
	cHtml +=    '<b>FILIAL ATÉ:</b>'			+'&nbsp;' 	+ IIF(empty(mv_par03)			, '&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;' 		, Alltrim(mv_par03))			+'<br>'+CRLF
	cHtml +=    '<b>DATA ENTRADA DE:</b>'		+'&nbsp;'  	+ IIF(empty(DTOC(mv_par04))		, '&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;' 			, DTOC(mv_par04))  	+'<br>'+CRLF
	cHtml +=    '<b>DATA ENTRADA ATÉ:</b>'		+'&nbsp;'	+ IIF(empty(DTOC(mv_par05))		, '&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'			, DTOC(mv_par05)) 		+'<br>'+CRLF
	cHtml +=    '<b>FORNECEDOR DE:</b>'			+'&nbsp;'	+ IIF(empty(Alltrim(mv_par06))	, '&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'		, Alltrim(mv_par06))			+'<br>'+CRLF
	cHtml +=    '<b>FORNECEDOR ATÉ:</b>'		+'&nbsp;'	+ IIF(empty(Alltrim(mv_par07))	, '&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'		, Alltrim(mv_par07)) 			+'<br>'+CRLF
	cHtml +=    '<b>DOCUMENTO DE:</b>'  		+'&nbsp;'	+ IIF(empty(Alltrim(mv_par08))	, '&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'		, Alltrim(mv_par08))			+'<br>'+CRLF
	cHtml +=    '<b>DOCUMENTO ATÉ:</b>' 		+'&nbsp;'	+ IIF(empty(Alltrim(mv_par09))	, '&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'		, Alltrim(mv_par09)) 			+'<br>'+CRLF
	chtml +=    '</small>'+CRLF
	cHtml +=	'</th>'+CRLF
	cHtml +=	'</tr>'+CRLF
// Incio o cabeçario dos titulos 
	cHtml += ' <table class="demo">'+CRLF
	cHtml += ' <caption> <b> NOTA FISCAL DE COMPRA </b> </caption>'+CRLF
	cHtml += ' <tr>'+CRLF
	cHtml += ' <th>FILIAL ORIGEM</th>'+CRLF 		// SC7.C7_FILIAL,
	cHtml += ' <th>FILIAL DESTINO</th>'+CRLF 		// SD1.D1_FILIAL,
	cHtml += ' <th>DT PED COMPRA</th>'+CRLF			// SC7.C7_EMISSAO,
	cHtml += ' <th>DT APRO COMPRA</th> '+CRLF      	// SCR.CR_DATALIB
	cHtml += ' <th>APROVADOR DO PEDIDO</th>'+CRLF  	// SCR.CR_USERLIB
	cHtml += ' <th>DT EMISSÃO</th>'+CRLF            // SD1.D1_EMISSAO, 
	cHtml += ' <th>DT DIGITAÇÃO</th>'+CRLF          // SD1.D1_DTDIGIT,
	cHtml += ' <th>N° NOTA FISCAL</th>'+CRLF		// SD1.D1_DOC,
	cHtml += ' <th>PEDIDO </th>'+CRLF				// SD1.D1_PEDIDO,
	cHtml += ' <th>ITEM DA NF </th>'+CRLF		    // SD1.D1_ITEM,
	cHtml += ' <th>COD. FORNECEDOR</th>'+CRLF       // SD1.D1_FORNECE,
	cHtml += ' <th>NOME FORNECEDOR</th>'+CRLF       // SE2.E2_NOMFOR,
	cHtml += ' <th>VALOR ITEM </th>'+CRLF              // SD1.D1_TOTAL, 
	cHtml += ' <th>RATEIO</th>'+CRLF 				// SD1.D1_RATEIO,	
	cHtml += ' <th>C. Contabil </th>'+CRLF			// SD1.D1_CONTA,
	cHtml += ' <th>Centro Custo </th>'+CRLF			// SD1.D1_CC,
	cHtml += ' <th>Item Contabil </th>'+CRLF		// SD1.D1_ITEMCTA,
	cHtml += ' <th>Classe Valor Deb </th>'+CRLF		// SD1.D1_CLVL,
	cHtml += ' <th>IRRF - RETIDO</th>'+CRLF			// SE2.E2_VRETIRF,
	cHtml += ' <th>PCC - RETIDO</th>'+CRLF			// SOMA DOS CAMPOS  SE2.E2_PIS + SE2.E2_COFINS + SE2.E2_CSLL
	cHtml += ' <th>INSS - RETIDO</th>'+CRLF			// SE2.E2_INSSRET,
	cHtml += ' <th>DT BAIXA</th>'+CRLF				// SE2.E2_BAIXA,
	cHtml += ' <th>FILIAL DA BAIXA</th>'+CRLF		// SE5.E5_FILIAL,
	cHtml += ' <th>MOTIVO BAIXA</th>'+CRLF			// SE5.E5_MOTBX,
	cHtml += ' <th>BANCO</th>'+CRLF					// SE5.E5_BANCO,
	cHtml += ' <th>AG-PGTO</th>'+CRLF				// SE5.E5_AGENCIA,
	cHtml += ' <th>CONTA-PGTO</th>'+CRLF			// SE5.E5_CONTA,
	cHtml += ' <th>DATA CONTABILIZAÇÃO</th>'+CRLF   // SF1.F1_DTLANC,
	cHtml += ' </tr>'+CRLF

					
	//Variavel que ira armazenar todo a estrutura do HTML 
	//Começo popular a grid de titulos
	While (cTitulo)->(!Eof()) 
	//Se o titulo for diferente da condição, trago o rateio do titulo anterior
		If cDOC != (cTitulo)->D1_DOC .AND. cPrime == "S" 
					cHtml += '<tr>'+CRLF
					cHtml += '<small>'+CRLF
					cHtml += '	<td> <b> Total NF: <b> </td>'+CRLF
					cHtml += '	<td>  ' +cVltit+ '  </td>'+CRLF
					cHtml += '</small>'+CRLF
					cHtml += '</tr>'+CRLF

			haRat(cFILIAL, cDOC, cSERIE, cFORNECE, cLOJA) 		// Traz o Rateio 
			haFinImp(2,,cFilorig,cF1emiss, cDOC, cFORNECE )		// Traz o Financeiro 
			haFinImp(1,cTITPAI, cFilorig,,cF1emiss,)					// Traz os Impostos 
			
				
//Quando acabar de popular a grid de rateio trago o cabeçario dos titulos novamente. 
					cHtml += '<table class="demo">'+CRLF
					cHtml += '<caption> <b> NOTA FISCAL DE COMPRA <b>  </caption>'+CRLF
					cHtml += '<tr>'+CRLF
					cHtml += ' <th>FILIAL ORIGEM</th>'+CRLF 		// SC7.C7_FILIAL,
					cHtml += ' <th>FILIAL DESTINO</th>'+CRLF 		// SD1.D1_FILIAL,
					cHtml += ' <th>DT PED COMPRA</th>'+CRLF			// SC7.C7_EMISSAO,
					cHtml += ' <th>DT APRO COMPRA</th> '+CRLF      	// SCR.CR_DATALIB
					cHtml += ' <th>APROVADOR DO PEDIDO</th>'+CRLF  	// SCR.CR_USERLIB
					cHtml += ' <th>DT EMISSÃO</th>'+CRLF            // SD1.D1_EMISSAO, 
					cHtml += ' <th>DT DIGITAÇÃO</th>'+CRLF          // SD1.D1_DTDIGIT,
					cHtml += ' <th>N° NOTA FISCAL</th>'+CRLF		// SD1.D1_DOC,
					cHtml += ' <th>PEDIDO </th>'+CRLF				// SD1.D1_PEDIDO,
					cHtml += ' <th>ITEM DA NF </th>'+CRLF		    // SD1.D1_ITEM,,
					cHtml += ' <th>COD. FORNECEDOR</th>'+CRLF       // SD1.D1_FORNECE,
					cHtml += ' <th>NOME FORNECEDOR</th>'+CRLF       // SE2.E2_NOMFOR,
					cHtml += ' <th>VALOR ITEM </th>'+CRLF              // SD1.D1_TOTAL, 
					cHtml += ' <th>RATEIO</th>'+CRLF 				// SD1.D1_RATEIO,	
					cHtml += ' <th>C. Contabil </th>'+CRLF			// SD1.D1_CONTA,
					cHtml += ' <th>Centro Custo </th>'+CRLF			// SD1.D1_CC,
					cHtml += ' <th>Item Contabil </th>'+CRLF		// SD1.D1_ITEMCTA,
					cHtml += ' <th>Classe Valor Deb </th>'+CRLF		// SD1.D1_CLVL,
					cHtml += ' <th>IRRF - RETIDO</th>'+CRLF			// SE2.E2_VRETIRF,
					cHtml += ' <th>PCC - RETIDO</th>'+CRLF			// SOMA DOS CAMPOS  SE2.E2_PIS + SE2.E2_COFINS + SE2.E2_CSLL
					cHtml += ' <th>INSS - RETIDO</th>'+CRLF			// SE2.E2_INSSRET,
					cHtml += ' <th>DT BAIXA</th>'+CRLF				// SE2.E2_BAIXA,
					cHtml += ' <th>FILIAL DA BAIXA</th>'+CRLF		// SE5.E5_FILIAL,
					cHtml += ' <th>MOTIVO BAIXA</th>'+CRLF			// SE5.E5_MOTBX,
					cHtml += ' <th>BANCO</th>'+CRLF					// SE5.E5_BANCO,
					cHtml += ' <th>AG-PGTO</th>'+CRLF				// SE5.E5_AGENCIA,
					cHtml += ' <th>CONTA-PGTO</th>'+CRLF			// SE5.E5_CONTA,
					cHtml += ' <th>DATA CONTABILIZAÇÃO</th>'+CRLF   // SF1.F1_DTLANC,
					cHtml += ' </tr>'+CRLF
			Endif 
	//Populo a gride de titulos
					cHtml += '<tr>'+CRLF
					cHtml += '<small>'+CRLF
					cHtml += '	<td>'+AllTrim((cTitulo)->E2_FILORIG) +'</td>'+CRLF
					cHtml += '	<td>'+AllTrim((cTitulo)->D1_FILIAL)	+'</td>'+CRLF
					cHtml += '	<td>'+DToC(SToD((cTitulo)->C7_EMISSAO)) + '</td>'+CRLF	
					cHtml += '	<td>'+DToC(SToD((cTitulo)->CR_DATALIB)) + '</td>'	+CRLF
					cHtml += '	<td>'+AllTrim(UsrRetName((cTitulo)->CR_USERLIB)) + '</td>'	+CRLF						
					cHtml += '	<td>'+DToC(SToD((cTitulo)->D1_EMISSAO)) + '</td>'	+CRLF
					cHtml += '	<td>'+DToC(SToD((cTitulo)->D1_DTDIGIT)) + '</td>'+CRLF	
					cHtml += '	<td>'+AllTrim((cTitulo)->D1_DOC) + '</td>'		+CRLF	
					cHtml += '	<td>'+AllTrim((cTitulo)->D1_PEDIDO) + '</td>'		+CRLF	
					cHtml += '	<td>'+AllTrim((cTitulo)->D1_ITEM) + '</td>'		+CRLF	
					cHtml += '	<td>'+AllTrim((cTitulo)->D1_FORNECE) + '</td>'	+CRLF		
					cHtml += '	<td>'+AllTrim((cTitulo)->E2_NOMFOR) + '</td>'	+CRLF
					cHtml += '	<td>'+"R$:"+ Alltrim(Transform((cTitulo)->D1_TOTAL, "@E 999,999,999.99" )) + '</td>'	+CRLF	
					cHtml += '	<td>'+AllTrim((cTitulo)->D1_RATEIO) + '</td>'	+CRLF		
					cHtml += '	<td>'+AllTrim((cTitulo)->D1_CONTA) + '</td>'+CRLF						
					cHtml += '	<td>'+AllTrim((cTitulo)->D1_CC) + '</td>'+CRLF				
					cHtml += '	<td>'+AllTrim((cTitulo)->D1_ITEMCTA) + '</td>'+CRLF				
					cHtml += '	<td>'+AllTrim((cTitulo)->D1_CLVL) + '</td>'+CRLF				
					cHtml += '	<td>'+"R$:"+ Alltrim(Transform((cTitulo)->E2_VRETIRF, "@E 999,999,999.99" )) + '</td>'		+CRLF	
					cHtml += '	<td>'+"R$:"+ Alltrim(Transform((cTitulo)->TTPCC, "@E 999,999,999.99" ))+ '</td>'	+CRLF	
					cHtml += '	<td>'+"R$:"+ Alltrim(Transform((cTitulo)->E2_INSSRET, "@E 999,999,999.99" ))+ '</td>'	+CRLF	
					cHtml += '	<td>'+DToC(SToD((cTitulo)->E2_BAIXA)) + '</td>'+CRLF
					cHtml += '	<td>'+AllTrim((cTitulo)->E5_FILIAL) + '</td>'	+CRLF		
					cHtml += '	<td>'+AllTrim((cTitulo)->E5_MOTBX) + '</td>'	+CRLF	
					cHtml += '	<td>'+AllTrim((cTitulo)->E5_BANCO) + '</td>'	+CRLF			
					cHtml += '	<td>'+AllTrim((cTitulo)->E5_AGENCIA) +'</td>'	+CRLF			
					cHtml += '	<td>'+AllTrim((cTitulo)->E5_CONTA) +'</td>'		+CRLF		
					cHtml += '	<td>'+DToC(SToD((cTitulo)->F1_DTLANC)) +	'</td>'+CRLF
					cHtml += '</small>'+CRLF
					cHtml += '</tr>'+CRLF
//Variaveis armazena todas as chaves tanto para a consulta do rateio quanto para consulta dos Impostos  
					cTITPAI     := "%'%"+(cTitulo)->E2_NUM +"   "+ (cTitulo)->E2_TIPO + (cTitulo)->E2_FORNECE + (cTitulo)->E2_LOJA + "%'%"
					cSERIE		:= (cTitulo)->D1_SERIE
					cLOJA		:= (cTitulo)->D1_LOJA	
					cFilorig    := AllTrim((cTitulo)->E2_FILORIG)
					cF1emiss    := (cTitulo)->D1_EMISSAO         
					cDOC		:= (cTitulo)->D1_DOC	 
					cFORNECE	:= (cTitulo)->D1_FORNECE                         
					cNmForn 	:= AllTrim((cTitulo)->E2_NOMFOR)
					cVltit  	:= "R$:"+ Alltrim(Transform((cTitulo)->F1_VALBRUT, "@E 999,999,999.99" ))
					cBaixa      := DToC(SToD((cTitulo)->E2_BAIXA))
					cFILIAL 	:= (cTitulo)->D1_FILIAL
					cMtbaixa 	:= AllTrim((cTitulo)->E5_MOTBX) 
					cBanco 		:= AllTrim((cTitulo)->E5_BANCO) 			
					cArg 		:= AllTrim((cTitulo)->E5_AGENCIA) 			
					cCont 		:= AllTrim((cTitulo)->E5_CONTA) 
					cPrime		:= "S"

					(cTitulo)->(dbSkip())
					If  (cTitulo)->(EOF())
						cHtml += '<tr>'+CRLF
						cHtml += '<small>'+CRLF
						cHtml += '	<td> <b> Total NF: <b> </td>'+CRLF
						cHtml += '	<td>  ' +cVltit+ '  </td>'+CRLF
						cHtml += '</small>'+CRLF
						cHtml += '</tr>'+CRLF
						haRat(cFILIAL, cDOC, cSERIE, cFORNECE, cLOJA) 		// Traz o Rateio 
						haFinImp(2,,cFilorig,cF1emiss, cDOC, cFORNECE )		// Traz o Financeiro 
						haFinImp(1,cTITPAI, cFilorig,,,)					// Traz os Impostos 
					endif 
	EndDo
	//Gravo o fim do arquivo 
	cHtml += '</body> ' +CRLF
	cHtml += '</html> ' +CRLF
    MemoWrite(cPasta + cArquivo, cHtml)
    ShellExecute("OPEN", cArquivo, "", cPasta, 1)
	RestArea(aArea)
Return

/*/{Protheus.doc} haRat
Traz o Rateio referente a E2 
@type function
@version  12.1.33
@author Gustavo Krebs 
@since 15/07/2022
@return variant, return aArrRat array com o rateio 
/*/
static Function haRat(cFILIAL, cDOC, cSERIE, cFORNECE, cLOJA)
Local cAliRat 		:= GetNextAlias()
Local ltem			:= .F. 
Default cFILIAL		:= ""
Default cDOC		:= ""
Default cSERIE		:= ""
Default cFORNECE	:= ""
Default cLOJA		:= ""
// Inicio a consulta do Rateio 
	BeginSql Alias cAliRat
		Select
			SDE.DE_FILIAL,
			SDE.DE_DOC,
			SDE.DE_SERIE,
			SDE.DE_FORNECE,
			SDE.DE_LOJA,
			SDE.DE_ITEMNF,
			SDE.DE_ITEM,
			SDE.DE_PERC,
			SDE.DE_CC,
			SDE.DE_CONTA,
			SDE.DE_ITEMCTA,
			SDE.DE_CLVL,
			SDE.DE_CUSTO1,
			SDE.DE_CUSTO2,
			SDE.DE_CUSTO3,
			SDE.DE_CUSTO4,
			SDE.DE_CUSTO5,
			SDE.DE_SDOC
		FROM
              %Table:SDE% SDE
              INNER JOIN %Table:SF1% SF1 ON SF1.F1_FILIAL = SDE.DE_FILIAL
              AND SF1.F1_DOC = SDE.DE_DOC
              AND SF1.F1_SERIE = SDE.DE_SERIE
              AND SF1.F1_FORNECE = SDE.DE_FORNECE
              AND SF1.F1_LOJA = DE_LOJA
		WHERE
			DE_FILIAL = %exp:cFILIAL%
			AND DE_DOC = %exp:cDOC%
			AND DE_SERIE = %exp:cSERIE%
			AND DE_FORNECE = %exp:cFORNECE%
			AND DE_LOJA = %exp:cLOJA%
			AND SDE.%NotDel%
		ORDER BY
			DE_ITEM
	EndSql
	cHtml += '<table class="demo">'+CRLF
	cHtml += '<caption> <b> RATEIO </b> </caption>'+CRLF
	cHtml += '<tr>'+CRLF      
	cHtml += '<th>FILIAL</th>'+CRLF                
	cHtml += '<th>DOC</th>'+CRLF
	cHtml += '<th>SERIE</th>'+CRLF
	cHtml += '<th>FORNECEDOR</th> '+CRLF
	cHtml += '<th>LOJA</th>'+CRLF
	cHtml += '<th>ITEM NF</th>'+CRLF
	cHtml += '<th> ITEM RAT </th>'+CRLF
	cHtml += '<th> % PERC</th>'+CRLF
	cHtml += '<th>CONTA CONTABIL</th>'+CRLF
	cHtml += '<th>ITEM CTA </th>'+CRLF
	cHtml += '<th>CLASE VALOR </th>'+CRLF
	cHtml += '<th>Custo Moeda 1 </th>'+CRLF
	cHtml += '<th>Custo Moeda 2 </th>'+CRLF
	cHtml += '<th>Custo Moeda 3 </th>'+CRLF
	cHtml += '<th>Custo Moeda 4 </th>'+CRLF
	cHtml += '<th>Custo Moeda 5 </th>'+CRLF
	cHtml += '<th>Serie Doc. </th>'+CRLF
	cHtml += '</tr>'+CRLF
		//Começo a popular a grid de Rateito 
		While (cAliRat)->(!Eof())
						cHtml += '<tr>'+CRLF
						cHtml += '<small>'
						cHtml += '<td>' +Alltrim((cAliRat)->DE_FILIAL) + '</td>'+CRLF
						cHtml += '<td>' +Alltrim((cAliRat)->DE_DOC) + '</td>'+CRLF
						cHtml += '<td>' +Alltrim((cAliRat)->DE_SERIE) + '</td>'+CRLF
						cHtml += '<td>' +Alltrim((cAliRat)->DE_FORNECE	) + '</td>'+CRLF
						cHtml += '<td>' +Alltrim((cAliRat)->DE_LOJA	) + '</td>'+CRLF
						cHtml += '<td>' +Alltrim((cAliRat)->DE_ITEMNF) + '</td>'+CRLF
						cHtml += '<td>' +Alltrim((cAliRat)->DE_ITEM	) + '</td>'+CRLF
						cHtml += '<td>' +Alltrim(Transform((cAliRat)->DE_PERC, "@E 999,999,999.99" )) + '</td>'+CRLF
						cHtml += '<td>' +Alltrim((cAliRat)->DE_CC) + '</td>'+CRLF
						cHtml += '<td>' +Alltrim((cAliRat)->DE_ITEMCTA) + '</td>'+CRLF
						cHtml += '<td>' +Alltrim((cAliRat)->DE_CLVL	) + '</td>'+CRLF
						cHtml += '<td>' +"R$:"+ Alltrim(Transform((cAliRat)->DE_CUSTO1, "@E 999,999,999.99" )) + '</td>'+CRLF
						cHtml += '<td>' +"R$:"+ Alltrim(Transform((cAliRat)->DE_CUSTO2, "@E 999,999,999.99" )) + '</td>'+CRLF
						cHtml += '<td>' +"R$:"+ Alltrim(Transform((cAliRat)->DE_CUSTO3, "@E 999,999,999.99" )) + '</td>'+CRLF
						cHtml += '<td>' +"R$:"+ Alltrim(Transform((cAliRat)->DE_CUSTO4, "@E 999,999,999.99" )) + '</td>'+CRLF
						cHtml += '<td>' +"R$:"+ Alltrim(Transform((cAliRat)->DE_CUSTO5, "@E 999,999,999.99" )) + '</td>'+CRLF
						cHtml += '<td>' +Alltrim((cAliRat)->DE_SDOC	) + '</td>'
						cHtml += '</small>'
						cHtml += '</tr>'+CRLF
				(cAliRat)->(DbSkip())
				ltem :=  .T. 
		EndDo		
	If ltem == .F.  
		cHtml += '<tr>'+CRLF
		cHtml += '<small>'+CRLF
		cHtml += '<td>' +"********"+ '</td>'+CRLF
		cHtml += '<td>' +"******"+ '</td>'+CRLF
		cHtml += '<td>' +"******"+ '</td>'+CRLF
		cHtml += '<td>' +"********"+ '</td>'+CRLF
		cHtml += '<td>' +"****"+ '</td>'+CRLF
		cHtml += '<td>' +"****"+ '</td>'+CRLF
		cHtml += '<td>' +"**"+ '</td>'+CRLF
		cHtml += '<td>' +"*****"+ '</td>'+CRLF
		cHtml += '<td>' +"*******"+ '</td>'+CRLF
		cHtml += '<td>' +"**********"+ '</td>'+CRLF
		cHtml += '<td>' +"*****"+ '</td>'+CRLF
		cHtml += '<td>' +"******"+ '</td>'+CRLF
		cHtml += '<td>' +"******"+ '</td>'+CRLF
		cHtml += '<td>' +"******"+ '</td>'+CRLF
		cHtml += '<td>' +"******"+ '</td>'+CRLF
		cHtml += '<td>' +"******"+ '</td>'+CRLF
		cHtml += '<td>' +"******"+ '</td>'
		cHtml += '</small>'+CRLF
		cHtml += '</tr>'+CRLF
	Endif                 
	(cAliRat)->(DbCloseArea())
Return

/*/{Protheus.doc} haImpost
Consulta para verificar se o titulo possui impostos 
@type function
@version 12.1.27 
@author J2A -> Gustavo Krebs 
@since 15/08/2022
@param cTitPai, character, param_Para fazer um Like no E2_titpai 
@param cfilial, character, param_Traz a filial para a consulta
@return variant, return_aArray array com os impostos 
/*/
Static Function haFinImp(nIT,cTitPai, cfilial, dEmissao, cDoc, cFor )
	Local cAlias 		:= GetNextAlias()
	Local cSe5			:= ""
	Local lTem			:= .f. 
	Default cTitPai		:= ""
	Default cfilial		:= ""
	Default dEmissao    := Date()
	Default cDoc		:= ""
	Default cFor		:= ""
	//Inicio a consulta dos impostos/FIN
	if nIT == 1 
			BeginSql Alias cAlias
				SELECT
					SE2.E2_FILIAL,
					SE2.E2_EMISSAO,
					SE2.E2_NUM,
					SE2.E2_FATURA,
					SE2.E2_FORNECE,
					SE2.E2_NOMFOR,
					SE2.E2_VALOR,
					SE2.E2_BAIXA,
					SE2.E2_FILORIG, 
					SE2.E2_BAIXA,
					SE2.E2_FATURA
				FROM
					%Table:SE2% SE2
				WHERE
					E2_TITPAI LIKE %exp:cTitPai%
					AND E2_FILIAL = %exp:cFILIAL% 
					AND SE2.%NotDel%
			EndSql

	Else 
					cHtml += '<table class="demo">'+CRLF
					cHtml += '<caption> <b> FINANCEIRO / IMPOSTO </b> </caption>'+CRLF
					cHtml += '<tr>'+CRLF      
					cHtml += '<th>FILIAL ORIGEM</th>'+CRLF                
					cHtml += '<th>DATA EMISSAO</th>'+CRLF
					cHtml += '<th>N° NF</th>'+CRLF
					cHtml += '<th>N° FATURA </th>'+CRLF
					cHtml += '<th>COD FORNECEDOR</th> '+CRLF
					cHtml += '<th>NOME FORNECEDOR</th>'+CRLF
					cHtml += '<th>VLR NF (VLR.TITULO)</th>'+CRLF
					cHtml += '<th> DATA BAIXA</th>'+CRLF
					cHtml += '<th> FILIAL RESP PAG</th>'+CRLF
					cHtml += '<th>MOTIVO BAIXA</th>'+CRLF
					cHtml += '<th>	BANCO </th>'+CRLF
					cHtml += '<th> AG-PGTO </th>'+CRLF
					cHtml += '<th> CONTA-PGTO </th>'+CRLF
					cHtml += '</tr>'+CRLF   
			BeginSql Alias cAlias
			SELECT
				SE2.E2_FILIAL,
				SE2.E2_EMISSAO,
				SE2.E2_NUM,
				SE2.E2_FATURA,
				SE2.E2_FORNECE,
				SE2.E2_NOMFOR,
				SE2.E2_VALOR,
				SE2.E2_BAIXA,
				SE2.E2_FILORIG,
				SE5.E5_MOTBX,
				SE5.E5_BANCO,
				SE5.E5_AGENCIA,
				SE5.E5_CONTA
			FROM
				%Table:SE2% SE2
				INNER JOIN %Table:SE5% SE5 ON SE5.E5_NUMERO = SE2.E2_NUM
				AND SE5.E5_PREFIXO = SE2.E2_PREFIXO
				AND SE5.E5_CLIFOR = SE2.E2_FORNECE
				AND SE5.E5_LOJA = SE2.E2_LOJA
				AND SE5.E5_TIPO = SE2.E2_TIPO
			WHERE
				E2_FILIAL = %exp:cfilial%
				AND E2_EMISSAO = %exp:dEmissao%
				AND E2_NUM = %exp:cDoc%
				AND E2_FORNECE = %exp:cFor%
				AND SE2.%NotDel%
			EndSql
	endif 

			//Carrego o finaceiro no HTML 
				While (cAlias)->(!Eof())
						cSe5	:= GetNextAlias()
						BeginSql Alias cSe5
							SELECT
								SE5.E5_DATA,
								SE5.E5_MOTBX,
								SE5.E5_BANCO,
								SE5.E5_AGENCIA,
								SE5.E5_CONTA
							FROM
								%Table:SE5% SE5
							WHERE
								E5_NUMERO = %exp:(cAlias)->E2_FATURA%
								AND E5_CLIFOR = %exp:(cAlias)->E2_FORNECE%
						EndSql

					cHtml += '<tr>'+CRLF
					cHtml += '<small>'+CRLF
					cHtml += '<td>' + Alltrim((cAlias)->E2_FILIAL) + '</td>'+CRLF
					cHtml += '<td>' + Alltrim((cAlias)->E2_EMISSAO) + '</td>'+CRLF
					cHtml += '<td>' + Alltrim((cAlias)->E2_NUM) + '</td>'+CRLF
					chtml += '<td>' + Alltrim((cAlias)->E2_FATURA) + '</td>'+CRLF
					cHtml += '<td>' + Alltrim((cAlias)->E2_FORNECE) + '</td>'+CRLF
					cHtml += '<td>' + Alltrim((cAlias)->E2_NOMFOR)  + '</td>'+CRLF
					cHtml += '<td>' + "R$:"+ Alltrim(Transform((cAlias)->E2_VALOR, "@E 999,999,999.99" ))   +  '</td>'+CRLF
					if nIT == 1 
						cHtml += '<td>' + DToC(SToD((cSe5)->E5_DATA))  + '</td>'+CRLF
						cHtml += '<td>' + Alltrim((cAlias)->E2_FILORIG)  + '</td>'+CRLF
						cHtml += '<td>' + Alltrim((cSe5)->E5_MOTBX)  + '</td>'+CRLF
						cHtml += '<td>'	+ Alltrim((cSe5)->E5_BANCO)  + '</td>'	+CRLF			
						cHtml += '<td>'	+ Alltrim((cSe5)->E5_AGENCIA) 	 +'</td>'	+CRLF			
						cHtml += '<td>'	+ Alltrim((cSe5)->E5_CONTA) +'</td>'		+CRLF
						(cSe5)->(DbCloseArea())
					else 
						cHtml += '<td>' + DToC(SToD((cAlias)->E2_BAIXA))  + '</td>'+CRLF
						cHtml += '<td>' + Alltrim((cAlias)->E2_FILORIG)  + '</td>'+CRLF
						cHtml += '<td>' + Alltrim((cAlias)->E5_MOTBX)  + '</td>'+CRLF
						cHtml += '<td>'	+ Alltrim((cAlias)->E5_BANCO)  + '</td>'	+CRLF			
						cHtml += '<td>'	+ Alltrim((cAlias)->E5_AGENCIA) 	 +'</td>'	+CRLF			
						cHtml += '<td>'	+ Alltrim((cAlias)->E5_CONTA) +'</td>'		+CRLF
					endif  
					cHtml += '</small>'+CRLF
					cHtml += '</tr>'+CRLF	
					(cAlias)->(DbSkip())
					lTem := .T.
				EndDo
		if lTem == .F.  
					cHtml += '<tr>'+CRLF
					cHtml += '<small>'+CRLF
					cHtml += '<td>' + "********"	+ 	'</td>'+CRLF
					cHtml += '<td>' + "********" 	+ 	'</td>'+CRLF
					cHtml += '<td>' + "********"	+ 	'</td>'+CRLF
					cHtml += '<td>' + "********"	+ 	'</td>'+CRLF
					cHtml += '<td>' + "********"  	+ 	'</td>'+CRLF
					cHtml += '<td>' + "********" 	+  	'</td>'+CRLF
					cHtml += '<td>' + "********" 	+ 	'</td>'+CRLF
					cHtml += '<td>' + "********"	+ 	'</td>'+CRLF
					cHtml += '<td>' + "********" 	+ 	'</td>'+CRLF
					cHtml += '<td>'	+ "********" 	+ 	'</td>'	+CRLF			
					cHtml += '<td>'	+ "********" 	+	'</td>'	+CRLF			
					cHtml += '<td>'	+ "********" 	+	'</td>'	+CRLF
					cHtml += '<td>'	+ "********" 	+	'</td>'	+CRLF
					cHtml += '</small>'+CRLF
					cHtml += '</tr>'+CRLF		
		endif 
	(cAlias)->(DbCloseArea())
	
	if nIT == 1 
		cHtml += '<tr>'+CRLF
		cHtml += '<small>'+CRLF
		cHtml += '<td>' + "  "	+ 	'</td>'+CRLF
		cHtml += '</small>'+CRLF
		cHtml += '</tr>'+CRLF	

		cHtml += '<tr>'+CRLF
		cHtml += '<small>'+CRLF
		cHtml += '<td>' + "  "	+ 	'</td>'+CRLF
		cHtml += '</small>'+CRLF
		cHtml += '</tr>'+CRLF

		cHtml += '<tr>'+CRLF
		cHtml += '<small>'+CRLF
		cHtml += '<td>' + "  "	+ 	'</td>'+CRLF
		cHtml += '</small>'+CRLF
		cHtml += '</tr>'+CRLF			
	endif 
Return 

/*/{Protheus.doc} ValidPerg
valida as perguntas 
@type function
@version 12.1.33
@author Gustavo Krebs 
@since 22/06/2022
@return variant, return cPerg
/*/
Static Function ValidPerg()
	LOCAL aArea    	:= GetArea()
	LOCAL aAreaDic 	:= SX1->( GetArea() )
	LOCAL aEstrut  	:= {}
	LOCAL aStruDic 	:= SX1->( dbStruct() )
	LOCAL aDados	:= {}
	LOCAL nXa       := 0
	LOCAL nXb       := 0
	LOCAL nTam1    	:= Len( SX1->X1_GRUPO )
	LOCAL nTam2    	:= Len( SX1->X1_ORDEM )
	aEstrut := { 'X1_GRUPO'  , 'X1_ORDEM'  , 'X1_PERGUNT', 'X1_PERSPA' , 'X1_PERENG' , 'X1_VARIAVL', 'X1_TIPO', ;
		'X1_TAMANHO', 'X1_DECIMAL', 'X1_PRESEL' , 'X1_GSC'    , 'X1_VALID'  , 'X1_VAR01'  , 'X1_DEF01'  , ;
		'X1_DEFSPA1', 'X1_DEFENG1', 'X1_CNT01'  , 'X1_VAR02'  , 'X1_DEF02'  , 'X1_DEFSPA2', 'X1_DEFENG2', ;
		'X1_CNT02'  , 'X1_VAR03'  , 'X1_DEF03'  , 'X1_DEFSPA3', 'X1_DEFENG3', 'X1_CNT03'  , 'X1_VAR04'  , ;
		'X1_DEF04'  , 'X1_DEFSPA4', 'X1_DEFENG4', 'X1_CNT04'  , 'X1_VAR05'  , 'X1_DEF05'  , 'X1_DEFSPA5', ;
		'X1_DEFENG5', 'X1_CNT05'  , 'X1_F3'     , 'X1_PYME'   , 'X1_GRPSXG' , 'X1_HELP'   , 'X1_PICTURE', ;
		'X1_IDFIL'   }
	aAdd(aDados,{cPerg,"01","Abrir com ?"	 		,"","","mv_ch1","N",01,00,00,"C","","mv_par01","PDF","PDF","PDF","","","EXCEL","EXCEL","EXCEL","","","NAVEGADOR","NAVEGADOR","NAVEGADOR","","","","","","","","","","","","","","",""} )
	aadd(aDados,{cPerg,"02","Filial de ?"          ,"","","mv_ch2","C",08,00,00,"G","","mv_par02","","","","","","","","","","","","","","","","","","","","","","","","","","","",""})
	aadd(aDados,{cPerg,"03","Filial ate ?"          ,"","","mv_ch3","C",08,00,00,"G","","mv_par03","","","","","","","","","","","","","","","","","","","","","","","","","","","",""})
	aadd(aDados,{cPerg,"04","Data entrada de ?"     ,"","","mv_ch4","D",08,00,00,"G","","mv_par04","","","","","","","","","","","","","","","","","","","","","","","","","","","",""})
	aadd(aDados,{cPerg,"05","Data entrada ate ?"    ,"","","mv_ch5","D",08,00,00,"G","","mv_par05","","","","","","","","","","","","","","","","","","","","","","","","","","","",""})
	aadd(aDados,{cPerg,"06","Fornecedor de ?"       ,"","","mv_ch6","C",09,00,00,"G","","mv_par06","","","","","","","","","","","","","","","","","","","","","","","","","","","",""})
	aadd(aDados,{cPerg,"07","Fornecedor ate ?"      ,"","","mv_ch7","C",09,00,00,"G","","mv_par07","","","","","","","","","","","","","","","","","","","","","","","","","","","",""})
	aadd(aDados,{cPerg,"08","Documento de ?"        ,"","","mv_ch8","C",09,00,00,"G","","mv_par08","","","","","","","","","","","","","","","","","","","","","","","","","","","",""})
	aadd(aDados,{cPerg,"09","Documento ate ?"       ,"","","mv_ch9","C",09,00,00,"G","","mv_par09","","","","","","","","","","","","","","","","","","","","","","","","","","","",""})
	dbSelectArea( 'SX1' )
	SX1->( dbSetOrder( 1 ) )
	For nXa := 1 To Len( aDados )
		If !SX1->( dbSeek( PadR( aDados[nXa][1], nTam1 ) + PadR( aDados[nXa][2], nTam2 ) ) )
			RecLock( 'SX1', .T. )
			For nXb := 1 To Len( aDados[nXa] )
				If aScan( aStruDic, { |aX| PadR( aX[1], 10 ) == PadR( aEstrut[nXb], 10 ) } ) > 0
					SX1->( FieldPut( FieldPos( aEstrut[nXb] ), aDados[nXa][nXb] ) )
				EndIf
			Next nXb
			MsUnLock()
		EndIf
	Next nXa
	RestArea( aAreaDic )
	RestArea( aArea )
Return
