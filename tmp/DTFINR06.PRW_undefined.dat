#Include "RWMAKE.CH"
#Include "Protheus.ch"
#Include "TopConn.ch"

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ DTFINR06 º Autor ³ DO.IT MG           º Data ³  17/07/14   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDescricao ³ Fonte de baixa sem movimentação bancária e geração de      º±±
±±º          ³ título do pagamento em cartão de crédito                   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ AP6 IDE                                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

User Function DTFINR06(cNumCart,cNum,cCliente,cLoja,cParcela, cContaCre, cCCusto, cItemCred) 

Local aArray    := {}
Local cNatureza := ""
Local cPrefixo	 := "" 
Local cPreAnt   := ""
Local cNumAnt   := ""
Local cParAnt   := "" 
Local cTotPar	 := ""
Local cTipoAnt	 := ""
Local cTipo		 := "" 
Local dVencto	 := ctod('//') 
Local aArea     := {}   
Local lErro		 := .F.
Local cCli		 := ""
Local cHist     := ""
Local cNome		 := ""  
Local cHistTit  := ""
Local cHistBx	 := ""
Local cNumParce := "001"
Local aCondicao := {}   
Local lExecOk   := .F.
Local nX  
Local cMaior	 := ""
Local cCliAnt	 := ""

PRIVATE lMsErroAuto := .F.

aArea := GetArea()

cTipoAnt	 := SE1->E1_TIPO
dVencto   := SE1->E1_VENCTO
dVencrea  := SE1->E1_VENCREA
nValor	 := nValRec 
cParAnt	 := SE1->E1_PARCELA
cNumAnt	 := SE1->E1_NUM
cPreAnt	 := SE1->E1_PREFIXO
cCliAnt	 := SE1->E1_CLIENTE

cPrefixo  := "CRT"                   	
cNatureza := GetMV("MV_NATUREZ", .F.,)
cTipo 	 := "CC"                       
cCliente  := PadR(cCliente,TamSX3("A1_COD")[1],' ')
cHist   	 := cPrefixo+" "+cNum+" "+cTipo+" "+cCliente+" "+cLoja+" "+cNumCart

/* Jose Leite - 24/11/14
	Solicitado por: Rubia - UNETEC
	Gravar no historico de baixa o nome do cliente que originou o titulo do Cartao de Credito
*/
//INICIO
cNome 	 := AllTrim(Posicione("SA1",1,xFilial("SA1")+SE1->E1_CLIENTE+SE1->E1_LOJA,"A1_NOME"))
//FIM

cHistTit  := cCliAnt+" "+cLoja+" "+cNome
   
cHistBx 	 := cPreAnt+" "+cNumAnt+" "+cParAnt+" "+cTipoAnt+" "+AllTrim(cNome)+" "+cNumCart	     
aCondicao := Condicao(nValor,cParcela,,dDataBase) 

Begin Transaction 

For nX := 1 To Len(aCondicao)
  
	dVencto  := aCondicao[nX][1]
	nValor	:= aCondicao[nX][2]
	cNumParce := Parcela(cNum,cPrefixo)
	cNumParce :=Soma1(cNumParce)
 	cTotPar := cTotPar+cNumParce +";"

// Inclusão do título da operadora no contas a receber		
	aArray := { 	{ "E1_FILIAL"  	, xFilial("SE1")    	, NIL },;
					{ "E1_PREFIXO" 	, cPrefixo          	, NIL },;
  					{ "E1_NUM"     	, cNum              	, NIL },;
  					{ "E1_TIPO"    	, cTipo             	, NIL },;
					{ "E1_NATUREZ" 	, cNatureza         	, NIL },;
					{ "E1_CLIENTE" 	, cCliente		    	, NIL },;
					{ "E1_LOJA"		, cLoja			  		, NIL },;
					{ "E1_NOMCLI"	, cNome					, NIL },;
					{ "E1_EMISSAO" 	, dDataBase			    , NIL },; 
					{ "E1_VENCTO"		, dVencto			, NIL },;
					{ "E1_VALOR"   	, nValor            	, NIL },;
					{ "E1_PARCELA"		, cNumParce			, NIL },;
					{ "E1_HIST"		, cHistBx				, NIL },;
					{ "E1_XDGCART"		, cNumCart			, NIL },;
  					{ "E1_CREDIT " 	, cContaCre		 	    , NIL },;
					{ "E1_CCC"  	 	, cCCusto			, NIL },;
  					{ "E1_ITEMC"   	, cItemCred		 	    , NIL },; 
  					{ "E1_XCHVREN" 	, " "					, NIL }}


	MsExecAuto( { |x,y| FINA040(x,y)} , aArray, 3)  // 3 - Inclusao  
	
	lExecOk := lExecOk .And. lMsErroAuto 
	
	If lMsErroAuto
	
		MostraErro() 
		lErro := .T. 
		DisarmTransaction()
		
		Return (lErro)
		
    EndIf        
Next nX
End Transaction   
 
	If !lExecOk   
	   
	   DbSelectArea('SE1')
	   SE1->(DbSetOrder(1)) //E1_FILIAL+E1_PREFIXO+E1_NUM+E1_PARCELA+E1_TIPO
	   	IF SE1->( DbSeek(SE1->E1_FILIAL+cPreAnt+cNumAnt+cParAnt+cTipoAnt) )
			/*RecLock("SE1",.F.)
			SE1->E1_XDGCART := cNumCart
			SE1->E1_HIST 	 := cHist
			SE1->E1_HISTBX	 := cPrefixo+" "+cNum+" "+cTotPar+" "+cTipo+" "+cCliente+" "+cLoja+" "+cValToChar(cNumCart)
			SE1->(MsUnlock())*/
			Alert("Título incluído com sucesso!")
		Else
			Alert("Título não encontrado!")
			lErro := .T.
			Return (lErro)
		EndIf
		
	EndIf
	
RestArea(aArea)
Return (lErro) 

Static Function Parcela(cNum,cPrefixo)

Local cQuery := ""
Local cAlias := GetNextAlias()
Local cParMaior := ""   

cQuery := " SELECT MAX(E1_PARCELA)MAIOR_PARCELA FROM "+ RetSqlName("SE1") +" SE1 "
cQuery += "WHERE SE1.E1_FILIAL = '"+xFilial("SE1")+"' AND SE1.E1_NUM = '"+cNum+"'" 
cQuery += "AND SE1.E1_PREFIXO = '"+cPrefixo+"'"
cQuery += "AND SE1.D_E_L_E_T_ = ' '"

dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlias,.T.,.T.)        
cParMaior := (cAlias)->MAIOR_PARCELA

Return (cParMaior)