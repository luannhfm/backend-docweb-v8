#INCLUDE "PROTHEUS.CH"
#INCLUDE "REPORT.CH"
 
/*/f/
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
<Descricao> :  Fun誽o respons嫛el pela gera誽o do Relat鏎io de Rateio de Verbas
<Autor> : F墎rica DOIT SP
<Data> : 18/05/2014
<Parametros> : Nil
<Retorno> : Nil
<Processo> : FIEMT � Importa誽o de Horas
<Tipo> R (Relat鏎io)
<Obs> : 
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
*/

User Function DTGPER02()

Local oReport
Local lTRepInUse := .T.
Local cTitle     := "Rateio de Verbas"

If FindFunction("TRepInUse") .And. lTRepInUse
	//矬闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡醴
	//蛆nterface de impressao                                                  �
	//斂闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡囁

	If pergunte( "DTGPER02" )

		oReport:= TReport():New("DTGPER02", cTitle,, {|oReport| DefPrint(oReport)}, cTitle)

		oReport:SetLandScape(.T.)
		oReport:ldisableorientation:=.T.
		oReport:GetOrientation(1)

		oReport:PrintDialog()
	EndIf
EndIf

Return

/*/
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
控矬闡闡闡闡鐃闡闡闡闡闡薩闡闡闡薩闡闡闡闡闡闡闡闡闡闡闡薩闡闡鐃闡闡闡闡闡膨�
控袈rograma  袒eportPrin� Autor 莧lexandre Inacio Lemes 蛇ata  �06/09/2006陰�
控藥闡闡闡闡霰闡闡闡闡闡謐闡闡闡謐闡闡闡闡闡闡闡闡闡闡闡謐闡闡鐘闡闡闡闡闡敢�
控蛇escri��o � Emissao do Pedido de Compras / Autorizacao de Entrega      陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡敢�
控袖intaxe   � ReportPrint(ExpO1,ExpN1,ExpN2)                             陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡敢�
控袈arametros� ExpO1 = Objeto oReport                      	              陰�
控�          � ExpN1 = Numero do Recno posicionado do SC7 impressao Menu  陰�
控�          � ExpN2 = Numero da opcao para impressao via menu do PC      陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡敢�
控袒etorno   術enhum                                                      陰�
控藥闡闡闡闡霰闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡敢�
控袈arametros蛀xpO1: Objeto Report do Relat鏎io                           陰�
控斂闡闡闡闡鐘闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡闡棱�
控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控控�
葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔葔�
/*/
Static Function DefPrint(oReport)

Local lCabec   := .T.
Local lVerba   := .T.
Local cMat     := ""
Local cVerba   := ""
Local nLinha   := 240

Local nSizeCTD := 4
Local nSizeCTT := 4

Local cQuery   := ""
Local cAlias   := GetNextAlias() 

Local oBrush   := TBrush():New("",CLR_LIGHTGRAY)
Local aTipFol  := {}

Private cTabEmp    := SubStr( SuperGetMV("DT_TBEMP" ), 1, TamSX3("RCB_CODIGO")[1] ) 
Private aEmpComp   := {}
Private aTamanhos  := {}    
Private cEmpRat	   := ""
Private nPos	   := 0
Private cDescEmpRat:= ""

Aadd( aTipFol, "Folha"                )
Aadd( aTipFol, "Provis緌 13� Sal嫫io" )
Aadd( aTipFol, "Provis緌 F廨ias"      )
Aadd( aTipFol, "1� Parc. 13� Sal嫫io" )
Aadd( aTipFol, "2� Parc. 13� Sal嫫io" )
Aadd( aTipFol, "F廨ias"               )
Aadd( aTipFol, "Rescis緌"             )

//----------------------------------------------------------------------------
//
//----------------------------------------------------------------------------------------------------------------

oFont1  := TFont():New( 'Arial', 08, 08, .T., .T., 5, .T., 5, .F., .F. )
oFont2  := TFont():New( 'Arial', 08, 08, .T., .F., 5, .T., 5, .F., .F. )
oFont3  := TFont():New( 'Arial', 09, 09, .T., .F., 5, .T., 5, .F., .F. )
oFont3N := TFont():New( 'Arial', 09, 09, .T., .T., 5, .T., 5, .F., .F. )
oFont4  := TFont():New( 'Arial', 09, 09, .T., .F., 5, .T., 5, .F., .F. )
oFont5  := TFont():New( 'Arial', 10, 10, .T., .T., 5, .T., 5, .F., .F. )
oFont6  := TFont():New( 'Arial', 10, 10, .T., .F., 5, .T., 5, .F., .F. )
oFont7  := TFont():New( 'Arial', 12, 12, .T., .F., 5, .T., 5, .F., .F. )
oFont7N := TFont():New( 'Arial', 12, 12, .T., .T., 5, .T., 5, .F., .F. )
oFont8  := TFont():New( 'Arial', 12, 12, .T., .F., 5, .T., 5, .F., .F. )
oFont9  := TFont():New( 'Arial', 16, 16, .T., .F., 5, .T., 5, .F., .F. )
oFont9N := TFont():New( 'Arial', 16, 16, .T., .T., 5, .T., 5, .F., .F. )
oFont10 := TFont():New( 'Arial', 20, 20, .T., .T., 5, .T., 5, .F., .F. )

//----------------------------------------------------------------------------
//
//----------------------------------------------------------------------------------------------------------------

cQuery :=        "Select ZD7.ZD7_FILRAT, ZD7.ZD7_MAT, SRA.RA_NOME, ZD7.ZD7_CC, CTT.CTT_DESC01, ZD7.ZD7_ITEM, CTD.CTD_DESC01, ZD7.ZD7_TIPFOL, ZD7.ZD7_VERBA, RV_DESC, RV_TIPOCOD, ZD7.ZD7_VALRAT, ZD7.ZD7_PERC,ZD7.ZD7_CTADEB,ZD7.ZD7_CTACRE"

cQuery += CRLF + "  From " + RetSqlName("ZD7") + " ZD7 "

cQuery += CRLF + "  Left Join " + RetSqlName("SRA") + " SRA On SRA.D_E_L_E_T_ = ' ' And SubStr( SRA.RA_FILIAL, 1, "  + Str( nSizeCTT, 2 ) + " ) = SubStr( ZD7.ZD7_FILIAL, 1, " + Str( nSizeCTT, 2 ) + ") And SRA.RA_MAT = ZD7.ZD7_MAT"
cQuery += CRLF + "  Left Join " + RetSqlName("SRV") + " SRV On SRV.D_E_L_E_T_ = ' ' And SRV.RV_FILIAL  = '" + xFilial("SRV") + "' And SRV.RV_COD = ZD7.ZD7_VERBA"
cQuery += CRLF + "  Left Join " + RetSqlName("CTD") + " CTD On CTD.D_E_L_E_T_ = ' ' And SubStr( CTD.CTD_FILIAL, 1, " + Str( nSizeCTD, 2 ) + " ) = SubStr( SRA.RA_FILIAL, 1, " + Str( nSizeCTD, 2 ) + " ) And CTD.CTD_ITEM = ZD7.ZD7_ITEM"
cQuery += CRLF + "  Left Join " + RetSqlName("CTT") + " CTT On CTT.D_E_L_E_T_ = ' ' And SubStr( CTT.CTT_FILIAL, 1, " + Str( nSizeCTT, 2 ) + " ) = SubStr( SRA.RA_FILIAL, 1, " + Str( nSizeCTT, 2 ) + " ) And CTT.CTT_CUSTO = ZD7.ZD7_CC"

cQuery += CRLF + " Where ZD7.D_E_L_E_T_ = ' '"
cQuery += CRLF + "   And ZD7.ZD7_MESANO = '" + StrZero( Year( MV_PAR01 ), 4 ) + StrZero( Month( MV_PAR01 ), 2 ) + "'"
cQuery += CRLF + "   And SubStr( ZD7.ZD7_FILRAT, 1, " + Str( nSizeCTT, 2 ) + " ) BETWEEN '" + SubStr( MV_PAR02, 1, nSizeCTT ) + "' And '" + SubStr( MV_PAR03, 1, nSizeCTT ) + "'"
cQuery += CRLF + "   And ZD7.ZD7_MAT    BETWEEN '" + MV_PAR04 + "' And '" + MV_PAR05 + "'"

cQuery += CRLF + " Order By ZD7.ZD7_MAT, ZD7.ZD7_VERBA, ZD7.ZD7_CC, ZD7.ZD7_ITEM,ZD7.ZD7_FILRAT"

cQuery := ChangeQuery( cQuery )

dbUseArea( .T., "TOPCONN", TCGenQry(,,cQuery), cAlias, .T., .T. )
TcSetField( cAlias, "ZD7_VALRAT", "N", TamSX3("ZD7_VALRAT")[1], TamSX3("ZD7_VALRAT")[2] )
TcSetField( cAlias, "ZD7_PERC"  , "N", TamSX3("ZD7_PERC"  )[1], TamSX3("ZD7_PERC"  )[2] )

dbSelectArea(cAlias)

//----------------------------------------------------------------------------
//
//----------------------------------------------------------------------------------------------------------------

DTGPE02Get() //carrega descri誽o de empresas

While (cAlias)->( !Eof() )

	If oReport:Cancel()
		Exit
	EndIf
	
	//----------------------------------------------------------------
	//	Itens
	//--------------------------------------------------------------------------------------------------

	If lCabec

		lCabec := .F.
	
		oReport:FillRect({ (nLinha+43), 0011, (nLinha+100), 3400}, oBrush)
			
		oReport:Box(  (nLinha+40), 0010, (nLinha+100), 3400)

		oReport:Say( (nLinha+01), 1500, "DATA BASE: " + Upper( MesExtenso( MV_PAR01 ) ) + " / " + StrZero( Year( MV_PAR01 ), 4 ), oFont5,,,, 0 )

		oReport:Say( (nLinha+50), 0015, "Filial"                                 , oFont3N,,,, 0 )
		oReport:Say( (nLinha+50), 0135, "Mat."		                             , oFont3N,,,, 0 )
		oReport:Say( (nLinha+50), 0255, "Nome"                                   , oFont3N,,,, 0 )//Posi誽o Original 250
		oReport:Say( (nLinha+50), 0650, "C. Custo"		                         , oFont3N,,,, 0 )//Posi誽o Original 750
		oReport:Say( (nLinha+50), 0800, "Descri誽o"                              , oFont3N,,,, 0 )//Posi誽o Original 1000
		oReport:Say( (nLinha+50), 1300, "Item Cont墎il"                          , oFont3N,,,, 0 )//Posi誽o Original 1500
		oReport:Say( (nLinha+50), 1500, "Descri誽o"                              , oFont3N,,,, 0 )//Posi誽o Original 1700
		oReport:Say( (nLinha+50), 1900, "Tipo" 		                             , oFont3N,,,, 0 )//Posi誽o Original 2300
		oReport:Say( (nLinha+50), 2100, "Verba"                                  , oFont3N,,,, 0 )//Posi誽o Original 2600
		oReport:Say( (nLinha+50), 2400, "Vlr Rat."                          	 , oFont3N,,,, 0 )//Posi誽o Original 2970
		oReport:Say( (nLinha+50), 2600, "Percentual"                             , oFont3N,,,, 0 )//Posi誽o Original 3160
		oReport:Say( (nLinha+50), 2800, "D/C"		                             , oFont3N,,,, 0 )//Posi誽o Original 3160
		oReport:Say( (nLinha+50), 2900, "Rateio"                                 , oFont3N,,,, 0 )//Posi誽o Original 3160

		nLinha += 110

	EndIf
	
	cEmpRat := SUBSTR((cAlias)->ZD7_FILRAT,1,2)
	nPos:= ASCAN(aEmpcomp,{ |aEmpComp|  aEmpComp[2] = cEmpRat})
	cDescEmpRat := AllTrim(aEmpComp[nPos][1])

	If lVerba
		lVerba := .f.
		oReport:Say( nLinha, 0010,            (cAlias)->ZD7_FILRAT                           , oFont2,,,, 0 )
		oReport:Say( nLinha, 0135,            (cAlias)->ZD7_MAT                              , oFont2,,,, 0 )
		oReport:Say( nLinha, 0250,            SUBSTR((cAlias)->RA_NOME,1,20)                 , oFont2,,,, 0 )
		oReport:Say( nLinha, 2100,            SUBSTR((cAlias)->ZD7_VERBA + " - " + (cAlias)->RV_DESC,1,30) , oFont2,,,, 0 )
	EndIf

	oReport:Say( nLinha, 0650,               SUBSTR(AllTrim((cAlias)->ZD7_CC),1,11)         , oFont2,,,, 0 )
	oReport:Say( nLinha, 0800,               SUBSTR((cAlias)->CTT_DESC01,1,32)              , oFont2,,,, 0 )
	oReport:Say( nLinha, 1300,               (cAlias)->ZD7_ITEM                             , oFont2,,,, 0 )
	oReport:Say( nLinha, 1500,               SUBSTR((cAlias)->CTD_DESC01,1,32)              , oFont2,,,, 0 )
	oReport:Say( nLinha, 1900, 	  aTipFol[ Val( (cAlias)->ZD7_TIPFOL ) ]                    , oFont2,,,, 0 )
	oReport:Say( nLinha, 2400,    Transform( (cAlias)->ZD7_VALRAT, "@E 999,999,999.99" )    , oFont2,,,, 0 )
	oReport:Say( nLinha, 2620,    Transform( (cAlias)->ZD7_PERC  , "@E 999.99" ) + "%"      , oFont2,,,, 0 ) 
	oReport:Say( nLinha, 2817,    IIF(AllTrim((cAlias)->ZD7_CTADEB)<>'',"D","C")	        , oFont2,,,, 0 )
	oReport:Say( nLinha, 2900,    IIF(AllTrim((cAlias)->ZD7_CTADEB)<>'',AllTrim((cAlias)->ZD7_CTADEB)+" - "+cDescEmpRat,AllTrim((cAlias)->ZD7_CTACRE)+" - "+cDescEmpRat), oFont2,,,, 0 )
	

	nLinha += 40

	If nLinha >= 2500

		lNome := .T.
		lVerba:= .T.
		lCabec := .T.
		nLinha := 240

		oReport:EndPage()	

   EndIf

	cMat   := (cAlias)->ZD7_MAT
	cVerba := (cAlias)->ZD7_VERBA

	(cAlias)->( dbSkip() )
		
	If cMat # (cAlias)->ZD7_MAT
		nLinha += 10
	EndIf

	If cVerba # (cAlias)->ZD7_VERBA
		nLinha += 10
		lVerba := .T.
	EndIf
End

(cAlias)->( dbCloseArea() )
	
Return

/*/f/
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
<Descricao> : Rotina para controle de versao
<Data> : 24/05/2014
<Parametros> : Nenhum
<Retorno> : cRet
<Processo> : Controle de versao
<Tipo> (Menu,Trigger,Validacao,Ponto de Entrada,Genericas,Especificas ) : V
<Autor> : Doit Sistemas
<Obs> :
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
*/

User Function DTGPER2V()

Local cRet := ""
cRet := "20140523"
 
Return cRet 

/*/f/
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
<Descricao> : Rotina para retornar codigo e descri誽o das empresas a processar
<Data> : 18/06/2014
<Parametros> : Nenhum
<Retorno> : cRet
<Tipo> (Menu,Trigger,Validacao,Ponto de Entrada,Genericas,Especificas ) : V
<Autor> : Doit Sistemas
<Obs> :
嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈嗈�
*/

Static Function DTGPE02Get   

Local nI := 0
dbSelectArea("RCB")
dbSetOrder( 1 )

dbSelectArea("RCC")
dbSetOrder( 1 )



If RCB->( dbSeek( xFilial("RCB")+cTabEmp ) ) .And. RCC->( dbSeek( xFilial("RCC")+cTabEmp ) )

		While RCB->RCB_CODIGO == cTabEmp .And. !RCB->( Eof() )

		   Aadd( aTamanhos, RCB->RCB_TAMAN )

			RCB->( dbSkip() )

		End

		While RCC->RCC_CODIGO == cTabEmp .And. !RCC->( Eof() )

			nItem := 1

			Aadd( aEmpComp, Array( Len(aTamanhos) ) )

			For nI := 1 To Len( aTamanhos )

				aEmpComp[Len(aEmpComp)][nI] := SubStr( RCC->RCC_CONTEU, nItem, aTamanhos[nI] )

         	nItem += aTamanhos[nI]

			Next

			RCC->( dbSkip() )
	   End
	EndIf
                                        

Return