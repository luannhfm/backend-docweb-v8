#Include "Protheus.ch"
#Include "TopConn.ch"

/*/{Protheus.doc} AfterLogin
	Ponto de Entrada utilizado para enviar mensagem ao usuário ao acessar o PROTHEUS, 
	caso exista agendamento para o dia.

@author Paulo César P. Schwind
@since 17/05/2019
@version 1.0
@history 04/07/2019, Franklin de Brito de Oliveira, Adicionado fechamento do Alias "TRB"
@type function
/*/
User Function AfterLogin()
Local lRet      := .F.,;
      _cAliasP  := GetNextAlias(),;
      _cCodUsr  := RetCodUsr(),;
      _cCodAcao := '1',;
      nRegs     := 0  

Public __xNumCart := ""

if nModulo == 6 
    // Ajustado por Paulo Schwind - 06/08/2019
    // Fecha se estiver aberto
	IF Select(_cAliasP)
	   DbSelectArea(_cAliasP)
	   DbCloseArea()
	ENDIF

	BEGINSQL ALIAS _cAliasP

		column D1_EMISSAO 	as Date

		SELECT ZF1_FILIAL, ZF1_CODUSR, ZF1_AGENDA 
			FROM  %Table:ZF1% ZF1
			WHERE %NotDel% 
			AND ZF1_FILIAL = %exp:cFilAnt%    
			AND ZF1_CODUSR = %Exp:_cCodUsr%
			AND ZF1_ACAO   = %Exp:_cCodAcao%
			AND ZF1_AGENDA = %Exp:dDataBase%

    ENDSQL
    (_cAliasP)->(dbEval({|| nRegs++}))
    
    if nRegs > 0
		MsgInfo( UPPER(AllTrim(cUserName)) + chr(10)+chr(13);
                   +"Existe agendamento de cobrança. Verifique !" , "ATENÇÃO !!!" )          
    Endif    

    DbSelectArea(_cAliasP)
	DbCloseArea()
    
Endif   

Return



