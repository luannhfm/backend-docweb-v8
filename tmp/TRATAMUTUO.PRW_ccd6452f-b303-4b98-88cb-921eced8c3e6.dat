#Include "Protheus.ch"
#Include "TopConn.ch"

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³MUTUOCHR  ºAutor  ³Felipe Alves        º Data ³  22/03/13   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³                                                            º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ P11 - SISTEMA INDUSTRIA                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

User Function MutuoChr(nOpc)
Local aArea := {GetArea(), SF4->(GetArea()), SD1->(GetArea())}
Local lEhMutuo := .F.
Local cChave := SD1->(D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)
Local cAtual := SD1->(D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_COD+D1_ITEM)
Local cRet := ""

DbSelectArea("SD1")
SD1->(DbSetOrder(1))
SD1->(DbSeek(cChave))

While ((SD1->(!Eof())) .And. (cChave == SD1->(D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)))
	If (SD1->(D1_XMUTUO) == "1")
		lEhMutuo := .T.
	Endif
	
	SD1->(DbSkip())
Enddo

DbSelectArea("SD1")
SD1->(DbSetOrder(1))
SD1->(DbSeek(cAtual))

If (nOpc == 1)
	cRet := Iif(SF4->(F4_ESTOQUE) == "S", "11040101", Iif(lEhMutuo, "9999", SD1->(D1_CONTA)))
Elseif (nOpc == 2)
	cRet := Iif((Posicione("CT1", 1, xFilial("CT1") + SD1->D1_CONTA, "CT1_CCOBRG") == "1" .And. !(lEhMutuo)), SD1->D1_CC, Space(1))
Elseif (nOpc == 3)
	cRet := Iif((Posicione("CT1", 1, xFilial("CT1") + SD1->D1_CONTA, "CT1_ITOBRG") == "1" .And. !(lEhMutuo)), SD1->D1_ITEMCTA, Space(1))
Endif

aEval(aArea, {|x| RestArea(x)})
Return(cRet)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³MUTUOVLR  ºAutor  ³Felipe Alves        º Data ³  22/03/13   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³                                                            º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ P11 - SISTEMA INDUSTRIA                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

User Function MutuoVlr(nOpc)
Local aArea := {GetArea(), SF1->(GetArea()), SD1->(GetArea())}
Local lEhMutuo := .F.
Local cChave := SD1->(D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)
Local cAtual := SD1->(D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_COD+D1_ITEM)
Local nRet := 0

DbSelectArea("SD1")
SD1->(DbSetOrder(1))
SD1->(DbSeek(cChave))

While ((SD1->(!Eof())) .And. (cChave == SD1->(D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)))
	If (SD1->(D1_XMUTUO) == "1")
		lEhMutuo := .T.
	Endif
	
	SD1->(DbSkip())
Enddo

DbSelectArea("SD1")
SD1->(DbSetOrder(1))
SD1->(DbSeek(cAtual))

If (nOpc == 1)
	If ("FOL" $ SF1->(F1_SERIE+F1_COND))
		nRet := 0
	Else
		If (!(lEhMutuo) .And. (SD1->(D1_RATEIO <> "1")) .And. (SD1->(D1_TES) <> "012") .And. (SD1->(D1_TES) <> "001"))
			If (!(Empty(SD1->(D1_CLVL))))
				nRet := SD1->(D1_TOTAL) - SF1->(F1_DESCONT)
			Else
				nRet := SD1->(D1_TOTAL)
			Endif
		Else
			If (lEhMutuo)
				nRet := SD1->(D1_CUSTO)
			Else
				nRet := 0
			Endif
		Endif
	Endif
Elseif (nOpc == 2)
	If ("FOL" $ SF1->(F1_SERIE+F1_COND))
		nRet := 0
	Else
		If ((Empty(SD1->(D1_CLVL))) .And. !(lEhMutuo))
			nRet := SF1->(F1_DESCONT)
		Else
			nRet := 0
		Endif
	Endif
Endif

aEval(aArea, {|x| RestArea(x)})
Return(nRet)

User Function EstVlr(cRateio, nValor, cConta, cCC, cItemCta)
Local nRet := 0
Local cQuery := ""
Local cTab := ""

cQuery := "SELECT" + CRLF
cQuery += "T1.ZY_VALOR" + CRLF
cQuery += "FROM SZX010 T0" + CRLF
cQuery += "INNER JOIN SZY010 T1 ON ((T1.ZY_RATEIO = T0.ZX_RATEIO) AND (T1.ZY_ITEMRAT = T0.ZX_ITEM))" + CRLF
cQuery += "WHERE T0.ZX_FILIAL = ''" + CRLF
cQuery += "AND T0.ZX_RATEIO = '000171'" + CRLF
cQuery += "AND T0.ZX_VALOR BETWEEN 1052.99 AND 1053.01" + CRLF
cQuery += "AND T0.D_E_L_E_T_ = ''" + CRLF
cQuery += "AND T1.ZY_FILIAL = ''" + CRLF
cQuery += "AND T1.ZY_DEBITO = '31010401'" + CRLF
cQuery += "AND T1.ZY_CCD = '05010602'" + CRLF
cQuery += "AND T1.ZY_ITEMD = '40101010104'" + CRLF
cQuery += "AND T1.D_E_L_E_T_ = ''"
Return(nRet)