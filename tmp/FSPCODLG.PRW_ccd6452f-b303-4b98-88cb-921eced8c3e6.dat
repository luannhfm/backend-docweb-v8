#Include 'Protheus.Ch'
#Include 'TopConn.Ch'

/*-------------------------------------------------
@Author	Pierre Pessoa
@Since 	26/08/2014
@Version P11
@Param  	N緌 Possui
@Return 	N緌 Possui
@Obs
		Faz o rateio do funcionario por C.R e U.O
---------------------------------------------------
Programador     	Data			Motivo
-------------------------------------------------*/
User Function FSPCODLG(aRatFunc,lOk,cUnid1)

Local nOpc 			:= GD_INSERT+GD_DELETE+GD_UPDATE
Default lOk 		:= .T.
Default cUnid1		:= cCentro
Private cUorgan1	:= cUnid1
Private aCoBrwRat := {}
Private aHoBrwRat := {}
Private noBrwRat  := 0
                                                                 
SetPrvt("oDlgRat","oBrwRat","oSBtnRat1","oSBtnRat2")

oDlgRat    := MSDialog():New( 092,225,308,795,"Rateio",,,.F.,,,,,,.T.,,,.T. )
MHoBrwRat()
MCoBrwRat(aRatFunc)
oBrwRat    := MsNewGetDados():New(004,004,084,284,nOpc,'AllwaysTrue()','AllwaysTrue()','',,0,99,'AllwaysTrue()','','AllwaysTrue()',oDlgRat,aHoBrwRat,aCoBrwRat )
oSBtnRat1  := SButton():New( 092,215,1,{||FSVLRAT(),lOk:=.T.,ODlgRat:End()},oDlgRat,,"", )
oSBtnRat2  := SButton():New( 092,255,2,{||lOk:=.F.,oDlgRat:End()},oDlgRat,,"", )

oDlgRat:Activate(,,,.T.)
aRatFunc := ACLone(oBrwRat:Acols)

Return (aRatFunc)


/*-------------------------------------------------
@Author	Pierre Pessoa
@Since 	26/08/2014
@Version P11
@Param  	N緌 Possui
@Return 	N緌 Possui
@Obs
	Monta aHeader da MsNewGetDados para o Alias: ZDA
---------------------------------------------------
Programador     	Data			Motivo
-------------------------------------------------*/
Static Function MHoBrwRat()
	
DbSelectArea("SX3")
SX3->(DbSetOrder(2))

aCampos := {"ZDA_ITCONT","CTD_DESC01","ZDA_PRCRAT"}

	For nX := 1 To Len(aCampos)
		//Adiciona as colunas do aHeader
		SX3->(DbSeek(aCampos[nX]))
		
		If X3Uso(SX3->X3_USADO) .And. cNivel >= SX3->X3_NIVEL
			noBrwRat++
			Aadd(aHoBrwRat,{Trim(X3Titulo()),;
										SX3->X3_CAMPO	,;
										SX3->X3_PICTURE,;
										SX3->X3_TAMANHO,;
										SX3->X3_DECIMAL,;
										Iif(SX3->X3_CAMPO == "ZDA_ITCONT",'U_FDESCIT()',SX3->X3_VALID)	,;
										SX3->X3_USADO	,;
										SX3->X3_TIPO	,;
										SX3->X3_F3		,;
										SX3->X3_ARQUIVO,;
										SX3->X3_CONTEXT })
		Endif
	
	Next nX

Return


/*闡闡闡薩闡闡闡闡鐃闡闡闡鐃闡闡闡闡闡闡闡闡闡闡闡鐃闡闡闡薩闡闡闡闡闡闡闡闡闡
Function  � MCoBrwRat() - Monta aCols da MsNewGetDados para o Alias: ZDA
闡闡闡闡闡鼴闡闡闡闡鐘闡闡闡鐘闡闡闡闡闡闡闡闡闡闡闡鐘闡闡闡謐闡闡闡闡闡闡闡*/
Static Function MCoBrwRat(aRat2)

Local aAux := {}

aCoBrwRat := Aclone(aRat2)                              

Return()


/*-------------------------------------------------
@Author	Do.It Sistemas - P.T
@Since 	27/08/2014
@Version P11
@Param  	N緌 Possui
@Return 	N緌 Possui
@Obs
	Valida se o total do Rateio � de 100%
---------------------------------------------------
Programador     	Data			Motivo
-------------------------------------------------*/
Static Function FSVLRAT()

Local nX 	 	:= 1
Local lRet 	 	:= .T.		
Local nPrcRat := aScan(aHoBrwRat,{|x| AllTrim(x[2])=="ZDA_PRCRAT"})
Local nTotal	:= 0
 
//Percorre o array atribuindo o total do rateio de cada linha
For nX := 1 To Len(oBrwRat:acols)                                                                           
	nTotal += oBrwRat:acols[nX,nPrcRat] 
Next nX    

//Verifica se o total do rateio difere de 100%
If nTotal != 100
		lRet:=.F.
	Aviso('RATEIO FIEMT','Percentual difere de 100%!'+CRLF+CRLF+'Percentual informado: '+cValToChar(nTotal)+'%'+CRLF+CRLF+'N緌 � poss癉el prosseguir!',{'Ok'},1,'Aten誽o!')
Else
//	MsgInfo("Percentual Igual a 100% !")
//	oDlgRat:End()
Endif

Return(lRet)
User Function FDESCIT()

   Local nOrder
   Local	cDesc01 	:= Posicione("ZZX",1,xFilial("ZZX")+cUorgan1+M->ZDA_ITCONT,"ZZX_DITEM")
   Local lRet		:= .T.
   oBrwRat:acols[oBrwRat:nAt][GDFieldPos("CTD_DESC01" ,oBrwRat:aHeader)] :=  cDesc01
   
   
	nOrder := RetOrder("ZZX","ZZX_FILIAL+ZZX_FILAUX+ZZX_CUSTO+ZZX_ITEM")
	lRet := !Empty(Posicione("ZZX",nOrder,xFilial("ZZX")+cFiliAtu+cUorgan1+M->ZDA_ITCONT,"ZZX_ITEM"))
	iF !lRet
		MsgAlert(OemToAnsi("Usu嫫io sem permiss緌 para adicionar o C.R informada!!!"))				
	EndIf

Return(lRet)