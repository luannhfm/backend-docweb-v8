#include "PROTHEUS.CH"

//-- Diretivas indicando as colunas para Matriz de Verbas
#define VB_QTDCOL	 7

#define VB_VERBA   1
#define VB_TIPO    2
#define VB_TOTAL   3
#define VB_CC      4
#define VB_ITEM    5
#define VB_PERCEN  6
#define VB_VALOR   7
                                                   	
//-- Diretivas indicando as colunas para Matriz de Totalização
#define TT_QTDCOL  7

#define TT_CC      1
#define TT_ITEM    2
#define TT_PROV    3
#define TT_DESC    4
#define TT_BASE    5
#define TT_CODCC   6
#define TT_CODITEM 7

/*/f/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
<Descricao> : Consulta de Rateio de Verbas
<Autor> : Fábrica DOIT SP
<Data> : 12/05/2014
<Parametros> : Nil
<Retorno> : Nil
<Processo> : FIEMT – Folha de Pagamento
<Tipo> : 
<Obs> : 
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
*/

User Function DTGPE03()

//-- Dialog
Local oDlg
Local oPanel
Local nItem,nLine,nPos

//-- Controle de dimensoes de objetos
Local aObjects	    := {}
Local aInfo		    := {}
Local aPosObj	    := {}  
Local aSize		    := {}
Local lOk		    := .F.

Local aTitVerba    := {}
Local aTitTotal    := {}
Local nL			  := 0
Private aVbFol     := {}
Private aTotFol    := {}

Private aVbP13     := {}
Private aTotP13    := {}

Private aVbPFer    := {}
Private aTotPFer   := {}

Private oMesBase   := Nil
Private oAnoBase   := Nil
Private oCodFunc   := Nil
Private oNomeFunc  := Nil

Private oListVFol  := Nil
Private oListTFol  := Nil

Private oListVP13  := Nil
Private oListTP13  := Nil

Private oListVPFer := Nil
Private oListTPFer := Nil

Private oProvFol   := Nil
Private oDescFol   := Nil
Private oBaseFol   := Nil

Private oProvP13   := Nil
Private oDescP13   := Nil
Private oBaseP13   := Nil

Private oProvPFer  := Nil
Private oDescPFer  := Nil
Private oBasePFer  := Nil

Private aMesBase   := {}
Private aAnoBase   := {}
Private aTipoVerba := {}
Private cPeriodo   := GETMV("MV_FOLMES")
Private cMesBase   := ""
Private cAnoBase   := SUBSTR(cPeriodo,1,4) //StrZero(  Year( dDataBase ), 4 )
Private cCodFunc   := SRA->RA_MAT
Private cNomeFunc  := SRA->RA_NOME

Private nProvFol   := 0
Private nDescFol   := 0
Private nBaseFol   := 0

Private nProvP13   := 0
Private nDescP13   := 0
Private nBaseP13   := 0

Private nProvPFer  := 0
Private nDescPFer  := 0
Private nBasePFer  := 0
//---------------------------------
//
//--------------------------------------------------

For nL := 2000 To Year( dDataBase )

   Aadd( aAnoBase, Str( nL, 4 ) )

Next

Aadd( aMesBase, "Janeiro"   )
Aadd( aMesBase, "Fevereiro" )
Aadd( aMesBase, "Março"     )
Aadd( aMesBase, "Abril"     )
Aadd( aMesBase, "Maio"      )
Aadd( aMesBase, "Junho"     )
Aadd( aMesBase, "Julho"     )
Aadd( aMesBase, "Agosto"    )
Aadd( aMesBase, "Setembro"  )
Aadd( aMesBase, "Outubro"   )
Aadd( aMesBase, "Novembro"  )
Aadd( aMesBase, "Dezembro"  )

cMesBase := aMesBase[ VAL(SUBSTR(cPERIODO,5,2))] //aMesBase[ Month( dDataBase ) ]

//--

aAdd( aTipoVerba, 'Provento'       )
aAdd( aTipoVerba, 'Desconto'       )
aAdd( aTipoVerba, 'Base'           )

aAdd( aTitVerba, 'Verba'           )
aAdd( aTitVerba, 'Tipo'            )
aAdd( aTitVerba, 'Centro de Custo' )
aAdd( aTitVerba, 'Item Contábil'   )
aAdd( aTitVerba, 'Total (R$)'      )
aAdd( aTitVerba, 'Rateio (%)'      )
aAdd( aTitVerba, 'Valor (R$)'      )

aAdd( aTitTotal, 'Centro de Custo' )
aAdd( aTitTotal, 'Item Contábil'   )
aAdd( aTitTotal, 'Proventos (R$)'  )
aAdd( aTitTotal, 'Descontos (R$)'  )
aAdd( aTitTotal, 'Base (R$)'       )

//-- Dimensoes padroes
aSize   := MsAdvSize()
AAdd( aObjects, { 100, 020, .T., .F., .T. } )
AAdd( aObjects, { 100, 100, .T., .T. } )
AAdd( aObjects, { 100, 020, .F., .F. } )
aInfo   := { aSize[ 1 ], aSize[ 2 ], aSize[ 3 ], aSize[ 4 ], 5, 5 }
aPosObj := MsObjSize( aInfo, aObjects,.T.)

MsgRun( "Aguarde, selecionando informações...",, {|| GPE03Qry()} )

If .T.
		
	DEFINE MSDIALOG oDlg TITLE cCadastro FROM aSize[7],00 TO aSize[6],aSize[5] PIXEL
		
		@ 005,005 Say "Matrícula:"                                                    Of oDlg Pixel
		@ 013,005 MsGet oCodFunc    Var cCodFunc  When .F.       	      Size 030,07 Of oDlg Pixel

		@ 005,045 Say "Funcionário:"                                                  Of oDlg Pixel
		@ 013,045 MsGet oNomeFunc   Var cNomeFunc When .F.       	      Size 300,07 Of oDlg Pixel

		@ 005,355 Say "Mês:"                                                          Of oDlg Pixel
		@ 013,355 ComboBox oMesBase Var cMesBase           Items aMesBase Size 100,36 Of oDlg Pixel

		@ 005,465 Say "Ano:"                                                          Of oDlg Pixel
		@ 013,465 ComboBox oAnoBase Var cAnoBase           Items aAnoBase Size 070,36 Of oDlg Pixel

		@ 013,545 Button "Filtrar"                                        Size 040,11 Of oDlg Pixel Action ( GPE03Qry() )

      //------------------ Documentos

		aPosObj[2,1] += 5

		oFolder := TFolder():NEW( aPosObj[2,1],004, { "Folha de Pagamento", "Provisão de Férias", "Provisão de 13º Salário" },, oDlg, 1,,, .t.,, aPosObj[2,4],aPosObj[3,3] )

		//-- Folha de Pagamento

		@ 020,005 LISTBOX oListVFol Fields HEADER;
			  aTitVerba[01],;
			  aTitVerba[02],;
			  aTitVerba[03],;
			  aTitVerba[04],;
 			  aTitVerba[05],;
 			  aTitVerba[06],;
 			  aTitVerba[07] SIZE ( aPosObj[2,4] - 10 ), 110 OF oFolder:aDialogs[1] PIXEL 
			
		oListVFol:SetArray( aVbFol )
		oListVFol:bLine   := { || {            aVbFol[ oListVFol:nAT,VB_VERBA  ]                      ,;
										               aVbFol[ oListVFol:nAT,VB_TIPO   ]                      ,;
										               aVbFol[ oListVFol:nAT,VB_CC     ]                      ,;
										               aVbFol[ oListVFol:nAT,VB_ITEM   ]                      ,;
										    Transform( aVbFol[ oListVFol:nAT,VB_TOTAL  ], "@E 999,999,999.99"),;
										    Transform( aVbFol[ oListVFol:nAT,VB_PERCEN ], "@E 999.99"        ),;
										    Transform( aVbFol[ oListVFol:nAT,VB_VALOR  ], "@E 999,999,999.99")}}

		@ 135,005 LISTBOX oListTFol Fields HEADER;
				 aTitTotal[ 01 ],;
				 aTitTotal[ 02 ],;
				 aTitTotal[ 03 ],;
				 aTitTotal[ 04 ],;
				 aTitTotal[ 05 ] SIZE ( aPosObj[2,4] - 10 ), 085 OF oFolder:aDialogs[1] PIXEL

		oListTFol:SetArray( aTotFol )
		oListTFol:bLine      := { || {            aTotFol[ oListTFol:nAT,TT_CC   ]                      ,;
											               aTotFol[ oListTFol:nAT,TT_ITEM ]                      ,;
											    Transform( aTotFol[ oListTFol:nAT,TT_PROV ], "@E 999,999,999.99"),;
											    Transform( aTotFol[ oListTFol:nAT,TT_DESC ], "@E 999,999,999.99"),;
											    Transform( aTotFol[ oListTFol:nAT,TT_BASE ], "@E 999,999,999.99")}}

		@ 007,005 Say "Total Proventos (R$):"                                                     Of oFolder:aDialogs[1] Pixel
		@ 005,060 MsGet oProvFol    Var nProvFol   Picture "@E 999,999,999.99" When .F. Size 60,9 Of oFolder:aDialogs[1] Pixel

		@ 007,205 Say "Total Descontos (R$):"                                                     Of oFolder:aDialogs[1] Pixel
		@ 005,260 MsGet oDescFol    Var nDescFol   Picture "@E 999,999,999.99" When .F. Size 60,9 Of oFolder:aDialogs[1] Pixel

		@ 007,405 Say "Total Base (R$):"                                                          Of oFolder:aDialogs[1] Pixel
		@ 005,448 MsGet oBaseFol    Var nBaseFol   Picture "@E 999,999,999.99" When .F. Size 60,9 Of oFolder:aDialogs[1] Pixel

		//-- Provisão de Férias

		@ 020,005 LISTBOX oListVPFer Fields HEADER;
			  aTitVerba[01],;
			  aTitVerba[02],;
			  aTitVerba[03],;
			  aTitVerba[04],;
 			  aTitVerba[05],;
 			  aTitVerba[06],;
 			  aTitVerba[07] SIZE ( aPosObj[2,4] - 10 ), 110 OF oFolder:aDialogs[2] PIXEL 
			
		oListVPFer:SetArray( aVbPFer )
		oListVPFer:nFreeze := 1
		oListVPFer:bLine   := { || {            aVbPFer[ oListVPFer:nAT,VB_VERBA  ]                      ,;
										                aVbPFer[ oListVPFer:nAT,VB_TIPO   ]                      ,;
										                aVbPFer[ oListVPFer:nAT,VB_CC     ]                      ,;
										                aVbPFer[ oListVPFer:nAT,VB_ITEM   ]                      ,;
										     Transform( aVbPFer[ oListVPFer:nAT,VB_TOTAL  ], "@E 999,999,999.99"),;
										     Transform( aVbPFer[ oListVPFer:nAT,VB_PERCEN ], "@E 999.99"        ),;
										     Transform( aVbPFer[ oListVPFer:nAT,VB_VALOR  ], "@E 999,999,999.99")}}

		@ 135,005 LISTBOX oListTPFer Fields HEADER;
				 aTitTotal[ 01 ],;
				 aTitTotal[ 02 ],;
				 aTitTotal[ 03 ],;
				 aTitTotal[ 04 ],;
				 aTitTotal[ 05 ] SIZE ( aPosObj[2,4] - 10 ), 085 OF oFolder:aDialogs[2] PIXEL

		oListTPFer:SetArray( aTotPFer )
		oListTPFer:bLine      := { || {            aTotPFer[ oListTPFer:nAT,TT_CC   ]                      ,;
											                aTotPFer[ oListTPFer:nAT,TT_ITEM ]                      ,;
											     Transform( aTotPFer[ oListTPFer:nAT,TT_PROV ], "@E 999,999,999.99"),;
											     Transform( aTotPFer[ oListTPFer:nAT,TT_DESC ], "@E 999,999,999.99"),;
											     Transform( aTotPFer[ oListTPFer:nAT,TT_BASE ], "@E 999,999,999.99")}}

		@ 007,005 Say "Total Proventos (R$):"                                                     Of oFolder:aDialogs[2] Pixel
		@ 005,060 MsGet oProvPFer   Var nProvPFer  Picture "@E 999,999,999.99" When .F. Size 60,9 Of oFolder:aDialogs[2] Pixel

		@ 007,205 Say "Total Descontos (R$):"                                                     Of oFolder:aDialogs[2] Pixel
		@ 005,260 MsGet oDescPFer   Var nDescPFer  Picture "@E 999,999,999.99" When .F. Size 60,9 Of oFolder:aDialogs[2] Pixel

		@ 007,405 Say "Total Base (R$):"                                                          Of oFolder:aDialogs[2] Pixel
		@ 005,448 MsGet oBasePFer   Var nBasePFer  Picture "@E 999,999,999.99" When .F. Size 60,9 Of oFolder:aDialogs[2] Pixel

		//-- Provisão de 13º Salário

		@ 020,005 LISTBOX oListVP13 Fields HEADER;
			  aTitVerba[01],;
			  aTitVerba[02],;
			  aTitVerba[03],;
			  aTitVerba[04],;
 			  aTitVerba[05],;
 			  aTitVerba[06],;
 			  aTitVerba[07] SIZE ( aPosObj[2,4] - 10 ), 110 OF oFolder:aDialogs[3] PIXEL 
			
		oListVP13:SetArray( aVbP13 )
		oListVP13:nFreeze := 1
		oListVP13:bLine   := { || {            aVbP13[ oListVP13:nAT,VB_VERBA  ]                      ,;
										               aVbP13[ oListVP13:nAT,VB_TIPO   ]                      ,;
										               aVbP13[ oListVP13:nAT,VB_CC     ]                      ,;
										               aVbP13[ oListVP13:nAT,VB_ITEM   ]                      ,;
										    Transform( aVbP13[ oListVP13:nAT,VB_TOTAL  ], "@E 999,999,999.99"),;
										    Transform( aVbP13[ oListVP13:nAT,VB_PERCEN ], "@E 999.99"        ),;
										    Transform( aVbP13[ oListVP13:nAT,VB_VALOR  ], "@E 999,999,999.99")}}

		@ 135,005 LISTBOX oListTP13 Fields HEADER;
				 aTitTotal[ 01 ],;
				 aTitTotal[ 02 ],;
				 aTitTotal[ 03 ],;
				 aTitTotal[ 04 ],;
				 aTitTotal[ 05 ] SIZE ( aPosObj[2,4] - 10 ), 085 OF oFolder:aDialogs[3] PIXEL

		oListTP13:SetArray( aTotP13 )
		oListTP13:bLine      := { || {            aTotP13[ oListTP13:nAT,TT_CC   ]                      ,;
											               aTotP13[ oListTP13:nAT,TT_ITEM ]                      ,;
											    Transform( aTotP13[ oListTP13:nAT,TT_PROV ], "@E 999,999,999.99"),;
											    Transform( aTotP13[ oListTP13:nAT,TT_DESC ], "@E 999,999,999.99"),;
											    Transform( aTotP13[ oListTP13:nAT,TT_BASE ], "@E 999,999,999.99")}}

		@ 007,005 Say "Total Proventos (R$):"                                                     Of oFolder:aDialogs[3] Pixel
		@ 005,060 MsGet oProvP13    Var nProvPFer  Picture "@E 999,999,999.99" When .F. Size 60,9 Of oFolder:aDialogs[3] Pixel

		@ 007,205 Say "Total Descontos (R$):"                                                     Of oFolder:aDialogs[3] Pixel
		@ 005,260 MsGet oDescP13    Var nDescPFer  Picture "@E 999,999,999.99" When .F. Size 60,9 Of oFolder:aDialogs[3] Pixel

		@ 007,405 Say "Total Base (R$):"                                                          Of oFolder:aDialogs[3] Pixel
		@ 005,448 MsGet oBaseP13    Var nBasePFer  Picture "@E 999,999,999.99" When .F. Size 60,9 Of oFolder:aDialogs[3] Pixel

	ACTIVATE MSDIALOG oDlg ON INIT EnchoiceBar( oDlg,{|| .T. }, {|| oDlg:End() },, ) 
			
EndIf
 
Return .T.

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ GPE03QRY        ³ Marcelo Coutinho    º Data ³  12/05/14    º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³                                                             º±±
±±º          ³                                                             º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ DTGPE03                                                     º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function GPE03QRY()
Local cAliasQry  := GetNextAlias()
Local aAreaAtu   := GetArea()
Local cQuery     := ''
Local cMes       := StrZero( Iif( oMesBase == Nil, Ascan( aMesBase, cMesBase ), oMesBase:nAt ), 2 )
Local cAno       := cAnoBase
Local nI         := 0
Local aTipoVerba := {}

Local nDelVbFol  := Len( aVbFol   )
Local nDelVbP13  := Len( aVbP13   )
Local nDelVbPFer := Len( aVbPFer  )

Local nDelTtFol  := Len( aTotFol  )
Local nDelTtP13  := Len( aTotP13  )
Local nDelTtPFer := Len( aTotPFer )

Local nSizeCTT  := 4//4 ALTERADO PORQUE AS 4 POSIÇÕES DO ZD7_FILRAT ESTÁ DIFERENTE DO CTT_FILIAL
Local nSizeCTD  := 4//4 ALTERADO PORQUE AS 4 POSIÇÕES DO ZD7_FILRAT ESTÁ DIFERENTE DO CTT_FILIAL

Aadd( aTipoVerba, "PROVENTO" )
Aadd( aTipoVerba, "DESCONTO" )
Aadd( aTipoVerba, "BASE"     )

//--------------------------------------
//
//-----------------------------------------------------------

For nI := 1 To nDelVbFol; 	aDel( aVbFol,   nI ); Next
For nI := 1 To nDelVbP13;  aDel( aVbP13,   nI ); Next
For nI := 1 To nDelVbPFer; aDel( aVbPFer,  nI ); Next

For nI := 1 To nDelTtFol; 	aDel( aTotFol,  nI ); Next
For nI := 1 To nDelTtP13;  aDel( aTotP13,  nI ); Next
For nI := 1 To nDelTtPFer; aDel( aTotPFer, nI ); Next

aSize( aVbFol,   0 )
aSize( aVbP13,   0 )
aSize( aVbPFer,  0 )

aSize( aTotFol,  0 )
aSize( aTotP13,  0 )
aSize( aTotPFer, 0 )

nProvFol  := 0
nDescFol  := 0
nBaseFol  := 0

nProvP13  := 0
nDescP13  := 0
nBaseP13  := 0

nProvPFer := 0
nDescPFer := 0
nBasePFer := 0

//--------------------------------------
//
//-----------------------------------------------------------

cQuery :=        "Select ZD7.ZD7_TIPFOL, ZD7.ZD7_VERBA, SRV.RV_DESC, SRV.RV_TIPOCOD, ZD7.ZD7_CC, CTT.CTT_DESC01, ZD7.ZD7_ITEM, CTD.CTD_DESC01 , ZD7.ZD7_VALOR, ZD7.ZD7_PERC, ZD7.ZD7_VALRAT"

cQuery += CRLF + "  From " + RetSqlName("ZD7") + " ZD7 "

cQuery += CRLF + "  Left Join " + RetSqlName("SRV") + " SRV On SRV.RV_FILIAL = '" + xFilial( "SRV" ) + "' And SRV.RV_COD  = ZD7.ZD7_VERBA And SRV.D_E_L_E_T_ = ' '"
cQuery += CRLF + "  Left Join " + RetSqlName("CTD") + " CTD On SubStr( CTD.CTD_FILIAL, 1, " + Str( nSizeCTD, 2 ) + " ) = SubStr( ZD7.ZD7_FILRAT, 1, " + Str( nSizeCTD, 2 ) + ") And CTD.CTD_ITEM  = ZD7.ZD7_ITEM And CTD.D_E_L_E_T_ = ' '"
cQuery += CRLF + "  Left Join " + RetSqlName("CTT") + " CTT On SubStr( CTT.CTT_FILIAL, 1, " + Str( nSizeCTT, 2 ) + " ) = SubStr( ZD7.ZD7_FILRAT, 1, " + Str( nSizeCTT, 2 ) + ") And CTT.CTT_CUSTO = ZD7.ZD7_CC   And CTT.D_E_L_E_T_ = ' '"

cQuery += CRLF + " Where ZD7.D_E_L_E_T_ = ' '"
cQuery += CRLF + "   And ZD7.ZD7_MAT    = '" + SRA->RA_MAT    + "'"
cQuery += CRLF + "   And ZD7.ZD7_MESANO = '" + cAno + cMes    + "'"

cQuery += CRLF + " Order By ZD7.ZD7_MESANO DESC, SRV.RV_TIPOCOD, ZD7.ZD7_VERBA, ZD7.ZD7_CC, ZD7.ZD7_ITEM "

cQuery := ChangeQuery( cQuery )

dbUseArea( .T., "TOPCONN", TCGenQry(,,cQuery), cAliasQry, .T., .T. )     
TCSetField(cAliasQry,"ZD7_VALOR" ,"N",TamSX3("ZD7_VALOR ")[1],TamSX3("ZD7_VALOR ")[2])
TCSetField(cAliasQry,"ZD7_PERC"  ,"N",TamSX3("ZD7_PERC  ")[1],TamSX3("ZD7_PERC  ")[2])
TCSetField(cAliasQry,"ZD7_VALRAT","N",TamSX3("ZD7_VALRAT")[1],TamSX3("ZD7_VALRAT")[2])

//--------------------------------------
//
//-----------------------------------------------------------

While (cAliasQry)->(!Eof())

	If (cAliasQry)->( ZD7_TIPFOL ) == '2'

		Aadd( aVbP13,   Array( VB_QTDCOL ) )

		nPosVbP13  := Len( aVbP13   )

		aVbP13[nPosVbP13][VB_VERBA ] :=                  (cAliasQry)->( RV_DESC    )
		aVbP13[nPosVbP13][VB_TIPO  ] := aTipoVerba[ Val( (cAliasQry)->( RV_TIPOCOD ) ) ]
		aVbP13[nPosVbP13][VB_CC    ] :=                  (cAliasQry)->( CTT_DESC01 )
		aVbP13[nPosVbP13][VB_ITEM  ] :=                  (cAliasQry)->( CTD_DESC01 )
		aVbP13[nPosVbP13][VB_TOTAL ] :=                  (cAliasQry)->( ZD7_VALOR  )
		aVbP13[nPosVbP13][VB_PERCEN] :=                  (cAliasQry)->( ZD7_PERC   )
		aVbP13[nPosVbP13][VB_VALOR ] :=                  (cAliasQry)->( ZD7_VALRAT )

      nPosTtP13 := Ascan( aTotP13, {|x| x[06]+x[07] == (cAliasQry)->( ZD7_CC + ZD7_ITEM ) } )

		If nPosTtP13 == 0

			Aadd( aTotP13,  Array( TT_QTDCOL ) )
	
			nPosTtP13 := Len( aTotP13  )

		EndIf

		aTotP13[nPosTtP13][TT_CODCC  ] := (cAliasQry)->( ZD7_CC     )
		aTotP13[nPosTtP13][TT_CODITEM] := (cAliasQry)->( ZD7_ITEM   )
		aTotP13[nPosTtP13][TT_CC     ] := (cAliasQry)->( CTT_DESC01 )
		aTotP13[nPosTtP13][TT_ITEM   ] := (cAliasQry)->( CTD_DESC01 )

      If (cAliasQry)->( RV_TIPOCOD ) == '1'

			nProvP13                       += (cAliasQry)->( ZD7_VALRAT )

			If aTotP13[nPosTtP13][TT_PROV] == Nil
				aTotP13[nPosTtP13][TT_PROV] := (cAliasQry)->( ZD7_VALRAT )
			Else
				aTotP13[nPosTtP13][TT_PROV] += (cAliasQry)->( ZD7_VALRAT )
      	EndIf
      ElseIf (cAliasQry)->( RV_TIPOCOD ) == '2'

			nDescP13                       += (cAliasQry)->( ZD7_VALRAT )
			If aTotP13[nPosTtP13][TT_DESC] == Nil
				aTotP13[nPosTtP13][TT_DESC] := (cAliasQry)->( ZD7_VALRAT )
			Else
				aTotP13[nPosTtP13][TT_DESC] += (cAliasQry)->( ZD7_VALRAT )
         EndIf
      ElseIf (cAliasQry)->( RV_TIPOCOD ) == '3'

			nBaseP13                       += (cAliasQry)->( ZD7_VALRAT )
   		If aTotP13[nPosTtP13][TT_BASE] == Nil
	   		aTotP13[nPosTtP13][TT_BASE   ] := (cAliasQry)->( ZD7_VALRAT )
			Else
   			aTotP13[nPosTtP13][TT_BASE   ] += (cAliasQry)->( ZD7_VALRAT )
         EndIf
		EndIf

	ElseIf (cAliasQry)->( ZD7_TIPFOL ) == '3'

		Aadd( aVbPFer, Array( VB_QTDCOL ) )

		nPosVbPFer := Len( aVbPFer )

		aVbPFer[nPosVbPFer][VB_VERBA ] :=                  (cAliasQry)->( RV_DESC    )
		aVbPFer[nPosVbPFer][VB_TIPO  ] := aTipoVerba[ Val( (cAliasQry)->( RV_TIPOCOD ) ) ]
		aVbPFer[nPosVbPFer][VB_CC    ] :=                  (cAliasQry)->( CTT_DESC01 )
		aVbPFer[nPosVbPFer][VB_ITEM  ] :=                  (cAliasQry)->( CTD_DESC01 )
		aVbPFer[nPosVbPFer][VB_TOTAL ] :=                  (cAliasQry)->( ZD7_VALOR  )
		aVbPFer[nPosVbPFer][VB_PERCEN] :=                  (cAliasQry)->( ZD7_PERC   )
		aVbPFer[nPosVbPFer][VB_VALOR ] :=                  (cAliasQry)->( ZD7_VALRAT )

      nPosTtPFer := Ascan( aTotPFer, {|x| x[06]+x[07] == (cAliasQry)->( ZD7_CC + ZD7_ITEM ) } )

		If nPosTtPFer == 0

			Aadd( aTotPFer, Array( TT_QTDCOL ) )
	
			nPosTtPFer := Len( aTotPFer )

		EndIf

		aTotPFer[nPosTtPFer][TT_CODCC  ] := (cAliasQry)->( ZD7_CC     )
		aTotPFer[nPosTtPFer][TT_CODITEM] := (cAliasQry)->( ZD7_ITEM   )
		aTotPFer[nPosTtPFer][TT_CC     ] := (cAliasQry)->( CTT_DESC01 )
		aTotPFer[nPosTtPFer][TT_ITEM   ] := (cAliasQry)->( CTD_DESC01 )

      If (cAliasQry)->( RV_TIPOCOD ) == '1'

			nProvPFer                        += (cAliasQry)->( ZD7_VALRAT )

			If aTotPFer[nPosTtPFer][TT_PROV] == Nil
				aTotPFer[nPosTtPFer][TT_PROV] := (cAliasQry)->( ZD7_VALRAT )
			Else
				aTotPFer[nPosTtPFer][TT_PROV] += (cAliasQry)->( ZD7_VALRAT )
			EndIf
      ElseIf (cAliasQry)->( RV_TIPOCOD ) == '2'

			nDescPFer                        += (cAliasQry)->( ZD7_VALRAT )

			If aTotPFer[nPosTtPFer][TT_DESC] == Nil
				aTotPFer[nPosTtPFer][TT_DESC] := (cAliasQry)->( ZD7_VALRAT )
			Else
				aTotPFer[nPosTtPFer][TT_DESC] += (cAliasQry)->( ZD7_VALRAT )
			EndIf

      ElseIf (cAliasQry)->( RV_TIPOCOD ) == '3'

			nBasePFer                        += (cAliasQry)->( ZD7_VALRAT )

			If aTotPFer[nPosTtPFer][TT_BASE] == Nil
				aTotPFer[nPosTtPFer][TT_BASE] := (cAliasQry)->( ZD7_VALRAT )
			Else
				aTotPFer[nPosTtPFer][TT_BASE] += (cAliasQry)->( ZD7_VALRAT )
			EndIf
		EndIf

	Else

		Aadd( aVbFol, Array( VB_QTDCOL ) )

		nPosVbFol := Len( aVbFol )

		aVbFol[nPosVbFol][VB_VERBA ] :=                  (cAliasQry)->( RV_DESC    )
		aVbFol[nPosVbFol][VB_TIPO  ] := aTipoVerba[ Val( (cAliasQry)->( RV_TIPOCOD ) ) ]
		aVbFol[nPosVbFol][VB_CC    ] :=                  (cAliasQry)->( CTT_DESC01 )
		aVbFol[nPosVbFol][VB_ITEM  ] :=                  (cAliasQry)->( CTD_DESC01 )
		aVbFol[nPosVbFol][VB_TOTAL ] :=                  (cAliasQry)->( ZD7_VALOR  )
		aVbFol[nPosVbFol][VB_PERCEN] :=                  (cAliasQry)->( ZD7_PERC   )
		aVbFol[nPosVbFol][VB_VALOR ] :=                  (cAliasQry)->( ZD7_VALRAT )

      nPosTtFol := Ascan( aTotFol, {|x| x[06]+x[07] == (cAliasQry)->( ZD7_CC + ZD7_ITEM ) } )

		If nPosTtFol == 0

			Aadd( aTotFol, Array( TT_QTDCOL ) )
	
			nPosTtFol := Len( aTotFol )

		EndIf

		aTotFol[nPosTtFol][TT_CODCC  ] := (cAliasQry)->( ZD7_CC     )
		aTotFol[nPosTtFol][TT_CODITEM] := (cAliasQry)->( ZD7_ITEM   )
		aTotFol[nPosTtFol][TT_CC     ] := (cAliasQry)->( CTT_DESC01 )
		aTotFol[nPosTtFol][TT_ITEM   ] := (cAliasQry)->( CTD_DESC01 )

      If (cAliasQry)->( RV_TIPOCOD ) == '1'

			nProvFol                       += (cAliasQry)->( ZD7_VALRAT )

			If aTotFol[nPosTtFol][TT_PROV] == Nil
				aTotFol[nPosTtFol][TT_PROV] := (cAliasQry)->( ZD7_VALRAT )
			Else
				aTotFol[nPosTtFol][TT_PROV] += (cAliasQry)->( ZD7_VALRAT )
         EndIf
      ElseIf (cAliasQry)->( RV_TIPOCOD ) == '2'

			nDescFol                       += (cAliasQry)->( ZD7_VALRAT )
			If aTotFol[nPosTtFol][TT_DESC] == Nil
				aTotFol[nPosTtFol][TT_DESC] := (cAliasQry)->( ZD7_VALRAT )
			Else
				aTotFol[nPosTtFol][TT_DESC] += (cAliasQry)->( ZD7_VALRAT )
         EndIf
      ElseIf (cAliasQry)->( RV_TIPOCOD ) == '3'

			nBaseFol                       += (cAliasQry)->( ZD7_VALRAT )

			If aTotFol[nPosTtFol][TT_BASE] == Nil
				aTotFol[nPosTtFol][TT_BASE] := (cAliasQry)->( ZD7_VALRAT )
			Else
				aTotFol[nPosTtFol][TT_BASE] += (cAliasQry)->( ZD7_VALRAT )
         EndIf
		EndIf

	EndIf
	
	(cAliasQry)->(dbSkip())
End

If Len( aVbFol   ) == 0; Aadd( aVbFol,   Array( VB_QTDCOL ) ); EndIf
If Len( aVbP13   ) == 0; Aadd( aVbP13,   Array( VB_QTDCOL ) ); EndIf
If Len( aVbPFer  ) == 0; Aadd( aVbPFer,  Array( VB_QTDCOL ) ); EndIf

If Len( aTotFol  ) == 0; Aadd( aTotFol,  Array( TT_QTDCOL ) ); EndIf
If Len( aTotP13  ) == 0; Aadd( aTotP13,  Array( TT_QTDCOL ) ); EndIf
If Len( aTotPFer ) == 0; Aadd( aTotPFer, Array( TT_QTDCOL ) ); EndIf

(cAliasQry)->(dbCloseArea())

RestArea(aAreaAtu)

Return NIL

/*/f/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
<Descricao> : Rotina para controle de versao
<Data> : 24/05/2014
<Parametros> : Nenhum
<Retorno> : cRet
<Processo> : Controle de versao
<Tipo> (Menu,Trigger,Validacao,Ponto de Entrada,Genericas,Especificas ) : V
<Autor> : Doit Sistemas
<Obs> :
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
*/

User Function DTGPE03V()

Local cRet := ""
cRet := "20140523"
 
Return cRet