#include "protheus.ch"

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³MT103AFN  ºAutor  ³Microsiga           º Data ³  02/09/11   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ PE para manipular codigo do ativo                          º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ MP 11 - SISTEMA INDUSTRIA                                  º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

User Function MT103AFN()
Local _cArea   	:= GetArea()
Local _aRet     := {}
Local _cAreaSX6 := SX6->(GetArea())

// Busca último código utilizado
//_cBase := &(SuperGetMv("MV_CBASEAF",.F.,,LEFT(CFILANT,4)))
// Obtem valor do Parametro
dbSelectArea("SX6")
dbSetOrder(1)
IF dbSeek(LEFT(CFILANT,4)+Space(4)+"MV_CBASEAF")
	_cBase := &(SX6->X6_CONTEUD)
Endif

// Inserido por Carlos Queiroz em 06/06/13
// Monta consulta para verificar se o codigo informado ja existe na base
U_MT103QrySn1(_cBase)

// Se o codigo existir, busca o maior codigo da base para ser utilizado.
dbselectarea("TRBSN1")
//If TRBSN1->(!EOF())
//	_cBase := MT103MaxSn1()
//EndIf
While TRBSN1->(!EOF())
	_cBase := Soma1(Alltrim(_cBase))
	U_MT103QrySn1(_cBase)
EndDo

If Select("TRBSN1") > 0
	TRBSN1->(dbclosearea())
EndIf

Aadd(_aRet,Padr(_cBase,TamSX3("N1_CBASE")[1]))
Aadd(_aRet,StrZero(1,TamSX3("N1_ITEM")[1]))

// Atualiza parametro
dbSelectArea("SX6")
dbSetOrder(1)
IF dbSeek(LEFT(CFILANT,4)+Space(4)+"MV_CBASEAF")
	
	RecLock("SX6",.F.)
	FieldPut( FieldPos('X6_CONTEUD'), '"'+Soma1(Alltrim(_cBase))+'"' )
	FieldPut( FieldPos('X6_CONTSPA'), '"'+Soma1(Alltrim(_cBase))+'"' )
	FieldPut( FieldPos('X6_CONTENG'), '"'+Soma1(Alltrim(_cBase))+'"' )
	SX6->(MsUnLock())
ENDIF

RestArea(_cAreaSX6)
RestArea(_cArea)
Return(_aRet)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³MT103QrySn1º Autor ³ Carlos A. Queiroz  º Data ³  06/06/13   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Monta consulta para verificar se o codigo informado         º±±
±±º          ³ ja existe na base.                                          º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ CNI - Fiergs                                                º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

User Function MT103QrySn1(_cBase,_cItem)
Local   cQuery	:= ""
Default _cBase	:= ""
Default _cItem	:= StrZero(Val('1'),TamSX3("N1_ITEM")[1])

If Select("TRBSN1") > 0
	TRBSN1->(dbclosearea())
EndIf

cQuery := " SELECT SN1.N1_FILIAL, SN1.N1_CBASE, SN1.N1_ITEM "
cQuery += " FROM "+RetSqlName("SN1")+" SN1 "
cQuery += "	WHERE SubString(SN1.N1_FILIAL,1,4) = '"+substr(cFilAnt,1,4)+"' "
cQuery += "	AND SN1.N1_CBASE = '"+_cBase+"'"
cQuery += "	AND SN1.N1_ITEM  = '"+_cItem+"'"
cQuery += "	AND SN1.D_E_L_E_T_ <> '*' "
cQuery += "	ORDER BY SN1.N1_FILIAL "

cQuery := ChangeQuery(cQuery)

dbUseArea( .T., "TOPCONN", TCGENQRY(,,cQuery),"TRBSN1", .F., .T.)

Return


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³MT103MaxSn1º Autor ³ Carlos A. Queiroz  º Data ³  06/06/13   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Monta consulta para busca o maior codigo da base            º±±
±±º          ³ para ser utilizado.                                         º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ CNI - Fiergs                                                º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
/*Static Function MT103MaxSn1()
Local cQuery := ""
Local cBase  := ""

cQuery := " SELECT Max(SN1.N1_CBASE) CBASE "
cQuery += " FROM "+RetSqlName("SN1")+" SN1 "
cQuery += "	WHERE SubString(SN1.N1_FILIAL,1,4) = '"+substr(cFilAnt,1,4)+"' "
cQuery += "	AND SN1.D_E_L_E_T_ <> '*' "

cQuery := ChangeQuery(cQuery)

dbUseArea( .T., "TOPCONN", TCGENQRY(,,cQuery),"MAXSN1", .F., .T.)

dbselectarea("MAXSN1")

If MAXSN1->(!EOF())
cBase := Soma1(MAXSN1->CBASE)
EndIf

If Select("MAXSN1") > 0
MAXSN1->(dbclosearea())
EndIf

Return cBase
*/