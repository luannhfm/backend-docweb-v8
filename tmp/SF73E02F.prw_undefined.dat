#include "Protheus.ch"

/*/{Protheus.doc} User Function SF73E02F
    Função para validar o modo de edição do campo ADZ_DESCON.
    @type Function
    @author Franklin de Brito de Oliveira
    @since 22/10/2021
    @return logic, indica se o campo ADZ_DESCON pode ou não ser editado.
    /*/
User Function SF73E02F()
    local lCanEdit := .T.

    Do Case
    Case "01MT" $ xFilial("ADZ")
        
    Case "02MT" $ xFilial("ADZ")
        if lCanEdit
            lCanEdit := fVldPerUsr()
        endif
    Case "03MT" $ xFilial("ADZ")
        if lCanEdit
            lCanEdit := fVldPerUsr()
        endif
    Case "04MT" $ xFilial("ADZ")
    EndCase

Return lCanEdit

/*/{Protheus.doc} fVldPerUsr
    Valida se o usuário que está editando a proposta pode editar o campo ADZ_DESCON.
    @type Function
    @author Franklin de Brito de Oliveira
    @since 22/10/2021
    @return logic, indica se o usuário tem permissão para editar o campo.
    /*/
Static Function fVldPerUsr()
    local lUsrCanEdit := .F.
    local cUsrDSMax	:= SuperGetMv("MV_XUSDESC", , "")
    local cUsrRespUnid := fGetUsrRespUnidade()

    if RetCodUsr() $ cUsrDSMax
        lUsrCanEdit := .T.
    elseif RetCodUsr() $ cUsrRespUnid
        lUsrCanEdit := .T.
    endif

Return lUsrCanEdit

/*/{Protheus.doc} fGetUsrRespUnidade
    Recupera uma lista de usuários classificados como responsável por unidades operacionais, 
    conforme o cadastro de Dados complementares da filial - tabela ZCO.
    @type Function
    @author Franklin de Brito de Oliveira
    @since 22/10/2021
    @return character, Código de usuários, separado por ;, que são responsáveis por unidade.
    /*/
Static Function fGetUsrRespUnidade()
    cUsrRespUnid := ""
    
    dbSelectArea("ZCO")
    dbSetOrder(1)   //ZCO_FILIAL+ZCO_NOMREP
    while !ZCO->(EOF())
        if !Empty(ZCO->ZCO_USRREP)
            cUsrRespUnid += ZCO->ZCO_USRREP + ';'
        endif
        ZCO->(dbSkip())
    end
    ZCO->(dbCloseArea())

Return cUsrRespUnid
